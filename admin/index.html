<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Studio Booking</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Microsoft JhengHei', 'Segoe UI', Roboto, sans-serif; background: #EDEDE9; min-height: 100vh; padding: 24px; color: #1f2933; }
        a { color: #145da0; }
        .admin-container { max-width: 1280px; margin: 0 auto; display: block; }
        .admin-header { background: #fff; border-radius: 18px; padding: 28px; margin-bottom: 24px; box-shadow: 0 24px 50px rgba(0,0,0,0.12); position: relative; }
        .logout-btn { position: absolute; top: 24px; right: 24px; padding: 10px 18px; background: #f2545b; color: #fff; border: none; border-radius: 10px; cursor: pointer; transition: opacity 0.2s; }
        .logout-btn:hover { opacity: 0.8; }
        .tabs { display: flex; gap: 12px; margin-bottom: 24px; border-bottom: 2px solid #d6dde6; flex-wrap: wrap; }
        .tab-btn { padding: 10px 18px; background: transparent; border: none; color: #52606d; font-size: 1em; font-weight: 600; cursor: pointer; border-bottom: 3px solid transparent; }
        .tab-btn.active { color: #0b4f6c; border-bottom-color: #145da0; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .section-card { background: #fff; border-radius: 18px; padding: 24px; margin-bottom: 24px; box-shadow: 0 16px 40px rgba(0,0,0,0.08); }
        .section-card h3 { color: #145da0; margin-bottom: 18px; font-size: 1.4em; }
        .form-grid { display: grid; gap: 18px; }
        @media (min-width: 860px) { .form-grid.two-columns { grid-template-columns: repeat(2, minmax(0,1fr)); } }
        .input-group label { display: block; margin-bottom: 6px; font-weight: 600; color: #364152; }
        .input-group input, .input-group textarea, .input-group select { width: 100%; padding: 12px; border: 2px solid #d6dde6; border-radius: 12px; font-size: 1em; background: #fdfdfd; color: #1f2933; }
        .input-group textarea { resize: vertical; min-height: 60px; }
        .input-group input:focus, .input-group textarea:focus, .input-group select:focus { border-color: #145da0; outline: none; box-shadow: 0 0 0 4px rgba(20,93,160,0.12); }
        .btn { padding: 12px 18px; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; letter-spacing: 0.3px; }
        .btn-primary { background: linear-gradient(135deg,#0b4f6c 0%,#145da0 100%); color: #fff; }
        .btn-secondary { background: #e4ebf5; color: #1f2933; }
        .btn-danger { background: #f2545b; color: #fff; }
        .btn + .btn { margin-left: 10px; }
        .status-chip { display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 20px; font-size: 0.85em; font-weight: 600; text-transform: uppercase; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-confirmed { background: #d4edda; color: #155724; }
        .status-cancelled { background: #f8d7da; color: #721c24; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 14px; border-bottom: 1px solid #e4ebf5; text-align: left; vertical-align: top; }
        th { background: #f0f4fa; color: #145da0; font-weight: 600; }
        .message { padding: 12px 16px; border-radius: 12px; margin-bottom: 16px; display: none; }
        .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .item-list { display: grid; gap: 16px; }
        @media (min-width: 900px) { .item-list { grid-template-columns: repeat(2, minmax(0,1fr)); } }
        .item-card { border: 1px solid #dce3ef; border-radius: 16px; padding: 18px; background: #f8faff; display: flex; flex-direction: column; gap: 8px; }
        .item-card h4 { color: #0b4f6c; font-size: 1.1em; }
        .item-card small { color: #516273; }
        .item-actions { margin-top: 12px; display: flex; gap: 8px; }
        .stat-grid { display: grid; gap: 16px; margin-bottom: 16px; }
        @media (min-width: 720px) { .stat-grid { grid-template-columns: repeat(3, minmax(0,1fr)); } }
        .stat-card { background: linear-gradient(135deg,#4facfe 0%,#00f2fe 100%); color: #fff; padding: 18px; border-radius: 14px; box-shadow: 0 12px 30px rgba(79,172,254,0.35); }
        .stat-card h4 { font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.6px; margin-bottom: 6px; }
        .stat-card p { font-size: 1.8em; font-weight: 700; }
        .overview-grid { display: grid; gap: 18px; margin-top: 18px; }
        @media (min-width: 900px) { .overview-grid { grid-template-columns: repeat(2, minmax(0,1fr)); } }
        .overview-list { display: flex; flex-direction: column; gap: 12px; }
        .overview-card { background: #fff; border: 1px solid #dce3ef; border-radius: 14px; padding: 16px; box-shadow: 0 8px 18px rgba(0,0,0,0.05); }
        .overview-card h4 { color: #0b4f6c; margin-bottom: 6px; }
        .overview-meta { color: #52606d; font-size: 0.9em; line-height: 1.6; }
        .overview-attendees { margin-top: 10px; padding-left: 16px; color: #52606d; font-size: 0.88em; }
        .overview-empty { padding: 14px; border: 1px dashed #d6dde6; border-radius: 12px; color: #52606d; background: #f8faff; font-size: 0.9em; }
    </style>
</head>
<body>
    <div id="adminContainer" class="admin-container">
        <div class="admin-header">
            <h1 style="color:#0b4f6c; font-size:2.2em;">Studio Booking 管理面板</h1>
            <p style="color:#52606d;">快速管理預約、設定、課程與場地資訊。</p>
            <p id="adminIdentity" style="color:#52606d; font-size:0.95em; margin-top:6px; display:none;"></p>
            <div id="apiStatusMessage" class="message" style="margin-top:12px;"></div>
            <button class="logout-btn" onclick="logout()">登出</button>
            <div class="stat-grid">
                <div class="stat-card" id="stat-total"><h4>總預約數</h4><p>0</p></div>
                <div class="stat-card" style="background:linear-gradient(135deg,#43e97b 0%,#38f9d7 100%);" id="stat-confirmed"><h4>已確認</h4><p>0</p></div>
                <div class="stat-card" style="background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);" id="stat-pending"><h4>待處理</h4><p>0</p></div>
            </div>
        </div>
        <div class="tabs">
            <button class="tab-btn active" data-tab="bookingsTab">預約列表</button>
            <button class="tab-btn" data-tab="overviewTab">預約概覽</button>
            <button class="tab-btn" data-tab="settingsTab">設定</button>
            <button class="tab-btn" data-tab="instructionsTab">預約須知</button>
            <button class="tab-btn" data-tab="itemsTab">課程 / 場地項目</button>
        </div>
        <div id="bookingsTab" class="tab-content active">
            <div class="section-card">
                <h3>場地預約</h3>
                <div id="bookingsMessage" class="message"></div>
                <div style="overflow-x:auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>預約編號</th>
                                <th>客戶 / 聯絡</th>
                                <th>項目</th>
                                <th>總人數</th>
                                <th>總金額</th>
                                <th>狀態</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="bookingsTable"></tbody>
                    </table>
                </div>
            </div>
            <div class="section-card">
                <h3>課程預約</h3>
                <div id="classBookingsMessage" class="message"></div>
                <div style="overflow-x:auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>預約編號</th>
                                <th>課程資訊</th>
                                <th>客戶 / 聯絡</th>
                                <th>人數</th>
                                <th>狀態</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="classBookingsTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div id="overviewTab" class="tab-content">
            <div class="section-card">
                <h3>預約概覽</h3>
                <div class="form-grid two-columns">
                    <div class="input-group">
                        <label>選擇日期</label>
                        <input type="date" id="overviewDate">
                    </div>
                    <div class="input-group" style="display:flex;align-items:flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="refreshOverview()">重新整理</button>
                    </div>
                </div>
                <div id="overviewMessage" class="message"></div>
                <div class="overview-grid">
                    <div class="overview-column">
                        <h4 style="color:#145da0;">場地預約</h4>
                        <div id="overviewStudioList" class="overview-list"></div>
                    </div>
                    <div class="overview-column">
                        <h4 style="color:#145da0;">課程預約</h4>
                        <div id="overviewClassList" class="overview-list"></div>
                    </div>
                </div>
            </div>
        </div>
        <div id="settingsTab" class="tab-content">
            <div id="settingsMessage" class="message"></div>
            <div class="section-card">
                <h3>管理密碼</h3>
                <div id="passwordMessage" class="message"></div>
                <form id="passwordForm" class="form-grid">
                    <div class="input-group">
                        <label>目前密碼</label>
                        <input type="password" id="currentAdminPassword" required>
                    </div>
                    <div class="input-group">
                        <label>新密碼</label>
                        <input type="password" id="newAdminPassword" required>
                    </div>
                    <div class="input-group">
                        <label>確認新密碼</label>
                        <input type="password" id="confirmAdminPassword" required>
                    </div>
                    <div>
                        <button type="submit" class="btn btn-primary">更新密碼</button>
                    </div>
                </form>
            </div>
            <div class="section-card">
                <h3>基本資料</h3>
                <div class="form-grid two-columns">
                    <div class="input-group"><label>英文名稱</label><input id="businessName" type="text"></div>
                    <div class="input-group"><label>中文名稱</label><input id="businessNameZh" type="text"></div>
                    <div class="input-group"><label>營業時間開始</label><input id="startTime" type="time"></div>
                    <div class="input-group"><label>營業時間結束</label><input id="endTime" type="time"></div>
                    <div class="input-group"><label>營業資訊 (中文)</label><input id="daysLabelZh" type="text" placeholder="每日營業"></div>
                    <div class="input-group"><label>營業資訊 (英文)</label><input id="daysLabelEn" type="text" placeholder="Open Daily"></div>
                </div>
                <div class="form-grid two-columns" style="margin-top:18px;">
                    <div class="input-group"><label>英文介紹</label><textarea id="businessDescription" rows="3"></textarea></div>
                    <div class="input-group"><label>中文介紹</label><textarea id="businessDescriptionZh" rows="3"></textarea></div>
                </div>
            </div>
            <div class="section-card">
                <h3>聯絡資訊</h3>
                <div class="form-grid two-columns">
                    <div class="input-group"><label>WhatsApp</label><input id="contactWhatsapp" type="text"></div>
                    <div class="input-group"><label>電話</label><input id="contactPhone" type="text"></div>
                    <div class="input-group"><label>Email</label><input id="contactEmail" type="email"></div>
                </div>
            </div>
            <div class="section-card">
                <h3>付款方式</h3>
                <div class="form-grid two-columns">
                    <div class="input-group"><label>銀行轉帳啟用</label><select id="paymentBankEnabled"><option value="true">啟用</option><option value="false">停用</option></select></div>
                    <div class="input-group"><label>PayMe 啟用</label><select id="paymentPaymeEnabled"><option value="true">啟用</option><option value="false">停用</option></select></div>
                    <div class="input-group"><label>銀行名稱</label><input id="paymentBankName" type="text"></div>
                    <div class="input-group"><label>銀行戶口號碼</label><input id="paymentBankAccount" type="text"></div>
                    <div class="input-group"><label>戶口名稱</label><input id="paymentBankAccountName" type="text"></div>
                    <div class="input-group"><label>PayMe 顯示名稱</label><input id="paymentPaymeDisplayName" type="text"></div>
                    <div class="input-group"><label>PayMe 電話</label><input id="paymentPaymePhone" type="text"></div>
                    <div class="input-group"><label>FPS 啟用</label><select id="paymentFpsEnabled"><option value="true">啟用</option><option value="false">停用</option></select></div>
                    <div class="input-group"><label>FPS 號碼</label><input id="paymentFpsNumber" type="text"></div>
                    <div class="input-group"><label>FPS 顯示名稱</label><input id="paymentFpsDisplayName" type="text" placeholder="例如 FPS 轉數快"></div>
                </div>
            </div>
            <div class="section-card">
                <h3>預約規則</h3>
                <div class="form-grid two-columns">
                    <div class="input-group"><label>最少提前天數</label><input id="bookingMinAdvance" type="number" min="0"></div>
                    <div class="input-group"><label>最多提前天數</label><input id="bookingMaxAdvance" type="number" min="0"></div>
                    <div class="input-group"><label>時段間隔 (分鐘)</label><input id="bookingSlotInterval" type="number" min="5" step="5"></div>
                    <div class="input-group"><label>自動確認預約</label><select id="bookingAutoConfirm"><option value="true">是</option><option value="false">否</option></select></div>
                    <div class="input-group"><label>需要付款證明</label><select id="bookingRequirePaymentProof"><option value="true">是</option><option value="false">否</option></select></div>
                </div>
            </div>
            <div class="section-card">
                <h3>價格設定</h3>
                <div class="form-grid two-columns">
                    <div class="input-group"><label>一般時段 (≤10人)</label><input id="normalUpTo10" type="number" min="0"></div>
                    <div class="input-group"><label>一般時段 (11-18人)</label><input id="normalUpTo18" type="number" min="0"></div>
                    <div class="input-group"><label>高峰時段 (≤10人)</label><input id="peakUpTo10" type="number" min="0"></div>
                    <div class="input-group"><label>高峰時段 (11-18人)</label><input id="peakUpTo18" type="number" min="0"></div>
                    <div class="input-group"><label>高峰時段適用星期 (以逗號分隔，例如 fri,sat,sun)</label><input id="peakDays" type="text"></div>
                    <div class="input-group"><label>高峰開始時間</label><input id="peakStart" type="time"></div>
                    <div class="input-group"><label>高峰結束時間</label><input id="peakEnd" type="time"></div>
                </div>
            </div>
            <div style="margin:18px 0 24px;">
                <button class="btn btn-primary" type="button" onclick="saveSettings()">儲存設定</button>
            </div>
        </div>
        <div id="instructionsTab" class="tab-content">
            <div id="instructionsMessage" class="message"></div>
            <div class="section-card">
                <h3>預約須知內容</h3>
                <div class="form-grid two-columns">
                    <div class="input-group"><label>標題 (中文)</label><input id="titleZh" type="text"></div>
                    <div class="input-group"><label>標題 (英文)</label><input id="titleEn" type="text"></div>
                </div>
                <div class="form-grid two-columns" style="margin-top:18px;">
                    <div class="input-group"><label>步驟 1 (中文)</label><textarea id="instruction1Zh"></textarea></div>
                    <div class="input-group"><label>步驟 1 (英文)</label><textarea id="instruction1En"></textarea></div>
                    <div class="input-group"><label>步驟 2 (中文)</label><textarea id="instruction2Zh"></textarea></div>
                    <div class="input-group"><label>步驟 2 (英文)</label><textarea id="instruction2En"></textarea></div>
                    <div class="input-group"><label>步驟 3 (中文)</label><textarea id="instruction3Zh"></textarea></div>
                    <div class="input-group"><label>步驟 3 (英文)</label><textarea id="instruction3En"></textarea></div>
                    <div class="input-group"><label>步驟 4 (中文)</label><textarea id="instruction4Zh"></textarea></div>
                    <div class="input-group"><label>步驟 4 (英文)</label><textarea id="instruction4En"></textarea></div>
                    <div class="input-group"><label>步驟 5 (中文)</label><textarea id="instruction5Zh"></textarea></div>
                    <div class="input-group"><label>步驟 5 (英文)</label><textarea id="instruction5En"></textarea></div>
                    <div class="input-group"><label>步驟 6 (中文)</label><textarea id="instruction6Zh"></textarea></div>
                    <div class="input-group"><label>步驟 6 (英文)</label><textarea id="instruction6En"></textarea></div>
                </div>
                <div style="margin-top:18px;"><button class="btn btn-primary" onclick="saveInstructions()">儲存須知</button></div>
            </div>
        </div>
        <div id="itemsTab" class="tab-content">
            <div class="section-card">
                <h3>課程排程</h3>
                <div id="classesMessage" class="message"></div>
                <form id="classForm">
                    <input type="hidden" id="classId">
                    <div class="form-grid two-columns">
                        <div class="input-group"><label>課程名稱</label><input id="className" type="text" required></div>
                        <div class="input-group"><label>導師</label><input id="classInstructor" type="text"></div>
                        <div class="input-group"><label>地點</label><input id="classLocation" type="text"></div>
                        <div class="input-group"><label>開始時間</label><input id="classStart" type="datetime-local" required></div>
                        <div class="input-group"><label>結束時間</label><input id="classEnd" type="datetime-local" required></div>
                        <div class="input-group"><label>價格 (每人)</label><input id="classPrice" type="number" min="0" step="1" required></div>
                        <div class="input-group"><label>兩人同行優惠價 (選填)</label><input id="classSpecialPriceForTwo" type="number" min="0" step="1" placeholder="填寫兩人合計價"></div>
                        <div class="input-group"><label>人數上限</label><input id="classCapacity" type="number" min="1" required></div>
                        <div class="input-group"><label>是否為體驗限定</label><select id="classIsTrialOnly"><option value="false">否</option><option value="true">是</option></select></div>
                        <div class="input-group"><label>標籤 (逗號分隔)</label><input id="classTags" type="text" placeholder="例如 beginner,evening"></div>
                    </div>
                    <div class="form-grid" style="margin-top:18px;">
                        <div class="input-group"><label>課程介紹</label><textarea id="classDescription"></textarea></div>
                    </div>
                    <div style="margin-top:18px;">
                        <button type="submit" class="btn btn-primary">儲存課程</button>
                        <button type="button" class="btn btn-secondary" onclick="resetClassForm()">清除</button>
                    </div>
                </form>
                <h4 style="margin-top:24px;color:#145da0;">現有課程</h4>
                <div id="classesList" class="item-list"></div>
            </div>
            <div class="section-card">
                <h3>課程方案 / 體驗方案</h3>
                <div id="classProductsMessage" class="message"></div>
                <form id="classProductForm">
                    <input type="hidden" id="classProductId">
                    <div class="form-grid two-columns">
                        <div class="input-group"><label>類型</label><select id="classProductType"><option value="package">課程方案</option><option value="trial">體驗方案</option></select></div>
                        <div class="input-group"><label>名稱</label><input id="classProductName" type="text" required></div>
                        <div class="input-group"><label>價格</label><input id="classProductPrice" type="number" min="0" step="1" required></div>
                        <div class="input-group"><label>堂數</label><input id="classProductCount" type="number" min="1" required></div>
                        <div class="input-group"><label>有效期 (天)</label><input id="classProductValidity" type="number" min="1"></div>
                    </div>
                    <div class="form-grid" style="margin-top:18px;">
                        <div class="input-group"><label>方案介紹</label><textarea id="classProductDescription"></textarea></div>
                    </div>
                    <div style="margin-top:18px;">
                        <button type="submit" class="btn btn-primary">儲存方案</button>
                        <button type="button" class="btn btn-secondary" onclick="resetClassProductForm()">清除</button>
                    </div>
                </form>
                <h4 style="margin-top:24px;color:#145da0;">現有方案</h4>
                <div id="classProductsList" class="item-list"></div>
            </div>
            <div class="section-card">
                <h3>場地租用項目</h3>
                <div id="rentalItemsMessage" class="message"></div>
                <form id="rentalItemForm">
                    <input type="hidden" id="rentalItemId">
                    <div class="form-grid two-columns">
                        <div class="input-group"><label>名稱</label><input id="rentalItemName" type="text" required></div>
                        <div class="input-group"><label>開始時間</label><input id="rentalItemStart" type="datetime-local" required></div>
                        <div class="input-group"><label>結束時間</label><input id="rentalItemEnd" type="datetime-local" required></div>
                        <div class="input-group"><label>時長 (分鐘)</label><input id="rentalItemDuration" type="number" min="1" required></div>
                        <div class="input-group"><label>價錢 (每位或每節)</label><input id="rentalItemPrice" type="number" min="0" step="1" required></div>
                        <div class="input-group"><label>導師名稱 / 工作人員</label><input id="rentalItemInstructor" type="text"></div>
                        <div class="input-group"><label>人數上限</label><input id="rentalItemCapacity" type="number" min="1" required></div>
                    </div>
                    <div style="margin-top:18px;">
                        <button type="submit" class="btn btn-primary">儲存場地項目</button>
                        <button type="button" class="btn btn-secondary" onclick="resetRentalItemForm()">清除</button>
                    </div>
                </form>
                <h4 style="margin-top:24px;color:#145da0;">現有場地項目</h4>
                <div id="rentalItemsList" class="item-list"></div>
            </div>
        </div>
    </div>
    <script>
        function resolveApiBaseUrl(storageKey) {
            const DEFAULT_API_PATH = '/api';
            const RENDER_API_ORIGIN = 'https://booking-ub69.onrender.com';
            const fallbackOrigin = RENDER_API_ORIGIN;
            const baseOrigin = (window.location.origin && window.location.origin !== 'null')
                ? window.location.origin
                : fallbackOrigin;

            const normalizeBaseUrl = (value) => {
                if (!value) return null;
                try {
                    const url = new URL(value, baseOrigin);
                    const normalizedPath = url.pathname.replace(/\/+$/, '');
                    return normalizedPath ? `${url.origin}${normalizedPath}` : url.origin;
                } catch (error) {
                    console.warn('Invalid API base URL provided:', value, error);
                    return null;
                }
            };

            const params = new URLSearchParams(window.location.search);
            const queryOverride = params.get('apiBaseUrl') || params.get('api_base_url');
            if (queryOverride) {
                const resolved = normalizeBaseUrl(queryOverride);
                if (resolved) {
                    try {
                        localStorage.setItem(storageKey, resolved);
                    } catch (error) {
                        console.warn('Unable to persist API base URL override:', error);
                    }
                    return resolved;
                }
            }

            try {
                const stored = normalizeBaseUrl(localStorage.getItem(storageKey));
                if (stored) {
                    return stored;
                }
            } catch (error) {
                console.warn('Unable to read stored API base URL override:', error);
            }

            const appendApiPath = (origin) => `${origin.replace(/\/+$/, '')}${DEFAULT_API_PATH}`;
            const normalizedRenderOrigin = normalizeBaseUrl(RENDER_API_ORIGIN) || fallbackOrigin;
            const normalizedCurrentOrigin = normalizeBaseUrl(baseOrigin);

            if (normalizedCurrentOrigin && normalizedCurrentOrigin === normalizedRenderOrigin) {
                return appendApiPath(normalizedCurrentOrigin);
            }

            const isLocalhost = normalizedCurrentOrigin
                ? /^https?:\/\/(localhost|127\.0\.0\.1|0\.0\.0\.0)(:\\d+)?$/i.test(normalizedCurrentOrigin)
                : false;

            if (isLocalhost && normalizedCurrentOrigin) {
                return appendApiPath(normalizedCurrentOrigin);
            }

            return appendApiPath(normalizedRenderOrigin);
        }

        const API_BASE_URL = resolveApiBaseUrl('admin.apiBaseUrl');
        console.log('Using API_BASE_URL:', API_BASE_URL);

        const DEV_AUTH_DISABLED = true; // Toggle to false to restore admin authentication
        function isAuthDisabled() { return DEV_AUTH_DISABLED; }

        const LOGIN_ERROR_DEFAULT = '登入失敗，請檢查管理密碼。';
        let refreshIntervalId = null;
        let currentSettings = {};
        let currentRentalItems = [];
        let currentClasses = [];
        let currentClassProducts = [];

        async function checkApiHealth() {
            const statusEl = document.getElementById('apiStatusMessage');
            if (!statusEl) return;
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                statusEl.className = 'message success';
                statusEl.textContent = '已連線至後端 API。';
                statusEl.style.display = 'block';
                console.log('Connected to backend API');
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 4000);
            } catch (error) {
                console.error('API health check failed:', error);
                statusEl.className = 'message error';
                statusEl.textContent = '後端 API 無法連線，請檢查 API_BASE_URL 設定或 Render 服務是否正常。';
                statusEl.style.display = 'block';
            }
        }

        function updateAdminIdentity(isLoggedIn) {
            const el = document.getElementById('adminIdentity');
            if (!el) return;
            if (isLoggedIn) {
                el.textContent = isAuthDisabled()
                    ? '開發模式：已停用管理員驗證'
                    : '已使用共享管理密碼登入';
                el.style.display = 'block';
            } else {
                el.textContent = '';
                el.style.display = 'none';
            }
        }

        const HTML_ESCAPES = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#39;'
        };

        function escapeHtml(value) {
            if (value === null || value === undefined) return '';
            return value.toString().replace(/[&<>"']/g, (match) => HTML_ESCAPES[match] || match);
        }

        function setOverviewDateToToday() {
            const input = document.getElementById('overviewDate');
            if (!input || input.value) return;
            input.value = new Date().toISOString().split('T')[0];
        }

        function formatOverviewDateTime(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            if (Number.isNaN(date.getTime())) return '';
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            const hh = String(date.getHours()).padStart(2, '0');
            const mm = String(date.getMinutes()).padStart(2, '0');
            return `${y}-${m}-${d} ${hh}:${mm}`;
        }

        function formatOverviewTime(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            if (Number.isNaN(date.getTime())) return '';
            const hh = String(date.getHours()).padStart(2, '0');
            const mm = String(date.getMinutes()).padStart(2, '0');
            return `${hh}:${mm}`;
        }

        async function loadBookingOverview(date) {
            const targetDate = date || document.getElementById('overviewDate')?.value;
            if (!targetDate) return;
            try {
                const response = await fetch(`${API_BASE_URL}/admin/bookings/overview?date=${targetDate}`, { headers: authHeaders() });
                if (response.status === 401) return logout();
                const result = await response.json();
                if (response.ok) {
                    renderBookingOverview(result);
                } else {
                    showOverviewMessage('error', result.error || '無法載入概覽。');
                }
            } catch (error) {
                console.error('Error loading booking overview:', error);
                showOverviewMessage('error', '無法載入概覽，請稍後再試。');
            }
        }

        function renderBookingOverview(data) {
            const studioList = document.getElementById('overviewStudioList');
            const classList = document.getElementById('overviewClassList');
            const messageEl = document.getElementById('overviewMessage');
            if (messageEl) { messageEl.style.display = 'none'; }
            if (!studioList || !classList) return;
            studioList.innerHTML = '';
            classList.innerHTML = '';

            const studioSessions = Array.isArray(data.studioSessions) ? data.studioSessions : [];
            if (studioSessions.length === 0) {
                studioList.innerHTML = '<div class="overview-empty">當日暫無場地預約。</div>';
            } else {
                studioSessions.forEach(session => {
                    const card = document.createElement('div');
                    card.className = 'overview-card';
                    const timeLabel = `${session.startTime || ''} - ${session.endTime || ''}`.trim();
                    const notesRow = session.notes ? `<div>備註：${escapeHtml(session.notes)}</div>` : '';
                    card.innerHTML = `
                        <h4>${escapeHtml(timeLabel)}</h4>
                        <div class="overview-meta">
                            <div>預約編號：${escapeHtml(session.bookingId)}</div>
                            <div>${escapeHtml(session.customerName || '—')}｜${escapeHtml(String(session.peopleCount || 0))} 人</div>
                            <div>狀態：${escapeHtml(session.status || '')}</div>
                            <div>${escapeHtml(session.email || '')}<br>${escapeHtml(session.phone || '')}</div>
                            ${notesRow}
                        </div>
                    `;
                    studioList.appendChild(card);
                });
            }

            const classSessions = Array.isArray(data.classSessions) ? data.classSessions : [];
            if (classSessions.length === 0) {
                classList.innerHTML = '<div class="overview-empty">當日暫無課程預約。</div>';
            } else {
                classSessions.forEach(cls => {
                    const card = document.createElement('div');
                    card.className = 'overview-card';
                    const startLabel = formatOverviewDateTime(cls.startDateTime);
                    const endLabel = formatOverviewTime(cls.endDateTime);
                    const scheduleLabel = endLabel ? `${startLabel} - ${endLabel}` : startLabel;
                    const descriptionRow = cls.description ? `<div style="margin-top:6px;">${escapeHtml(cls.description)}</div>` : '';
                    const attendees = Array.isArray(cls.attendees) ? cls.attendees : [];
                    const attendeesRows = attendees.map(att => {
                        return `<div>• ${escapeHtml(att.customerName || '—')}｜${escapeHtml(String(att.peopleCount || 0))} 人｜${escapeHtml(att.status || '')}</div>`;
                    }).join('');
                    const attendeesHtml = attendees.length === 0
                        ? '<div class="overview-empty" style="margin-top:10px;">尚未有參加者。</div>'
                        : `<div class="overview-attendees">${attendeesRows}</div>`;
                    card.innerHTML = `
                        <h4>${escapeHtml(cls.name)}</h4>
                        <div class="overview-meta">
                            <div>${escapeHtml(scheduleLabel)}</div>
                            ${cls.instructorName ? `<div>導師：${escapeHtml(cls.instructorName)}</div>` : ''}
                        </div>
                        <div class="overview-meta" style="margin-top:6px;">
                            <div>報名：${escapeHtml(String(cls.totalParticipants || 0))} / ${escapeHtml(String(cls.capacity || 0))}（剩餘 ${escapeHtml(String(cls.seatsRemaining || 0))}）</div>
                            ${descriptionRow}
                        </div>
                        ${attendeesHtml}
                    `;
                    classList.appendChild(card);
                });
            }
        }

        function refreshOverview() {
            const date = document.getElementById('overviewDate')?.value;
            loadBookingOverview(date);
        }

        function showOverviewMessage(type, message) {
            showMessage('overviewMessage', type, message);
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await checkApiHealth();
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }

            document.querySelectorAll('.tab-btn').forEach(btn => btn.addEventListener('click', handleTabClick));
            const classForm = document.getElementById('classForm');
            if (classForm) classForm.addEventListener('submit', submitClassForm);
            const classProductForm = document.getElementById('classProductForm');
            if (classProductForm) classProductForm.addEventListener('submit', submitClassProductForm);
            const rentalItemForm = document.getElementById('rentalItemForm');
            if (rentalItemForm) rentalItemForm.addEventListener('submit', submitRentalItemForm);
            const passwordForm = document.getElementById('passwordForm');
            if (passwordForm) {
                passwordForm.addEventListener('submit', handlePasswordChange);
            }

            setOverviewDateToToday();
            const overviewDateInput = document.getElementById('overviewDate');
            if (overviewDateInput) {
                overviewDateInput.addEventListener('change', () => loadBookingOverview(overviewDateInput.value));
            }

            if (isAuthDisabled()) {
                const loginResult = await performAdminLogin();
                if (!loginResult.success) {
                    showLoginError(loginResult.error || LOGIN_ERROR_DEFAULT);
                }
                return;
            }

            const token = sessionStorage.getItem('adminToken');
            const expiry = sessionStorage.getItem('adminTokenExpiry');
            if (token && (!expiry || new Date(expiry) > new Date())) {
                showAdminPanel();
            }
        });

        function authHeaders() {
            const token = sessionStorage.getItem('adminToken');
            return token ? { 'Authorization': `Bearer ${token}` } : {};
        }

        async function performAdminLogin(password = '') {
            try {
                const payload = isAuthDisabled() ? {} : { password };
                const response = await fetch(`${API_BASE_URL}/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json().catch(() => ({}));

                if (response.ok && result.success) {
                    if (result.token) {
                        sessionStorage.setItem('adminToken', result.token);
                    }
                    if (result.expiresAt) {
                        sessionStorage.setItem('adminTokenExpiry', result.expiresAt);
                    } else {
                        sessionStorage.removeItem('adminTokenExpiry');
                    }
                    showAdminPanel();
                    return { success: true, result };
                }

                return {
                    success: false,
                    error: (result && result.error) || LOGIN_ERROR_DEFAULT
                };
            } catch (error) {
                console.error('Login error:', error);
                return {
                    success: false,
                    error: '無法登入，請稍後再試。'
                };
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const passwordInput = document.getElementById('passwordInput');
            const password = passwordInput ? passwordInput.value : '';
            if (!isAuthDisabled() && !password) {
                showLoginError('請輸入管理密碼。');
                return;
            }
            const loginAttempt = await performAdminLogin(password);
            if (!loginAttempt.success) {
                showLoginError(loginAttempt.error || LOGIN_ERROR_DEFAULT);
            }
        }

        function showAdminPanel() {
            document.getElementById('adminContainer').style.display = 'block';
            updateAdminIdentity(true);
            const passwordMsg = document.getElementById('passwordMessage');
            if (passwordMsg) { passwordMsg.style.display = 'none'; passwordMsg.textContent = ''; }
            const passwordForm = document.getElementById('passwordForm');
            if (passwordForm) passwordForm.reset();
            setOverviewDateToToday();
            loadBookingOverview(document.getElementById('overviewDate')?.value);
            loadStats();
            loadBookings();
            loadSettings();
            loadInstructions();
            loadClasses();
            loadClassProducts();
            loadRentalItems();
            if (refreshIntervalId) clearInterval(refreshIntervalId);
            refreshIntervalId = setInterval(() => {
                loadStats();
                loadBookings();
                loadBookingOverview(document.getElementById('overviewDate')?.value);
            }, 30000);
        }

        function logout() {
            sessionStorage.removeItem('adminToken');
            sessionStorage.removeItem('adminTokenExpiry');
            if (refreshIntervalId) clearInterval(refreshIntervalId);
            const adminContainer = document.getElementById('adminContainer');
            if (adminContainer) adminContainer.style.display = 'none';
            const studioList = document.getElementById('overviewStudioList');
            const classList = document.getElementById('overviewClassList');
            const overviewMsg = document.getElementById('overviewMessage');
            if (studioList) studioList.innerHTML = '';
            if (classList) classList.innerHTML = '';
            if (overviewMsg) { overviewMsg.style.display = 'none'; overviewMsg.textContent = ''; }
            const passwordForm = document.getElementById('passwordForm');
            if (passwordForm) passwordForm.reset();
            const passwordMsg = document.getElementById('passwordMessage');
            if (passwordMsg) { passwordMsg.style.display = 'none'; passwordMsg.textContent = ''; }
            updateAdminIdentity(false);
            if (isAuthDisabled()) {
                performAdminLogin();
            }
        }

        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE_URL}/stats`, { headers: authHeaders() });
                if (response.status === 401) return logout();
                if (!response.ok) {
                    const errorPayload = await response.json().catch(() => ({}));
                    console.error('Failed to load stats:', response.status, errorPayload);
                    showMessage('bookingsMessage', 'error', errorPayload.error || '無法載入統計資料，請稍後再試。');
                    return;
                }
                const stats = await response.json();
                document.getElementById('stat-total').querySelector('p').textContent = stats.total;
                document.getElementById('stat-confirmed').querySelector('p').textContent = stats.confirmed;
                document.getElementById('stat-pending').querySelector('p').textContent = stats.pending;
            } catch (error) {
                console.error('Error loading stats:', error);
                showMessage('bookingsMessage', 'error', '無法載入統計資料，請稍後再試。');
            }
        }

        async function loadBookings() {
            await Promise.all([loadRentalBookings(), loadClassBookings()]);
        }

        async function loadRentalBookings() {
            try {
                const response = await fetch(`${API_BASE_URL}/bookings`, { headers: authHeaders() });
                if (response.status === 401) return logout();
                if (!response.ok) {
                    const errorPayload = await response.json().catch(() => ({}));
                    console.error('Failed to load bookings:', response.status, errorPayload);
                    showMessage('bookingsMessage', 'error', errorPayload.error || '無法載入預約資料，請稍後再試。');
                    return;
                }
                const bookings = await response.json();
                renderRentalBookings(bookings);
                hideMessage('bookingsMessage');
            } catch (error) {
                console.error('Error loading bookings:', error);
                showMessage('bookingsMessage', 'error', '無法載入預約資料，請稍後再試。');
            }
        }

        function renderRentalBookings(bookings) {
            const tbody = document.getElementById('bookingsTable');
            if (!tbody) return;
            tbody.innerHTML = '';
            if (!bookings || bookings.length === 0) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 7;
                cell.style.textAlign = 'center';
                cell.textContent = '暫無預約資料';
                row.appendChild(cell);
                tbody.appendChild(row);
                return;
            }
            bookings.forEach(booking => {
                const row = document.createElement('tr');
                const itemsHtml = (booking.items || []).map(item => {
                    const peopleCount = Number.isFinite(Number(item.peopleCount)) && Number(item.peopleCount) > 0
                        ? Number(item.peopleCount)
                        : 1;
                    const label = item.itemType === 'workshop_class' ? '課程' : '場地';
                    return `<div><strong>${label}:</strong> ${item.date} ${item.startTime}-${item.endTime} (${peopleCount}人)</div>`;
                }).join('');
                const totalPeopleValue = Number.isFinite(Number(booking.totalPeople)) && Number(booking.totalPeople) > 0
                    ? Number(booking.totalPeople)
                    : 1;
                row.innerHTML = `
                    <td>${escapeHtml(booking.id)}</td>
                    <td>${escapeHtml(booking.customerName)}<br><small>${escapeHtml(booking.email)}<br>${escapeHtml(booking.phone)}</small></td>
                    <td>${itemsHtml || '—'}</td>
                    <td>${escapeHtml(String(totalPeopleValue))}</td>
                    <td>HK$${Number(booking.totalPrice || 0).toFixed(2)}</td>
                    <td><span class="status-chip status-${booking.status}">${escapeHtml(booking.status)}</span></td>
                    <td>
                        <button class="btn btn-secondary" onclick="updateBookingStatus('${booking.id}','confirmed')">確認</button>
                        <button class="btn btn-secondary" onclick="updateBookingStatus('${booking.id}','pending')">待處理</button>
                        <button class="btn btn-secondary" onclick="updateBookingStatus('${booking.id}','cancelled')">取消</button>
                        <button class="btn btn-danger" onclick="deleteRentalBooking('${booking.id}')">刪除</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function loadClassBookings() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/class-bookings`, { headers: authHeaders() });
                if (response.status === 401) return logout();
                if (!response.ok) {
                    const errorPayload = await response.json().catch(() => ({}));
                    console.error('Failed to load class bookings:', response.status, errorPayload);
                    showMessage('classBookingsMessage', 'error', errorPayload.error || '無法載入課程預約資料，請稍後再試。');
                    return;
                }
                const bookings = await response.json();
                renderClassBookings(bookings);
                hideMessage('classBookingsMessage');
            } catch (error) {
                console.error('Error loading class bookings:', error);
                showMessage('classBookingsMessage', 'error', '無法載入課程預約資料，請稍後再試。');
            }
        }

        function renderClassBookings(bookings) {
            const tbody = document.getElementById('classBookingsTable');
            if (!tbody) return;
            tbody.innerHTML = '';
            if (!bookings || bookings.length === 0) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 6;
                cell.style.textAlign = 'center';
                cell.textContent = '暫無課程預約';
                row.appendChild(cell);
                tbody.appendChild(row);
                return;
            }

            bookings.forEach(booking => {
                const row = document.createElement('tr');
                const startLabel = booking.classStartTime ? formatOverviewDateTime(booking.classStartTime) : '';
                const endLabel = booking.classEndTime ? formatOverviewTime(booking.classEndTime) : '';
                const scheduleDisplay = endLabel ? `${startLabel} - ${endLabel}` : startLabel;
                const locationHtml = booking.classLocation ? `<br><small>${escapeHtml(booking.classLocation)}</small>` : '';
                row.innerHTML = `
                    <td>${escapeHtml(booking.id)}</td>
                    <td>${escapeHtml(booking.className || '—')}<br><small>${escapeHtml(scheduleDisplay || '')}</small>${locationHtml}</td>
                    <td>${escapeHtml(booking.customerName)}<br><small>${escapeHtml(booking.email)}<br>${escapeHtml(booking.phone)}</small></td>
                    <td>${escapeHtml(String(booking.peopleCount || 0))}</td>
                    <td><span class="status-chip status-${booking.status}">${escapeHtml(booking.status)}</span></td>
                    <td>
                        <button class="btn btn-secondary" onclick="updateClassBookingStatus('${booking.id}','confirmed')">確認</button>
                        <button class="btn btn-secondary" onclick="updateClassBookingStatus('${booking.id}','pending')">待處理</button>
                        <button class="btn btn-secondary" onclick="updateClassBookingStatus('${booking.id}','cancelled')">取消</button>
                        <button class="btn btn-danger" onclick="deleteClassBooking('${booking.id}')">刪除</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function updateBookingStatus(id, status) {
            try {
                const response = await fetch(`${API_BASE_URL}/bookings/${id}/status`, { method: 'PATCH', headers: { 'Content-Type': 'application/json', ...authHeaders() }, body: JSON.stringify({ status }) });
                if (response.status === 401) return logout();
                const result = await response.json();
                if (response.ok) {
                    showMessage('bookingsMessage', 'success', result.message || '更新成功');
                    loadRentalBookings();
                    loadBookingOverview(document.getElementById('overviewDate')?.value);
                    loadStats();
                } else {
                    showMessage('bookingsMessage', 'error', result.error || '更新失敗');
                }
            } catch (error) {
                console.error('Error updating booking status:', error);
                showMessage('bookingsMessage', 'error', '更新失敗，請稍後再試');
            }
        }

        async function deleteRentalBooking(id) {
            if (!confirm('確定要刪除此預約記錄嗎？此動作無法復原。')) return;
            try {
                const response = await fetch(`${API_BASE_URL}/admin/bookings/${id}`, { method: 'DELETE', headers: authHeaders() });
                if (response.status === 401) return logout();
                const result = await response.json().catch(() => ({}));
                if (response.ok) {
                    showMessage('bookingsMessage', 'success', result.message || '預約記錄已刪除');
                    loadRentalBookings();
                    loadBookingOverview(document.getElementById('overviewDate')?.value);
                    loadStats();
                } else {
                    showMessage('bookingsMessage', 'error', result.error || '刪除失敗');
                }
            } catch (error) {
                console.error('Error deleting booking:', error);
                showMessage('bookingsMessage', 'error', '刪除失敗，請稍後再試');
            }
        }

        async function updateClassBookingStatus(id, status) {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/class-bookings/${id}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ status })
                });
                if (response.status === 401) return logout();
                const result = await response.json().catch(() => ({}));
                if (response.ok) {
                    showMessage('classBookingsMessage', 'success', result.message || '更新成功');
                    loadClassBookings();
                    loadBookingOverview(document.getElementById('overviewDate')?.value);
                } else {
                    showMessage('classBookingsMessage', 'error', result.error || '更新失敗');
                }
            } catch (error) {
                console.error('Error updating class booking status:', error);
                showMessage('classBookingsMessage', 'error', '更新失敗，請稍後再試');
            }
        }

        async function deleteClassBooking(id) {
            if (!confirm('確定要刪除此課程預約？')) return;
            try {
                const response = await fetch(`${API_BASE_URL}/admin/class-bookings/${id}`, { method: 'DELETE', headers: authHeaders() });
                if (response.status === 401) return logout();
                if (response.ok) {
                    showMessage('classBookingsMessage', 'success', '課程預約已刪除');
                    loadClassBookings();
                    loadBookingOverview(document.getElementById('overviewDate')?.value);
                } else {
                    const result = await response.json().catch(() => ({}));
                    showMessage('classBookingsMessage', 'error', result.error || '刪除失敗');
                }
            } catch (error) {
                console.error('Error deleting class booking:', error);
                showMessage('classBookingsMessage', 'error', '刪除失敗，請稍後再試');
            }
        }

        async function loadSettings() {
            try {
                const response = await fetch(`${API_BASE_URL}/settings`, { headers: authHeaders() });
                if (response.status === 401) return logout();
                if (!response.ok) {
                    const errorPayload = await response.json().catch(() => ({}));
                    console.error('Failed to load settings:', response.status, errorPayload);
                    showMessage('settingsMessage', 'error', errorPayload.error || '無法載入設定，請稍後再試。');
                    return;
                }
                currentSettings = await response.json();
                populateSettings();
                hideMessage('settingsMessage');
            } catch (error) {
                console.error('Error loading settings:', error);
                showMessage('settingsMessage', 'error', '無法載入設定，請稍後再試。');
            }
        }

        function populateSettings() {
            const operatingHours = currentSettings.operatingHours || {};
            const pricing = currentSettings.pricing || {};
            const peakSchedule = pricing.peakSchedule || {};
            const contactInfo = currentSettings.contactInfo || {};
            const paymentMethods = currentSettings.paymentMethods || {};
            const bankTransfer = paymentMethods.bankTransfer || {};
            const payme = paymentMethods.payme || {};
            const fps = paymentMethods.fps || {};
            const bookingRules = currentSettings.bookingRules || {};

            document.getElementById('businessName').value = currentSettings.businessName || '';
            document.getElementById('businessNameZh').value = currentSettings.businessNameZh || '';
            document.getElementById('businessDescription').value = currentSettings.businessDescription || '';
            document.getElementById('businessDescriptionZh').value = currentSettings.businessDescriptionZh || '';
            document.getElementById('startTime').value = operatingHours.startTime || '07:00';
            document.getElementById('endTime').value = operatingHours.endTime || '22:00';
            document.getElementById('daysLabelZh').value = operatingHours.daysLabelZh || '';
            document.getElementById('daysLabelEn').value = operatingHours.daysLabelEn || '';
            document.getElementById('normalUpTo10').value = pricing.normalUpTo10 ?? '';
            document.getElementById('normalUpTo18').value = pricing.normalUpTo18 ?? '';
            document.getElementById('peakUpTo10').value = pricing.peakUpTo10 ?? '';
            document.getElementById('peakUpTo18').value = pricing.peakUpTo18 ?? '';
            document.getElementById('peakDays').value = Array.isArray(peakSchedule.days) ? peakSchedule.days.join(',') : '';
            document.getElementById('peakStart').value = peakSchedule.startTime || '';
            document.getElementById('peakEnd').value = peakSchedule.endTime || '';
            document.getElementById('contactWhatsapp').value = contactInfo.whatsapp || '';
            document.getElementById('contactPhone').value = contactInfo.phone || '';
            document.getElementById('contactEmail').value = contactInfo.email || '';
            document.getElementById('paymentBankEnabled').value = bankTransfer.enabled ? 'true' : 'false';
            document.getElementById('paymentBankName').value = bankTransfer.bankName || '';
            document.getElementById('paymentBankAccount').value = bankTransfer.accountNumber || '';
            document.getElementById('paymentBankAccountName').value = bankTransfer.accountName || '';
            document.getElementById('paymentPaymeEnabled').value = payme.enabled ? 'true' : 'false';
            document.getElementById('paymentPaymeDisplayName').value = payme.displayName || '';
            document.getElementById('paymentPaymePhone').value = payme.phoneNumber || '';
            document.getElementById('paymentFpsEnabled').value = fps.enabled ? 'true' : 'false';
            document.getElementById('paymentFpsNumber').value = fps.fpsNumber || '';
            document.getElementById('paymentFpsDisplayName').value = fps.displayName || '';
            document.getElementById('bookingMinAdvance').value = bookingRules.minAdvanceBooking ?? '';
            document.getElementById('bookingMaxAdvance').value = bookingRules.maxAdvanceBooking ?? '';
            document.getElementById('bookingSlotInterval').value = bookingRules.slotInterval ?? '';
            document.getElementById('bookingAutoConfirm').value = bookingRules.autoConfirm ? 'true' : 'false';
            document.getElementById('bookingRequirePaymentProof').value = bookingRules.requirePaymentProof === false ? 'false' : 'true';
        }

        async function saveSettings() {
            const timePattern = /^(?:[01]\d|2[0-3]):[0-5]\d$/;
            const parseTimeToMinutes = (value) => {
                if (!timePattern.test(value)) return null;
                const [hours, minutes] = value.split(':').map(Number);
                return (hours * 60) + minutes;
            };

            const startTimeValue = document.getElementById('startTime').value.trim();
            const endTimeValue = document.getElementById('endTime').value.trim();
            if (!startTimeValue || !endTimeValue || !timePattern.test(startTimeValue) || !timePattern.test(endTimeValue)) {
                showMessage('settingsMessage', 'error', '請輸入有效的營業開始與結束時間（格式：HH:MM）');
                return;
            }

            const startMinutes = parseTimeToMinutes(startTimeValue);
            const endMinutes = parseTimeToMinutes(endTimeValue);
            if (startMinutes === null || endMinutes === null || startMinutes >= endMinutes) {
                showMessage('settingsMessage', 'error', '營業開始時間需早於結束時間');
                return;
            }

            const peakStartValue = document.getElementById('peakStart').value.trim();
            const peakEndValue = document.getElementById('peakEnd').value.trim();
            if (peakStartValue && !timePattern.test(peakStartValue)) {
                showMessage('settingsMessage', 'error', '請輸入有效的繁忙時段開始時間（格式：HH:MM）');
                return;
            }
            if (peakEndValue && !timePattern.test(peakEndValue)) {
                showMessage('settingsMessage', 'error', '請輸入有效的繁忙時段結束時間（格式：HH:MM）');
                return;
            }
            if (peakStartValue && peakEndValue) {
                const peakStartMinutes = parseTimeToMinutes(peakStartValue);
                const peakEndMinutes = parseTimeToMinutes(peakEndValue);
                if (peakStartMinutes !== null && peakEndMinutes !== null && peakStartMinutes >= peakEndMinutes) {
                    showMessage('settingsMessage', 'error', '繁忙時段開始時間需早於結束時間');
                    return;
                }
            }

            const toFloat = (value) => {
                const parsed = Number.parseFloat(value);
                return Number.isFinite(parsed) ? parsed : null;
            };
            const toInt = (value) => {
                const parsed = Number.parseInt(value, 10);
                return Number.isFinite(parsed) ? parsed : null;
            };

            const currentPricing = currentSettings.pricing || {};
            const normalUpTo10Value = toFloat(document.getElementById('normalUpTo10').value);
            const normalUpTo18Value = toFloat(document.getElementById('normalUpTo18').value);
            const peakUpTo10Value = toFloat(document.getElementById('peakUpTo10').value);
            const peakUpTo18Value = toFloat(document.getElementById('peakUpTo18').value);
            const peakDays = document.getElementById('peakDays').value
                .split(',')
                .map(v => v.trim().toLowerCase())
                .filter(Boolean);

            const pricing = {
                ...currentPricing,
                normalUpTo10: normalUpTo10Value !== null ? normalUpTo10Value : currentPricing.normalUpTo10 ?? null,
                normalUpTo18: normalUpTo18Value !== null ? normalUpTo18Value : currentPricing.normalUpTo18 ?? null,
                peakUpTo10: peakUpTo10Value !== null ? peakUpTo10Value : currentPricing.peakUpTo10 ?? null,
                peakUpTo18: peakUpTo18Value !== null ? peakUpTo18Value : currentPricing.peakUpTo18 ?? null,
                peakSchedule: {
                    ...(currentPricing.peakSchedule || {}),
                    days: peakDays,
                    startTime: peakStartValue || null,
                    endTime: peakEndValue || null
                }
            };

            const currentRules = currentSettings.bookingRules || {};
            const minAdvanceInput = toInt(document.getElementById('bookingMinAdvance').value);
            const maxAdvanceInput = toInt(document.getElementById('bookingMaxAdvance').value);
            const slotIntervalInput = toInt(document.getElementById('bookingSlotInterval').value);

            const bookingRules = {
                ...currentRules,
                minAdvanceBooking: minAdvanceInput !== null ? minAdvanceInput : currentRules.minAdvanceBooking ?? null,
                maxAdvanceBooking: maxAdvanceInput !== null ? maxAdvanceInput : currentRules.maxAdvanceBooking ?? null,
                slotInterval: slotIntervalInput !== null ? slotIntervalInput : currentRules.slotInterval ?? null,
                autoConfirm: document.getElementById('bookingAutoConfirm').value === 'true',
                requirePaymentProof: document.getElementById('bookingRequirePaymentProof').value === 'true'
            };

            const payload = {
                ...currentSettings,
                businessName: document.getElementById('businessName').value,
                businessNameZh: document.getElementById('businessNameZh').value,
                businessDescription: document.getElementById('businessDescription').value,
                businessDescriptionZh: document.getElementById('businessDescriptionZh').value,
                operatingHours: {
                    ...(currentSettings.operatingHours || {}),
                    startTime: startTimeValue,
                    endTime: endTimeValue,
                    daysLabelZh: document.getElementById('daysLabelZh').value,
                    daysLabelEn: document.getElementById('daysLabelEn').value
                },
                pricing,
                contactInfo: {
                    ...(currentSettings.contactInfo || {}),
                    whatsapp: document.getElementById('contactWhatsapp').value,
                    phone: document.getElementById('contactPhone').value,
                    email: document.getElementById('contactEmail').value
                },
                paymentMethods: {
                    ...(currentSettings.paymentMethods || {}),
                    bankTransfer: {
                        ...(currentSettings.paymentMethods?.bankTransfer || {}),
                        enabled: document.getElementById('paymentBankEnabled').value === 'true',
                        bankName: document.getElementById('paymentBankName').value,
                        accountNumber: document.getElementById('paymentBankAccount').value,
                        accountName: document.getElementById('paymentBankAccountName').value
                    },
                    payme: {
                        ...(currentSettings.paymentMethods?.payme || {}),
                        enabled: document.getElementById('paymentPaymeEnabled').value === 'true',
                        displayName: document.getElementById('paymentPaymeDisplayName').value,
                        phoneNumber: document.getElementById('paymentPaymePhone').value
                    },
                    fps: {
                        ...(currentSettings.paymentMethods?.fps || {}),
                        enabled: document.getElementById('paymentFpsEnabled').value === 'true',
                        fpsNumber: document.getElementById('paymentFpsNumber').value,
                        displayName: document.getElementById('paymentFpsDisplayName').value
                    }
                },
                bookingRules
            };
            try {
                const response = await fetch(`${API_BASE_URL}/settings`, { method: 'PUT', headers: { 'Content-Type': 'application/json', ...authHeaders() }, body: JSON.stringify(payload) });
                if (response.status === 401) return logout();
                if (response.ok) {
                    const result = await response.json().catch(() => ({}));
                    currentSettings = result.settings || payload;
                    populateSettings();
                    showMessage('settingsMessage', 'success', result.message || '設定已更新');
                } else {
                    const result = await response.json().catch(() => ({}));
                    console.error('Failed to save settings:', response.status, result);
                    showMessage('settingsMessage', 'error', result.error || '儲存失敗');
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                showMessage('settingsMessage', 'error', '儲存失敗，請稍後再試');
            }
        }

        async function handlePasswordChange(event) {
            event.preventDefault();
            if (isAuthDisabled()) {
                showMessage('passwordMessage', 'success', '開發模式：目前已停用管理密碼驗證。');
                event.target.reset();
                return;
            }
            const current = document.getElementById('currentAdminPassword').value;
            const nextPassword = document.getElementById('newAdminPassword').value;
            const confirmPassword = document.getElementById('confirmAdminPassword').value;

            if (!current || !nextPassword || !confirmPassword) {
                showMessage('passwordMessage', 'error', '請填寫所有欄位');
                return;
            }

            if (nextPassword !== confirmPassword) {
                showMessage('passwordMessage', 'error', '新密碼與確認密碼不一致');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/admin/change-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ currentPassword: current, newPassword: nextPassword })
                });
                const result = await response.json().catch(() => ({}));

                if (response.status === 401) {
                    showMessage('passwordMessage', 'error', result.error || '驗證失敗，請重新登入');
                    setTimeout(() => logout(), 1500);
                    return;
                }

                if (response.ok && result.success) {
                    showMessage('passwordMessage', 'success', '密碼已更新，請重新登入');
                    event.target.reset();
                    setTimeout(() => {
                        logout();
                    }, 1500);
                } else {
                    showMessage('passwordMessage', 'error', result.error || '更新失敗，請稍後再試');
                }
            } catch (error) {
                console.error('Error changing password:', error);
                showMessage('passwordMessage', 'error', '更新失敗，請稍後再試');
            }
        }

        async function loadInstructions() {
            try {
                const response = await fetch(`${API_BASE_URL}/settings`);
                if (!response.ok) {
                    const errorPayload = await response.json().catch(() => ({}));
                    console.error('Failed to load instructions:', response.status, errorPayload);
                    showMessage('instructionsMessage', 'error', errorPayload.error || '無法載入預約須知，請稍後再試。');
                    return;
                }
                const settings = await response.json();
                const instructions = settings.bookingInstructions || {};
                document.getElementById('titleZh').value = instructions.titleZh || '';
                document.getElementById('titleEn').value = instructions.titleEn || '';
                for (let i = 1; i <= 6; i++) {
                    document.getElementById(`instruction${i}Zh`).value = instructions[`instruction${i}Zh`] || '';
                    document.getElementById(`instruction${i}En`).value = instructions[`instruction${i}En`] || '';
                }
                hideMessage('instructionsMessage');
            } catch (error) {
                console.error('Error loading instructions:', error);
                showMessage('instructionsMessage', 'error', '無法載入預約須知，請稍後再試。');
            }
        }

        async function saveInstructions() {
            const bookingInstructions = { titleZh: document.getElementById('titleZh').value, titleEn: document.getElementById('titleEn').value };
            for (let i = 1; i <= 6; i++) {
                bookingInstructions[`instruction${i}Zh`] = document.getElementById(`instruction${i}Zh`).value;
                bookingInstructions[`instruction${i}En`] = document.getElementById(`instruction${i}En`).value;
            }
            const payload = { ...currentSettings, bookingInstructions };
            try {
                const response = await fetch(`${API_BASE_URL}/settings`, { method: 'PUT', headers: { 'Content-Type': 'application/json', ...authHeaders() }, body: JSON.stringify(payload) });
                if (response.status === 401) return logout();
                if (response.ok) {
                    currentSettings = (await response.json()).settings || payload;
                    showMessage('instructionsMessage', 'success', '須知已更新');
                } else {
                    const result = await response.json().catch(() => ({}));
                    console.error('Failed to save instructions:', response.status, result);
                    showMessage('instructionsMessage', 'error', result.error || '儲存失敗');
                }
            } catch (error) {
                console.error('Error saving instructions:', error);
                showMessage('instructionsMessage', 'error', '儲存失敗');
            }
        }

        async function loadClasses() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/classes?includePast=true`, { headers: authHeaders() });
                if (response.status === 401) return logout();
                if (!response.ok) {
                    const errorPayload = await response.json().catch(() => ({}));
                    console.error('Failed to load classes:', response.status, errorPayload);
                    showMessage('classesMessage', 'error', errorPayload.error || '無法載入課程資料，請稍後再試。');
                    return;
                }
                currentClasses = await response.json();
                renderClasses();
                hideMessage('classesMessage');
            } catch (error) {
                console.error('Error loading classes:', error);
                showMessage('classesMessage', 'error', '無法載入課程資料，請稍後再試。');
            }
        }

        function renderClasses() {
            const container = document.getElementById('classesList');
            if (!container) return;
            container.innerHTML = '';
            if (!currentClasses || currentClasses.length === 0) {
                const empty = document.createElement('div');
                empty.style.color = '#516273';
                empty.textContent = '目前沒有課程';
                container.appendChild(empty);
                return;
            }

            currentClasses.forEach(cls => {
                const card = document.createElement('div');
                card.className = 'item-card';
                const start = cls.startTime ? new Date(cls.startTime) : null;
                const end = cls.endTime ? new Date(cls.endTime) : null;
                const capacity = cls.capacity || 0;
                const remaining = cls.seatsRemaining != null
                    ? cls.seatsRemaining
                    : Math.max(capacity - (cls.usedCapacity || 0), 0);
                const tags = Array.isArray(cls.tags) ? cls.tags.filter(Boolean) : [];
                const priceLine = cls.specialPriceForTwo != null
                    ? `價格：HK$${Number(cls.price || 0).toFixed(2)} /人｜兩人同行 HK$${Number(cls.specialPriceForTwo).toFixed(2)}`
                    : `價格：HK$${Number(cls.price || 0).toFixed(2)}`;
                const tagsRow = tags.length ? `<small>標籤：${tags.map(tag => escapeHtml(tag)).join(', ')}</small>` : '';
                const trialLabel = cls.isTrialOnly ? '<small style="color:#f2545b;">體驗限定</small>' : '';

                card.innerHTML = `
                    <h4>${escapeHtml(cls.name)} ${trialLabel}</h4>
                    <small>${start ? formatDateTime(start) : ''}${end ? ' - ' + formatTime(end) : ''}</small>
                    <small>地點：${escapeHtml(cls.location || '—')}</small>
                    <small>導師：${escapeHtml(cls.instructor || '—')}</small>
                    <small>${priceLine}</small>
                    <small>人數：${escapeHtml(String(capacity))}｜剩餘：${escapeHtml(String(Math.max(remaining, 0)))}</small>
                    ${tagsRow}
                `;

                const actions = document.createElement('div');
                actions.className = 'item-actions';
                const editBtn = document.createElement('button');
                editBtn.className = 'btn btn-secondary';
                editBtn.textContent = '編輯';
                editBtn.addEventListener('click', () => editClass(cls));
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger';
                deleteBtn.textContent = '刪除';
                deleteBtn.addEventListener('click', () => deleteClass(cls.id));
                actions.appendChild(editBtn);
                actions.appendChild(deleteBtn);
                card.appendChild(actions);
                container.appendChild(card);
            });
        }

        function editClass(cls) {
            document.getElementById('classId').value = cls.id;
            document.getElementById('className').value = cls.name || '';
            document.getElementById('classInstructor').value = cls.instructor || '';
            document.getElementById('classLocation').value = cls.location || '';
            document.getElementById('classStart').value = cls.startTime ? cls.startTime.slice(0, 16) : '';
            document.getElementById('classEnd').value = cls.endTime ? cls.endTime.slice(0, 16) : '';
            document.getElementById('classPrice').value = cls.price != null ? cls.price : '';
            document.getElementById('classSpecialPriceForTwo').value = cls.specialPriceForTwo != null ? cls.specialPriceForTwo : '';
            document.getElementById('classCapacity').value = cls.capacity != null ? cls.capacity : '';
            document.getElementById('classDescription').value = cls.description || '';
            document.getElementById('classTags').value = Array.isArray(cls.tags) ? cls.tags.join(',') : '';
            document.getElementById('classIsTrialOnly').value = cls.isTrialOnly ? 'true' : 'false';
        }

        function resetClassForm() {
            const form = document.getElementById('classForm');
            if (form) form.reset();
            document.getElementById('classId').value = '';
            document.getElementById('classSpecialPriceForTwo').value = '';
            document.getElementById('classIsTrialOnly').value = 'false';
        }

        async function submitClassForm(event) {
            event.preventDefault();
            const id = document.getElementById('classId').value;
            const name = document.getElementById('className').value.trim();
            const startValue = document.getElementById('classStart').value;
            const endValue = document.getElementById('classEnd').value;
            const priceValue = Number.parseFloat(document.getElementById('classPrice').value);
            const specialPriceValueRaw = document.getElementById('classSpecialPriceForTwo').value;
            const specialPriceValue = specialPriceValueRaw === ''
                ? null
                : Number.parseFloat(specialPriceValueRaw);
            const capacityValue = Number.parseInt(document.getElementById('classCapacity').value, 10);

            if (!name) {
                showMessage('classesMessage', 'error', '請輸入課程名稱');
                return;
            }
            if (!startValue || !endValue) {
                showMessage('classesMessage', 'error', '請選擇開始與結束時間');
                return;
            }
            const startTime = new Date(startValue);
            const endTime = new Date(endValue);
            if (Number.isNaN(startTime.getTime()) || Number.isNaN(endTime.getTime())) {
                showMessage('classesMessage', 'error', '請輸入有效的日期時間');
                return;
            }
            if (startTime >= endTime) {
                showMessage('classesMessage', 'error', '結束時間需晚於開始時間');
                return;
            }
            if (!Number.isFinite(priceValue) || priceValue < 0) {
                showMessage('classesMessage', 'error', '請輸入有效的價格');
                return;
            }
            if (specialPriceValue !== null && (!Number.isFinite(specialPriceValue) || specialPriceValue < 0)) {
                showMessage('classesMessage', 'error', '兩人同行價需為有效數字');
                return;
            }
            if (!Number.isInteger(capacityValue) || capacityValue <= 0) {
                showMessage('classesMessage', 'error', '請輸入有效的人數上限');
                return;
            }

            const payload = {
                name,
                description: document.getElementById('classDescription').value,
                instructor: document.getElementById('classInstructor').value,
                location: document.getElementById('classLocation').value,
                startTime: startTime.toISOString(),
                endTime: endTime.toISOString(),
                price: priceValue,
                specialPriceForTwo: specialPriceValue,
                capacity: capacityValue,
                tags: document.getElementById('classTags').value.split(',').map(tag => tag.trim()).filter(Boolean),
                isTrialOnly: document.getElementById('classIsTrialOnly').value === 'true'
            };

            try {
                const method = id ? 'PUT' : 'POST';
                const endpoint = id ? `${API_BASE_URL}/admin/classes/${id}` : `${API_BASE_URL}/admin/classes`;
                const response = await fetch(endpoint, {
                    method,
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(payload)
                });
                if (response.status === 401) return logout();
                const result = await response.json().catch(() => ({}));
                if (response.ok) {
                    showMessage('classesMessage', 'success', '課程已儲存');
                    resetClassForm();
                    loadClasses();
                    loadBookingOverview(document.getElementById('overviewDate')?.value);
                } else {
                    console.error('Failed to save class:', response.status, result);
                    showMessage('classesMessage', 'error', result.error || '儲存失敗');
                }
            } catch (error) {
                console.error('Error saving class:', error);
                showMessage('classesMessage', 'error', '儲存失敗，請稍後再試');
            }
        }

        async function deleteClass(id) {
            if (!confirm('確定要刪除此課程？')) return;
            try {
                const response = await fetch(`${API_BASE_URL}/admin/classes/${id}`, { method: 'DELETE', headers: authHeaders() });
                if (response.status === 401) return logout();
                if (response.ok) {
                    showMessage('classesMessage', 'success', '課程已刪除');
                    loadClasses();
                    loadBookingOverview(document.getElementById('overviewDate')?.value);
                } else {
                    const result = await response.json().catch(() => ({}));
                    showMessage('classesMessage', 'error', result.error || '刪除失敗');
                }
            } catch (error) {
                console.error('Error deleting class:', error);
                showMessage('classesMessage', 'error', '刪除失敗，請稍後再試');
            }
        }

        async function loadClassProducts() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/class-products`, { headers: authHeaders() });
                if (response.status === 401) return logout();
                if (!response.ok) {
                    const errorPayload = await response.json().catch(() => ({}));
                    console.error('Failed to load class products:', response.status, errorPayload);
                    showMessage('classProductsMessage', 'error', errorPayload.error || '無法載入方案資料，請稍後再試。');
                    return;
                }
                currentClassProducts = await response.json();
                renderClassProducts();
                hideMessage('classProductsMessage');
            } catch (error) {
                console.error('Error loading class products:', error);
                showMessage('classProductsMessage', 'error', '無法載入方案資料，請稍後再試。');
            }
        }

        function renderClassProducts() {
            const container = document.getElementById('classProductsList');
            if (!container) return;
            container.innerHTML = '';
            if (!currentClassProducts || currentClassProducts.length === 0) {
                const empty = document.createElement('div');
                empty.style.color = '#516273';
                empty.textContent = '目前沒有方案';
                container.appendChild(empty);
                return;
            }

            currentClassProducts.forEach(product => {
                const card = document.createElement('div');
                card.className = 'item-card';
                const typeLabel = product.type === 'trial' ? '體驗方案' : '課程方案';
                card.innerHTML = `
                    <h4>${escapeHtml(product.name)} <small>(${typeLabel})</small></h4>
                    <small>價格：HK$${Number(product.price || 0).toFixed(2)}｜堂數：${escapeHtml(String(product.numberOfClasses || 0))}</small>
                    <small>有效期：${product.validityPeriodDays ? `${escapeHtml(String(product.validityPeriodDays))} 天` : '—'}</small>
                    <small>${escapeHtml(product.description || '無介紹')}</small>
                `;

                const actions = document.createElement('div');
                actions.className = 'item-actions';
                const editBtn = document.createElement('button');
                editBtn.className = 'btn btn-secondary';
                editBtn.textContent = '編輯';
                editBtn.addEventListener('click', () => editClassProduct(product));
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger';
                deleteBtn.textContent = '刪除';
                deleteBtn.addEventListener('click', () => deleteClassProduct(product.id));
                actions.appendChild(editBtn);
                actions.appendChild(deleteBtn);
                card.appendChild(actions);
                container.appendChild(card);
            });
        }

        function editClassProduct(product) {
            document.getElementById('classProductId').value = product.id;
            document.getElementById('classProductType').value = product.type || 'package';
            document.getElementById('classProductName').value = product.name || '';
            document.getElementById('classProductPrice').value = product.price != null ? product.price : '';
            document.getElementById('classProductCount').value = product.numberOfClasses || '';
            document.getElementById('classProductValidity').value = product.validityPeriodDays != null ? product.validityPeriodDays : '';
            document.getElementById('classProductDescription').value = product.description || '';
        }

        function resetClassProductForm() {
            const form = document.getElementById('classProductForm');
            if (form) form.reset();
            document.getElementById('classProductId').value = '';
            document.getElementById('classProductType').value = 'package';
        }

        async function submitClassProductForm(event) {
            event.preventDefault();
            const id = document.getElementById('classProductId').value;
            const name = document.getElementById('classProductName').value.trim();
            const priceValue = Number.parseFloat(document.getElementById('classProductPrice').value);
            const countValue = Number.parseInt(document.getElementById('classProductCount').value, 10);
            const validityValueRaw = document.getElementById('classProductValidity').value;
            const validityValue = validityValueRaw ? Number.parseInt(validityValueRaw, 10) : null;

            if (!name) {
                showMessage('classProductsMessage', 'error', '請輸入方案名稱');
                return;
            }
            if (!Number.isFinite(priceValue) || priceValue < 0) {
                showMessage('classProductsMessage', 'error', '請輸入有效的價格');
                return;
            }
            if (!Number.isInteger(countValue) || countValue <= 0) {
                showMessage('classProductsMessage', 'error', '請輸入有效的堂數');
                return;
            }
            if (validityValueRaw && (!Number.isInteger(validityValue) || validityValue <= 0)) {
                showMessage('classProductsMessage', 'error', '有效期需為正整數');
                return;
            }

            const payload = {
                type: document.getElementById('classProductType').value,
                name,
                description: document.getElementById('classProductDescription').value,
                price: priceValue,
                numberOfClasses: countValue,
                validityPeriodDays: validityValue
            };

            try {
                const method = id ? 'PUT' : 'POST';
                const endpoint = id ? `${API_BASE_URL}/admin/class-products/${id}` : `${API_BASE_URL}/admin/class-products`;
                const response = await fetch(endpoint, {
                    method,
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(payload)
                });
                if (response.status === 401) return logout();
                const result = await response.json().catch(() => ({}));
                if (response.ok) {
                    showMessage('classProductsMessage', 'success', '方案已儲存');
                    resetClassProductForm();
                    loadClassProducts();
                } else {
                    console.error('Failed to save class product:', response.status, result);
                    showMessage('classProductsMessage', 'error', result.error || '儲存失敗');
                }
            } catch (error) {
                console.error('Error saving class product:', error);
                showMessage('classProductsMessage', 'error', '儲存失敗，請稍後再試');
            }
        }

        async function deleteClassProduct(id) {
            if (!confirm('確定要刪除此方案？')) return;
            try {
                const response = await fetch(`${API_BASE_URL}/admin/class-products/${id}`, { method: 'DELETE', headers: authHeaders() });
                if (response.status === 401) return logout();
                if (response.ok) {
                    showMessage('classProductsMessage', 'success', '方案已刪除');
                    loadClassProducts();
                } else {
                    const result = await response.json().catch(() => ({}));
                    showMessage('classProductsMessage', 'error', result.error || '刪除失敗');
                }
            } catch (error) {
                console.error('Error deleting class product:', error);
                showMessage('classProductsMessage', 'error', '刪除失敗，請稍後再試');
            }
        }

        async function loadRentalItems() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/items`, { headers: authHeaders() });
                if (response.status === 401) return logout();
                if (!response.ok) {
                    const errorPayload = await response.json().catch(() => ({}));
                    console.error('Failed to load rental items:', response.status, errorPayload);
                    showMessage('rentalItemsMessage', 'error', errorPayload.error || '無法載入場地項目，請稍後再試。');
                    return;
                }
                const items = await response.json();
                currentRentalItems = (items || []).filter(item => item.type === 'room_rental');
                renderRentalItems();
                hideMessage('rentalItemsMessage');
            } catch (error) {
                console.error('Error loading rental items:', error);
                showMessage('rentalItemsMessage', 'error', '無法載入場地項目，請稍後再試。');
            }
        }

        function renderRentalItems() {
            const container = document.getElementById('rentalItemsList');
            if (!container) return;
            container.innerHTML = '';
            if (!currentRentalItems || currentRentalItems.length === 0) {
                const empty = document.createElement('div');
                empty.style.color = '#516273';
                empty.textContent = '目前沒有場地項目';
                container.appendChild(empty);
                return;
            }

            currentRentalItems.forEach(item => {
                const card = document.createElement('div');
                card.className = 'item-card';
                const start = item.startDateTime ? new Date(item.startDateTime) : null;
                const end = item.endDateTime ? new Date(item.endDateTime) : null;
                const remaining = item.availableCapacity != null
                    ? item.availableCapacity
                    : Math.max((item.capacity || 0) - (item.usedCapacity || 0), 0);
                card.innerHTML = `
                    <h4>${escapeHtml(item.name)}</h4>
                    <small>${start ? formatDateTime(start) : ''}${end ? ' - ' + formatTime(end) : ''}</small>
                    <small>時長：${escapeHtml(String(item.duration || 0))} 分鐘｜價錢：HK$${Number(item.price || 0).toFixed(2)}</small>
                    <small>人數上限：${escapeHtml(String(item.capacity || 0))}｜剩餘：${escapeHtml(String(Math.max(remaining, 0)))}</small>
                `;

                const actions = document.createElement('div');
                actions.className = 'item-actions';
                const editBtn = document.createElement('button');
                editBtn.className = 'btn btn-secondary';
                editBtn.textContent = '編輯';
                editBtn.addEventListener('click', () => editRentalItem(item));
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger';
                deleteBtn.textContent = '刪除';
                deleteBtn.addEventListener('click', () => deleteRentalItem(item.id));
                actions.appendChild(editBtn);
                actions.appendChild(deleteBtn);
                card.appendChild(actions);
                container.appendChild(card);
            });
        }

        function editRentalItem(item) {
            document.getElementById('rentalItemId').value = item.id;
            document.getElementById('rentalItemName').value = item.name || '';
            document.getElementById('rentalItemStart').value = item.startDateTime ? item.startDateTime.slice(0, 16) : '';
            document.getElementById('rentalItemEnd').value = item.endDateTime ? item.endDateTime.slice(0, 16) : '';
            document.getElementById('rentalItemDuration').value = item.duration || '';
            document.getElementById('rentalItemPrice').value = item.price != null ? item.price : '';
            document.getElementById('rentalItemInstructor').value = item.instructorName || '';
            document.getElementById('rentalItemCapacity').value = item.capacity != null ? item.capacity : '';
        }

        function resetRentalItemForm() {
            const form = document.getElementById('rentalItemForm');
            if (form) form.reset();
            document.getElementById('rentalItemId').value = '';
        }

        async function submitRentalItemForm(event) {
            event.preventDefault();
            const id = document.getElementById('rentalItemId').value;
            const name = document.getElementById('rentalItemName').value.trim();
            const startDateTime = document.getElementById('rentalItemStart').value;
            const endDateTime = document.getElementById('rentalItemEnd').value;
            const durationValue = Number.parseInt(document.getElementById('rentalItemDuration').value, 10);
            const priceValue = Number.parseFloat(document.getElementById('rentalItemPrice').value);
            const capacityValue = Number.parseInt(document.getElementById('rentalItemCapacity').value, 10);

            if (!name) {
                showMessage('rentalItemsMessage', 'error', '請輸入項目名稱');
                return;
            }
            if (!startDateTime || !endDateTime) {
                showMessage('rentalItemsMessage', 'error', '請選擇開始與結束時間');
                return;
            }
            const rentalStart = new Date(startDateTime);
            const rentalEnd = new Date(endDateTime);
            if (Number.isNaN(rentalStart.getTime()) || Number.isNaN(rentalEnd.getTime())) {
                showMessage('rentalItemsMessage', 'error', '請輸入有效的日期時間');
                return;
            }
            if (rentalStart >= rentalEnd) {
                showMessage('rentalItemsMessage', 'error', '結束時間需晚於開始時間');
                return;
            }
            if (!Number.isInteger(durationValue) || durationValue <= 0) {
                showMessage('rentalItemsMessage', 'error', '請輸入有效的時長');
                return;
            }
            if (!Number.isFinite(priceValue) || priceValue < 0) {
                showMessage('rentalItemsMessage', 'error', '請輸入有效的價格');
                return;
            }
            if (!Number.isInteger(capacityValue) || capacityValue <= 0) {
                showMessage('rentalItemsMessage', 'error', '請輸入有效的人數上限');
                return;
            }

            const payload = {
                type: 'room_rental',
                name,
                startDateTime,
                endDateTime,
                duration: durationValue,
                price: priceValue,
                instructorName: document.getElementById('rentalItemInstructor').value,
                capacity: capacityValue
            };

            try {
                const method = id ? 'PUT' : 'POST';
                const endpoint = id ? `${API_BASE_URL}/admin/items/${id}` : `${API_BASE_URL}/admin/items`;
                const response = await fetch(endpoint, {
                    method,
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(payload)
                });
                if (response.status === 401) return logout();
                const result = await response.json().catch(() => ({}));
                if (response.ok) {
                    showMessage('rentalItemsMessage', 'success', '場地項目已儲存');
                    resetRentalItemForm();
                    loadRentalItems();
                } else {
                    console.error('Failed to save rental item:', response.status, result);
                    showMessage('rentalItemsMessage', 'error', result.error || '儲存失敗');
                }
            } catch (error) {
                console.error('Error saving rental item:', error);
                showMessage('rentalItemsMessage', 'error', '儲存失敗，請稍後再試');
            }
        }

        async function deleteRentalItem(id) {
            if (!confirm('確定要刪除此場地項目？')) return;
            try {
                const response = await fetch(`${API_BASE_URL}/admin/items/${id}`, { method: 'DELETE', headers: authHeaders() });
                if (response.status === 401) return logout();
                if (response.ok) {
                    showMessage('rentalItemsMessage', 'success', '場地項目已刪除');
                    loadRentalItems();
                } else {
                    const result = await response.json().catch(() => ({}));
                    showMessage('rentalItemsMessage', 'error', result.error || '刪除失敗');
                }
            } catch (error) {
                console.error('Error deleting rental item:', error);
                showMessage('rentalItemsMessage', 'error', '刪除失敗，請稍後再試');
            }
        }

        function formatDateTime(date) { return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')} ${formatTime(date)}`; }
        function formatTime(date) { return `${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`; }

        function hideMessage(elementId) {
            const el = document.getElementById(elementId);
            if (!el) return;
            el.className = 'message';
            el.textContent = '';
            el.style.display = 'none';
        }

        function showMessage(elementId, type, message) {
            const el = document.getElementById(elementId);
            if (!el) return;
            el.className = `message ${type}`;
            el.textContent = message;
            el.style.display = 'block';
            if (type === 'success') {
                setTimeout(() => { el.style.display = 'none'; }, 4000);
            }
        }

        function handleTabClick(event) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            const targetId = event.target.dataset.tab;
            document.getElementById(targetId).classList.add('active');
            if (targetId === 'overviewTab') {
                setOverviewDateToToday();
                loadBookingOverview(document.getElementById('overviewDate')?.value);
            }
        }
    </script>
</body>
</html>
