<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Studio Booking</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Microsoft JhengHei', 'Segoe UI', Roboto, sans-serif; background: #EDEDE9; min-height: 100vh; padding: 24px; color: #1f2933; }
        a { color: #145da0; }
        .admin-container { max-width: 1280px; margin: 0 auto; display: block; }
        .admin-header { background: #fff; border-radius: 18px; padding: 28px; margin-bottom: 24px; box-shadow: 0 24px 50px rgba(0,0,0,0.12); position: relative; }
        .logout-btn { position: absolute; top: 24px; right: 24px; padding: 10px 18px; background: #f2545b; color: #fff; border: none; border-radius: 10px; cursor: pointer; transition: opacity 0.2s; }
        .logout-btn:hover { opacity: 0.8; }
        .tabs { display: flex; gap: 12px; margin-bottom: 24px; border-bottom: 2px solid #d6dde6; flex-wrap: wrap; }
        .tab-btn { padding: 10px 18px; background: transparent; border: none; color: #52606d; font-size: 1em; font-weight: 600; cursor: pointer; border-bottom: 3px solid transparent; }
        .tab-btn.active { color: #0b4f6c; border-bottom-color: #145da0; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .section-card { background: #fff; border-radius: 18px; padding: 24px; margin-bottom: 24px; box-shadow: 0 16px 40px rgba(0,0,0,0.08); }
        .section-card h3 { color: #145da0; margin-bottom: 18px; font-size: 1.4em; }
        .form-grid { display: grid; gap: 18px; }
        @media (min-width: 860px) { .form-grid.two-columns { grid-template-columns: repeat(2, minmax(0,1fr)); } }
        .input-group label { display: block; margin-bottom: 6px; font-weight: 600; color: #364152; }
        .input-group input, .input-group textarea, .input-group select { width: 100%; padding: 12px; border: 2px solid #d6dde6; border-radius: 12px; font-size: 1em; background: #fdfdfd; color: #1f2933; }
        .input-group textarea { resize: vertical; min-height: 60px; }
        .input-group input:focus, .input-group textarea:focus, .input-group select:focus { border-color: #145da0; outline: none; box-shadow: 0 0 0 4px rgba(20,93,160,0.12); }
        .btn { padding: 12px 18px; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; letter-spacing: 0.3px; }
        .btn-primary { background: linear-gradient(135deg,#0b4f6c 0%,#145da0 100%); color: #fff; }
        .btn-secondary { background: #e4ebf5; color: #1f2933; }
        .btn-danger { background: #f2545b; color: #fff; }
        .btn + .btn { margin-left: 10px; }
        .status-chip { display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 20px; font-size: 0.85em; font-weight: 600; text-transform: uppercase; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-confirmed { background: #d4edda; color: #155724; }
        .status-cancelled { background: #f8d7da; color: #721c24; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 14px; border-bottom: 1px solid #e4ebf5; text-align: left; vertical-align: top; }
        th { background: #f0f4fa; color: #145da0; font-weight: 600; }
        .message { padding: 12px 16px; border-radius: 12px; margin-bottom: 16px; display: none; }
        .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .item-list { display: grid; gap: 16px; }
        @media (min-width: 900px) { .item-list { grid-template-columns: repeat(2, minmax(0,1fr)); } }
        .item-card { border: 1px solid #dce3ef; border-radius: 16px; padding: 18px; background: #f8faff; display: flex; flex-direction: column; gap: 8px; }
        .item-card h4 { color: #0b4f6c; font-size: 1.1em; }
        .item-card small { color: #516273; }
        .item-actions { margin-top: 12px; display: flex; gap: 8px; }
        .stat-grid { display: grid; gap: 16px; margin-bottom: 16px; }
        @media (min-width: 720px) { .stat-grid { grid-template-columns: repeat(3, minmax(0,1fr)); } }
        .stat-card { background: linear-gradient(135deg,#4facfe 0%,#00f2fe 100%); color: #fff; padding: 18px; border-radius: 14px; box-shadow: 0 12px 30px rgba(79,172,254,0.35); }
        .stat-card h4 { font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.6px; margin-bottom: 6px; }
        .stat-card p { font-size: 1.8em; font-weight: 700; }
        .overview-grid { display: grid; gap: 18px; margin-top: 18px; }
        @media (min-width: 900px) { .overview-grid { grid-template-columns: repeat(2, minmax(0,1fr)); } }
        .overview-list { display: flex; flex-direction: column; gap: 12px; }
        .overview-card { background: #fff; border: 1px solid #dce3ef; border-radius: 14px; padding: 16px; box-shadow: 0 8px 18px rgba(0,0,0,0.05); }
        .overview-card h4 { color: #0b4f6c; margin-bottom: 6px; }
        .overview-meta { color: #52606d; font-size: 0.9em; line-height: 1.6; }
        .overview-attendees { margin-top: 10px; padding-left: 16px; color: #52606d; font-size: 0.88em; }
        .overview-empty { padding: 14px; border: 1px dashed #d6dde6; border-radius: 12px; color: #52606d; background: #f8faff; font-size: 0.9em; }
    </style>
</head>
<body>
    <div id="adminContainer" class="admin-container">
        <div class="admin-header">
            <h1 style="color:#0b4f6c; font-size:2.2em;">Studio Booking 管理面板</h1>
            <p style="color:#52606d;">快速管理預約、設定、課程與場地資訊。</p>
            <p id="adminIdentity" style="color:#52606d; font-size:0.95em; margin-top:6px; display:none;"></p>
            <button class="logout-btn" onclick="logout()">登出</button>
            <div class="stat-grid">
                <div class="stat-card" id="stat-total"><h4>總預約數</h4><p>0</p></div>
                <div class="stat-card" style="background:linear-gradient(135deg,#43e97b 0%,#38f9d7 100%);" id="stat-confirmed"><h4>已確認</h4><p>0</p></div>
                <div class="stat-card" style="background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);" id="stat-pending"><h4>待處理</h4><p>0</p></div>
            </div>
        </div>
        <div class="tabs">
            <button class="tab-btn active" data-tab="bookingsTab">預約列表</button>
            <button class="tab-btn" data-tab="overviewTab">預約概覽</button>
            <button class="tab-btn" data-tab="settingsTab">設定</button>
            <button class="tab-btn" data-tab="instructionsTab">預約須知</button>
            <button class="tab-btn" data-tab="itemsTab">課程 / 場地項目</button>
        </div>
        <div id="bookingsTab" class="tab-content active">
            <div class="section-card">
                <h3>預約列表</h3>
                <div id="bookingsMessage" class="message"></div>
                <div style="overflow-x:auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>預約編號</th>
                                <th>客戶 / 聯絡</th>
                                <th>項目</th>
                                <th>總人數</th>
                                <th>總金額</th>
                                <th>狀態</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="bookingsTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div id="overviewTab" class="tab-content">
            <div class="section-card">
                <h3>預約概覽</h3>
                <div class="form-grid two-columns">
                    <div class="input-group">
                        <label>選擇日期</label>
                        <input type="date" id="overviewDate">
                    </div>
                    <div class="input-group" style="display:flex;align-items:flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="refreshOverview()">重新整理</button>
                    </div>
                </div>
                <div id="overviewMessage" class="message"></div>
                <div class="overview-grid">
                    <div class="overview-column">
                        <h4 style="color:#145da0;">場地預約</h4>
                        <div id="overviewStudioList" class="overview-list"></div>
                    </div>
                    <div class="overview-column">
                        <h4 style="color:#145da0;">課程預約</h4>
                        <div id="overviewClassList" class="overview-list"></div>
                    </div>
                </div>
            </div>
        </div>
        <div id="settingsTab" class="tab-content">
            <div id="settingsMessage" class="message"></div>
            <div class="section-card">
                <h3>管理密碼</h3>
                <div id="passwordMessage" class="message"></div>
                <form id="passwordForm" class="form-grid">
                    <div class="input-group">
                        <label>目前密碼</label>
                        <input type="password" id="currentAdminPassword" required>
                    </div>
                    <div class="input-group">
                        <label>新密碼</label>
                        <input type="password" id="newAdminPassword" required>
                    </div>
                    <div class="input-group">
                        <label>確認新密碼</label>
                        <input type="password" id="confirmAdminPassword" required>
                    </div>
                    <div>
                        <button type="submit" class="btn btn-primary">更新密碼</button>
                    </div>
                </form>
            </div>
            <div class="section-card">
                <h3>基本資料</h3>
                <div class="form-grid two-columns">
                    <div class="input-group"><label>英文名稱</label><input id="businessName" type="text"></div>
                    <div class="input-group"><label>中文名稱</label><input id="businessNameZh" type="text"></div>
                    <div class="input-group"><label>營業時間開始</label><input id="startTime" type="time"></div>
                    <div class="input-group"><label>營業時間結束</label><input id="endTime" type="time"></div>
                    <div class="input-group"><label>營業資訊 (中文)</label><input id="daysLabelZh" type="text" placeholder="每日營業"></div>
                    <div class="input-group"><label>營業資訊 (英文)</label><input id="daysLabelEn" type="text" placeholder="Open Daily"></div>
                </div>
            </div>
            <div class="section-card">
                <h3>價格設定</h3>
                <div class="form-grid two-columns">
                    <div class="input-group"><label>一般時段 (≤10人)</label><input id="normalUpTo10" type="number" min="0"></div>
                    <div class="input-group"><label>一般時段 (11-18人)</label><input id="normalUpTo18" type="number" min="0"></div>
                    <div class="input-group"><label>高峰時段 (≤10人)</label><input id="peakUpTo10" type="number" min="0"></div>
                    <div class="input-group"><label>高峰時段 (11-18人)</label><input id="peakUpTo18" type="number" min="0"></div>
                    <div class="input-group"><label>高峰時段適用星期 (以逗號分隔，例如 fri,sat,sun)</label><input id="peakDays" type="text"></div>
                    <div class="input-group"><label>高峰開始時間</label><input id="peakStart" type="time"></div>
                    <div class="input-group"><label>高峰結束時間</label><input id="peakEnd" type="time"></div>
                </div>
                <div style="margin-top:18px;"><button class="btn btn-primary" onclick="saveSettings()">儲存設定</button></div>
            </div>
        </div>
        <div id="instructionsTab" class="tab-content">
            <div class="section-card">
                <h3>預約須知內容</h3>
                <div class="form-grid two-columns">
                    <div class="input-group"><label>標題 (中文)</label><input id="titleZh" type="text"></div>
                    <div class="input-group"><label>標題 (英文)</label><input id="titleEn" type="text"></div>
                </div>
                <div class="form-grid two-columns" style="margin-top:18px;">
                    <div class="input-group"><label>步驟 1 (中文)</label><textarea id="instruction1Zh"></textarea></div>
                    <div class="input-group"><label>步驟 1 (英文)</label><textarea id="instruction1En"></textarea></div>
                    <div class="input-group"><label>步驟 2 (中文)</label><textarea id="instruction2Zh"></textarea></div>
                    <div class="input-group"><label>步驟 2 (英文)</label><textarea id="instruction2En"></textarea></div>
                    <div class="input-group"><label>步驟 3 (中文)</label><textarea id="instruction3Zh"></textarea></div>
                    <div class="input-group"><label>步驟 3 (英文)</label><textarea id="instruction3En"></textarea></div>
                    <div class="input-group"><label>步驟 4 (中文)</label><textarea id="instruction4Zh"></textarea></div>
                    <div class="input-group"><label>步驟 4 (英文)</label><textarea id="instruction4En"></textarea></div>
                    <div class="input-group"><label>步驟 5 (中文)</label><textarea id="instruction5Zh"></textarea></div>
                    <div class="input-group"><label>步驟 5 (英文)</label><textarea id="instruction5En"></textarea></div>
                    <div class="input-group"><label>步驟 6 (中文)</label><textarea id="instruction6Zh"></textarea></div>
                    <div class="input-group"><label>步驟 6 (英文)</label><textarea id="instruction6En"></textarea></div>
                </div>
                <div style="margin-top:18px;"><button class="btn btn-primary" onclick="saveInstructions()">儲存須知</button></div>
            </div>
        </div>
        <div id="itemsTab" class="tab-content">
            <div id="itemsMessage" class="message"></div>
            <div class="section-card">
                <h3>新增 / 編輯項目</h3>
                <form id="itemForm">
                    <input type="hidden" id="itemId">
                    <div class="form-grid two-columns">
                        <div class="input-group"><label>類型</label><select id="itemType"><option value="workshop_class">工作坊 / 課程</option><option value="room_rental">場地租用</option></select></div>
                        <div class="input-group"><label>名稱</label><input id="itemName" type="text" required></div>
                        <div class="input-group"><label>開始時間</label><input id="itemStart" type="datetime-local" required></div>
                        <div class="input-group"><label>結束時間</label><input id="itemEnd" type="datetime-local" required></div>
                        <div class="input-group"><label>時長 (分鐘)</label><input id="itemDuration" type="number" min="1" required></div>
                        <div class="input-group"><label>價錢 (每位或每節)</label><input id="itemPrice" type="number" min="0" step="1" required></div>
                        <div class="input-group"><label>導師名稱</label><input id="itemInstructor" type="text"></div>
                        <div class="input-group"><label>人數上限</label><input id="itemCapacity" type="number" min="1" required></div>
                    </div>
                    <div style="margin-top:18px;">
                        <button type="submit" class="btn btn-primary">儲存項目</button>
                        <button type="button" class="btn btn-secondary" onclick="resetItemForm()">清除</button>
                    </div>
                </form>
            </div>
            <div class="section-card">
                <h3>現有項目</h3>
                <div id="itemsList" class="item-list"></div>
            </div>
        </div>
    </div>
    <script>
        const API_BASE_URL = (() => {
            const DEFAULT_API_PATH = '/api';
            const DEFAULT_ORIGIN = (window.location.origin && window.location.origin !== 'null') ? window.location.origin : 'http://localhost:3000';
            const resolveUrl = (value) => { if (!value) return null; try { return new URL(value, DEFAULT_ORIGIN).toString().replace(/\/+$/, ''); } catch (error) { console.warn('Invalid API base URL:', value, error); return null; } };
            const params = new URLSearchParams(window.location.search);
            const queryOverride = params.get('apiBaseUrl') || params.get('api_base_url');
            if (queryOverride) {
                const url = resolveUrl(queryOverride);
                if (url) { try { localStorage.setItem('admin.apiBaseUrl', url); } catch {} return url; }
            }
            try { const stored = resolveUrl(localStorage.getItem('admin.apiBaseUrl')); if (stored) return stored; } catch {}
            return `${DEFAULT_ORIGIN}${DEFAULT_API_PATH}`.replace(/\/+$/, '');
        })();

        const DEV_AUTH_DISABLED = true; // Toggle to false to restore admin authentication
        function isAuthDisabled() { return DEV_AUTH_DISABLED; }

        let refreshIntervalId = null;
        let currentSettings = {};
        let currentItems = [];

        function updateAdminIdentity(isLoggedIn) {
            const el = document.getElementById('adminIdentity');
            if (!el) return;
            if (isLoggedIn) {
                el.textContent = isAuthDisabled()
                    ? '開發模式：已停用管理員驗證'
                    : '已使用共享管理密碼登入';
                el.style.display = 'block';
            } else {
                el.textContent = '';
                el.style.display = 'none';
            }
        }

        const HTML_ESCAPES = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#39;'
        };

        function escapeHtml(value) {
            if (value === null || value === undefined) return '';
            return value.toString().replace(/[&<>"']/g, (match) => HTML_ESCAPES[match] || match);
        }

        function setOverviewDateToToday() {
            const input = document.getElementById('overviewDate');
            if (!input || input.value) return;
            input.value = new Date().toISOString().split('T')[0];
        }

        function formatOverviewDateTime(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            if (Number.isNaN(date.getTime())) return '';
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            const hh = String(date.getHours()).padStart(2, '0');
            const mm = String(date.getMinutes()).padStart(2, '0');
            return `${y}-${m}-${d} ${hh}:${mm}`;
        }

        function formatOverviewTime(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            if (Number.isNaN(date.getTime())) return '';
            const hh = String(date.getHours()).padStart(2, '0');
            const mm = String(date.getMinutes()).padStart(2, '0');
            return `${hh}:${mm}`;
        }

        async function loadBookingOverview(date) {
            const targetDate = date || document.getElementById('overviewDate')?.value;
            if (!targetDate) return;
            try {
                const response = await fetch(`${API_BASE_URL}/admin/bookings/overview?date=${targetDate}`, { headers: authHeaders() });
                if (response.status === 401) return logout();
                const result = await response.json();
                if (response.ok) {
                    renderBookingOverview(result);
                } else {
                    showOverviewMessage('error', result.error || '無法載入概覽。');
                }
            } catch (error) {
                console.error('Error loading booking overview:', error);
                showOverviewMessage('error', '無法載入概覽，請稍後再試。');
            }
        }

        function renderBookingOverview(data) {
            const studioList = document.getElementById('overviewStudioList');
            const classList = document.getElementById('overviewClassList');
            const messageEl = document.getElementById('overviewMessage');
            if (messageEl) { messageEl.style.display = 'none'; }
            if (!studioList || !classList) return;
            studioList.innerHTML = '';
            classList.innerHTML = '';

            const studioSessions = Array.isArray(data.studioSessions) ? data.studioSessions : [];
            if (studioSessions.length === 0) {
                studioList.innerHTML = '<div class="overview-empty">當日暫無場地預約。</div>';
            } else {
                studioSessions.forEach(session => {
                    const card = document.createElement('div');
                    card.className = 'overview-card';
                    const timeLabel = `${session.startTime || ''} - ${session.endTime || ''}`.trim();
                    const notesRow = session.notes ? `<div>備註：${escapeHtml(session.notes)}</div>` : '';
                    card.innerHTML = `
                        <h4>${escapeHtml(timeLabel)}</h4>
                        <div class="overview-meta">
                            <div>預約編號：${escapeHtml(session.bookingId)}</div>
                            <div>${escapeHtml(session.customerName || '—')}｜${escapeHtml(String(session.peopleCount || 0))} 人</div>
                            <div>狀態：${escapeHtml(session.status || '')}</div>
                            <div>${escapeHtml(session.email || '')}<br>${escapeHtml(session.phone || '')}</div>
                            ${notesRow}
                        </div>
                    `;
                    studioList.appendChild(card);
                });
            }

            const classSessions = Array.isArray(data.classSessions) ? data.classSessions : [];
            if (classSessions.length === 0) {
                classList.innerHTML = '<div class="overview-empty">當日暫無課程預約。</div>';
            } else {
                classSessions.forEach(cls => {
                    const card = document.createElement('div');
                    card.className = 'overview-card';
                    const startLabel = formatOverviewDateTime(cls.startDateTime);
                    const endLabel = formatOverviewTime(cls.endDateTime);
                    const scheduleLabel = endLabel ? `${startLabel} - ${endLabel}` : startLabel;
                    const descriptionRow = cls.description ? `<div style="margin-top:6px;">${escapeHtml(cls.description)}</div>` : '';
                    const attendees = Array.isArray(cls.attendees) ? cls.attendees : [];
                    const attendeesRows = attendees.map(att => {
                        return `<div>• ${escapeHtml(att.customerName || '—')}｜${escapeHtml(String(att.peopleCount || 0))} 人｜${escapeHtml(att.status || '')}</div>`;
                    }).join('');
                    const attendeesHtml = attendees.length === 0
                        ? '<div class="overview-empty" style="margin-top:10px;">尚未有參加者。</div>'
                        : `<div class="overview-attendees">${attendeesRows}</div>`;
                    card.innerHTML = `
                        <h4>${escapeHtml(cls.name)}</h4>
                        <div class="overview-meta">
                            <div>${escapeHtml(scheduleLabel)}</div>
                            ${cls.instructorName ? `<div>導師：${escapeHtml(cls.instructorName)}</div>` : ''}
                        </div>
                        <div class="overview-meta" style="margin-top:6px;">
                            <div>報名：${escapeHtml(String(cls.totalParticipants || 0))} / ${escapeHtml(String(cls.capacity || 0))}（剩餘 ${escapeHtml(String(cls.seatsRemaining || 0))}）</div>
                            ${descriptionRow}
                        </div>
                        ${attendeesHtml}
                    `;
                    classList.appendChild(card);
                });
            }
        }

        function refreshOverview() {
            const date = document.getElementById('overviewDate')?.value;
            loadBookingOverview(date);
        }

        function showOverviewMessage(type, message) {
            showMessage('overviewMessage', type, message);
        }

        document.addEventListener('DOMContentLoaded', async () => {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.addEventListener('click', handleTabClick));
            document.getElementById('itemForm').addEventListener('submit', submitItemForm);
            const passwordForm = document.getElementById('passwordForm');
            if (passwordForm) {
                passwordForm.addEventListener('submit', handlePasswordChange);
            }

            setOverviewDateToToday();
            const overviewDateInput = document.getElementById('overviewDate');
            if (overviewDateInput) {
                overviewDateInput.addEventListener('change', () => loadBookingOverview(overviewDateInput.value));
            }

            const token = sessionStorage.getItem('adminToken');
            const expiry = sessionStorage.getItem('adminTokenExpiry');
            if (token && (!expiry || new Date(expiry) > new Date())) {
                showAdminPanel();
                return;
            }

            const loginResult = await performAdminLogin();
            if (!loginResult.success) {
                console.error('Automatic admin login failed:', loginResult.error);
                showAdminPanel();
            }
        });

        function authHeaders() {
            const token = sessionStorage.getItem('adminToken');
            return token ? { 'Authorization': `Bearer ${token}` } : {};
        }

        async function performAdminLogin(password = '') {
            try {
                const payload = isAuthDisabled() ? {} : { password };
                const response = await fetch(`${API_BASE_URL}/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json().catch(() => ({}));

                if (response.ok && result.success) {
                    if (result.token) {
                        sessionStorage.setItem('adminToken', result.token);
                    }
                    if (result.expiresAt) {
                        sessionStorage.setItem('adminTokenExpiry', result.expiresAt);
                    } else {
                        sessionStorage.removeItem('adminTokenExpiry');
                    }
                    showAdminPanel();
                    return { success: true, result };
                }

                return {
                    success: false,
                    error: (result && result.error) || '登入失敗，請稍後再試。'
                };
            } catch (error) {
                console.error('Login error:', error);
                return {
                    success: false,
                    error: '無法登入，請稍後再試。'
                };
            }
        }

        function showAdminPanel() {
            document.getElementById('adminContainer').style.display = 'block';
            updateAdminIdentity(true);
            const passwordMsg = document.getElementById('passwordMessage');
            if (passwordMsg) { passwordMsg.style.display = 'none'; passwordMsg.textContent = ''; }
            const passwordForm = document.getElementById('passwordForm');
            if (passwordForm) passwordForm.reset();
            setOverviewDateToToday();
            loadBookingOverview(document.getElementById('overviewDate')?.value);
            loadStats();
            loadBookings();
            loadSettings();
            loadInstructions();
            loadItems();
            if (refreshIntervalId) clearInterval(refreshIntervalId);
            refreshIntervalId = setInterval(() => {
                loadStats();
                loadBookings();
                loadBookingOverview(document.getElementById('overviewDate')?.value);
            }, 30000);
        }

        function logout() {
            sessionStorage.removeItem('adminToken');
            sessionStorage.removeItem('adminTokenExpiry');
            if (refreshIntervalId) clearInterval(refreshIntervalId);
            const adminContainer = document.getElementById('adminContainer');
            if (adminContainer) adminContainer.style.display = 'none';
            const studioList = document.getElementById('overviewStudioList');
            const classList = document.getElementById('overviewClassList');
            const overviewMsg = document.getElementById('overviewMessage');
            if (studioList) studioList.innerHTML = '';
            if (classList) classList.innerHTML = '';
            if (overviewMsg) { overviewMsg.style.display = 'none'; overviewMsg.textContent = ''; }
            const passwordForm = document.getElementById('passwordForm');
            if (passwordForm) passwordForm.reset();
            const passwordMsg = document.getElementById('passwordMessage');
            if (passwordMsg) { passwordMsg.style.display = 'none'; passwordMsg.textContent = ''; }
            updateAdminIdentity(false);
            performAdminLogin().then(result => {
                if (!result?.success) {
                    console.error('Automatic admin login after logout failed:', result?.error);
                    showAdminPanel();
                }
            });
        }

        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE_URL}/stats`, { headers: authHeaders() });
                if (response.status === 401) return logout();
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('stat-total').querySelector('p').textContent = stats.total;
                    document.getElementById('stat-confirmed').querySelector('p').textContent = stats.confirmed;
                    document.getElementById('stat-pending').querySelector('p').textContent = stats.pending;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadBookings() {
            try {
                const response = await fetch(`${API_BASE_URL}/bookings`, { headers: authHeaders() });
                if (response.status === 401) return logout();
                if (response.ok) {
                    const bookings = await response.json();
                    renderBookings(bookings);
                }
            } catch (error) {
                console.error('Error loading bookings:', error);
            }
        }

        function renderBookings(bookings) {
            const tbody = document.getElementById('bookingsTable');
            tbody.innerHTML = '';
            if (!bookings || bookings.length === 0) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 7;
                cell.style.textAlign = 'center';
                cell.textContent = '暫無預約資料';
                row.appendChild(cell);
                tbody.appendChild(row);
                return;
            }
            bookings.forEach(booking => {
                const row = document.createElement('tr');
                const itemsHtml = (booking.items || []).map(item => `<div><strong>${item.itemType === 'workshop_class' ? '課程' : '場地'}:</strong> ${item.date} ${item.startTime}-${item.endTime} (${item.peopleCount}人)</div>`).join('');
                row.innerHTML = `
                    <td>${booking.id}</td>
                    <td>${booking.customerName}<br><small>${booking.email}<br>${booking.phone}</small></td>
                    <td>${itemsHtml || '—'}</td>
                    <td>${booking.totalPeople || 0}</td>
                    <td>HK$${Number(booking.totalPrice || 0).toFixed(2)}</td>
                    <td><span class="status-chip status-${booking.status}">${booking.status}</span></td>
                    <td>
                        <button class="btn btn-secondary" onclick="updateBookingStatus('${booking.id}','confirmed')">確認</button>
                        <button class="btn btn-secondary" onclick="updateBookingStatus('${booking.id}','pending')">待處理</button>
                        <button class="btn btn-danger" onclick="updateBookingStatus('${booking.id}','cancelled')">取消</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function updateBookingStatus(id, status) {
            try {
                const response = await fetch(`${API_BASE_URL}/bookings/${id}/status`, { method: 'PATCH', headers: { 'Content-Type': 'application/json', ...authHeaders() }, body: JSON.stringify({ status }) });
                if (response.status === 401) return logout();
                const result = await response.json();
                if (response.ok) {
                    showMessage('bookingsMessage', 'success', result.message || '更新成功');
                    loadBookings();
                } else {
                    showMessage('bookingsMessage', 'error', result.error || '更新失敗');
                }
            } catch (error) {
                console.error('Error updating booking status:', error);
                showMessage('bookingsMessage', 'error', '更新失敗，請稍後再試');
            }
        }

        async function loadSettings() {
            try {
                const response = await fetch(`${API_BASE_URL}/settings`, { headers: authHeaders() });
                if (response.status === 401) return logout();
                if (response.ok) {
                    currentSettings = await response.json();
                    populateSettings();
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        function populateSettings() {
            document.getElementById('businessName').value = currentSettings.businessName || '';
            document.getElementById('businessNameZh').value = currentSettings.businessNameZh || '';
            document.getElementById('startTime').value = currentSettings.operatingHours?.startTime || '07:00';
            document.getElementById('endTime').value = currentSettings.operatingHours?.endTime || '22:00';
            document.getElementById('daysLabelZh').value = currentSettings.operatingHours?.daysLabelZh || '';
            document.getElementById('daysLabelEn').value = currentSettings.operatingHours?.daysLabelEn || '';
            document.getElementById('normalUpTo10').value = currentSettings.pricing?.normalUpTo10 || '';
            document.getElementById('normalUpTo18').value = currentSettings.pricing?.normalUpTo18 || '';
            document.getElementById('peakUpTo10').value = currentSettings.pricing?.peakUpTo10 || '';
            document.getElementById('peakUpTo18').value = currentSettings.pricing?.peakUpTo18 || '';
            const peakSchedule = currentSettings.pricing?.peakSchedule || {};
            document.getElementById('peakDays').value = Array.isArray(peakSchedule.days) ? peakSchedule.days.join(',') : '';
            document.getElementById('peakStart').value = peakSchedule.startTime || '';
            document.getElementById('peakEnd').value = peakSchedule.endTime || '';
        }

        async function saveSettings() {
            const payload = {
                ...currentSettings,
                businessName: document.getElementById('businessName').value,
                businessNameZh: document.getElementById('businessNameZh').value,
                operatingHours: {
                    ...(currentSettings.operatingHours || {}),
                    startTime: document.getElementById('startTime').value,
                    endTime: document.getElementById('endTime').value,
                    daysLabelZh: document.getElementById('daysLabelZh').value,
                    daysLabelEn: document.getElementById('daysLabelEn').value
                },
                pricing: {
                    ...(currentSettings.pricing || {}),
                    normalUpTo10: Number(document.getElementById('normalUpTo10').value),
                    normalUpTo18: Number(document.getElementById('normalUpTo18').value),
                    peakUpTo10: Number(document.getElementById('peakUpTo10').value),
                    peakUpTo18: Number(document.getElementById('peakUpTo18').value),
                    peakSchedule: {
                        days: document.getElementById('peakDays').value.split(',').map(v => v.trim()).filter(Boolean),
                        startTime: document.getElementById('peakStart').value,
                        endTime: document.getElementById('peakEnd').value
                    }
                }
            };
            try {
                const response = await fetch(`${API_BASE_URL}/settings`, { method: 'PUT', headers: { 'Content-Type': 'application/json', ...authHeaders() }, body: JSON.stringify(payload) });
                if (response.status === 401) return logout();
                if (response.ok) {
                    currentSettings = (await response.json()).settings || payload;
                    showMessage('settingsMessage', 'success', '設定已更新');
                } else {
                    const result = await response.json();
                    showMessage('settingsMessage', 'error', result.error || '儲存失敗');
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                showMessage('settingsMessage', 'error', '儲存失敗，請稍後再試');
            }
        }

        async function handlePasswordChange(event) {
            event.preventDefault();
            if (isAuthDisabled()) {
                showMessage('passwordMessage', 'success', '開發模式：目前已停用管理密碼驗證。');
                event.target.reset();
                return;
            }
            const current = document.getElementById('currentAdminPassword').value;
            const nextPassword = document.getElementById('newAdminPassword').value;
            const confirmPassword = document.getElementById('confirmAdminPassword').value;

            if (!current || !nextPassword || !confirmPassword) {
                showMessage('passwordMessage', 'error', '請填寫所有欄位');
                return;
            }

            if (nextPassword !== confirmPassword) {
                showMessage('passwordMessage', 'error', '新密碼與確認密碼不一致');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/admin/change-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ currentPassword: current, newPassword: nextPassword })
                });
                const result = await response.json().catch(() => ({}));

                if (response.status === 401) {
                    showMessage('passwordMessage', 'error', result.error || '驗證失敗，請重新登入');
                    setTimeout(() => logout(), 1500);
                    return;
                }

                if (response.ok && result.success) {
                    showMessage('passwordMessage', 'success', '密碼已更新，請重新登入');
                    event.target.reset();
                    setTimeout(() => {
                        logout();
                    }, 1500);
                } else {
                    showMessage('passwordMessage', 'error', result.error || '更新失敗，請稍後再試');
                }
            } catch (error) {
                console.error('Error changing password:', error);
                showMessage('passwordMessage', 'error', '更新失敗，請稍後再試');
            }
        }

        async function loadInstructions() {
            try {
                const response = await fetch(`${API_BASE_URL}/settings`);
                if (response.ok) {
                    const settings = await response.json();
                    const instructions = settings.bookingInstructions || {};
                    document.getElementById('titleZh').value = instructions.titleZh || '';
                    document.getElementById('titleEn').value = instructions.titleEn || '';
                    for (let i = 1; i <= 6; i++) {
                        document.getElementById(`instruction${i}Zh`).value = instructions[`instruction${i}Zh`] || '';
                        document.getElementById(`instruction${i}En`).value = instructions[`instruction${i}En`] || '';
                    }
                }
            } catch (error) {
                console.error('Error loading instructions:', error);
            }
        }

        async function saveInstructions() {
            const bookingInstructions = { titleZh: document.getElementById('titleZh').value, titleEn: document.getElementById('titleEn').value };
            for (let i = 1; i <= 6; i++) {
                bookingInstructions[`instruction${i}Zh`] = document.getElementById(`instruction${i}Zh`).value;
                bookingInstructions[`instruction${i}En`] = document.getElementById(`instruction${i}En`).value;
            }
            const payload = { ...currentSettings, bookingInstructions };
            try {
                const response = await fetch(`${API_BASE_URL}/settings`, { method: 'PUT', headers: { 'Content-Type': 'application/json', ...authHeaders() }, body: JSON.stringify(payload) });
                if (response.status === 401) return logout();
                if (response.ok) {
                    currentSettings = (await response.json()).settings || payload;
                    showMessage('settingsMessage', 'success', '須知已更新');
                } else {
                    showMessage('settingsMessage', 'error', '儲存失敗');
                }
            } catch (error) {
                console.error('Error saving instructions:', error);
                showMessage('settingsMessage', 'error', '儲存失敗');
            }
        }

        async function loadItems() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/items`, { headers: authHeaders() });
                if (response.status === 401) return logout();
                if (response.ok) {
                    currentItems = await response.json();
                    renderItems();
                }
            } catch (error) {
                console.error('Error loading items:', error);
            }
        }

        function renderItems() {
            const container = document.getElementById('itemsList');
            container.innerHTML = '';
            if (!currentItems || currentItems.length === 0) {
                const empty = document.createElement('div');
                empty.style.color = '#516273';
                empty.textContent = '目前沒有項目';
                container.appendChild(empty);
                return;
            }
            currentItems.forEach(item => {
                const card = document.createElement('div');
                card.className = 'item-card';
                const start = new Date(item.startDateTime);
                const end = new Date(item.endDateTime);
                card.innerHTML = `
                    <h4>${item.name} <small>(${item.type === 'workshop_class' ? '課程' : '場地'})</small></h4>
                    <small>${formatDateTime(start)} - ${formatTime(end)}</small>
                    <small>時長：${item.duration} 分鐘｜價錢：HK$${Number(item.price || 0).toFixed(2)}</small>
                    <small>導師：${item.instructorName || '—'}｜容量：${item.capacity}</small>
                    <small>剩餘名額：${Math.max((item.availableCapacity ?? item.capacity), 0)}</small>
                `;
                const actions = document.createElement('div');
                actions.className = 'item-actions';
                const editBtn = document.createElement('button');
                editBtn.className = 'btn btn-secondary';
                editBtn.textContent = '編輯';
                editBtn.addEventListener('click', () => editItem(item));
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger';
                deleteBtn.textContent = '刪除';
                deleteBtn.addEventListener('click', () => deleteItem(item.id));
                actions.appendChild(editBtn);
                actions.appendChild(deleteBtn);
                card.appendChild(actions);
                container.appendChild(card);
            });
        }

        function formatDateTime(date) { return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')} ${formatTime(date)}`; }
        function formatTime(date) { return `${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`; }

        async function submitItemForm(e) {
            e.preventDefault();
            const id = document.getElementById('itemId').value;
            const payload = {
                type: document.getElementById('itemType').value,
                name: document.getElementById('itemName').value,
                startDateTime: document.getElementById('itemStart').value,
                endDateTime: document.getElementById('itemEnd').value,
                duration: Number(document.getElementById('itemDuration').value),
                price: Number(document.getElementById('itemPrice').value),
                instructorName: document.getElementById('itemInstructor').value,
                capacity: Number(document.getElementById('itemCapacity').value)
            };
            try {
                const method = id ? 'PUT' : 'POST';
                const endpoint = id ? `${API_BASE_URL}/admin/items/${id}` : `${API_BASE_URL}/admin/items`;
                const response = await fetch(endpoint, { method, headers: { 'Content-Type': 'application/json', ...authHeaders() }, body: JSON.stringify(payload) });
                if (response.status === 401) return logout();
                if (response.ok) {
                    showItemsMessage('success', '項目已儲存');
                    resetItemForm();
                    loadItems();
                } else {
                    const result = await response.json();
                    showItemsMessage('error', result.error || '儲存失敗');
                }
            } catch (error) {
                console.error('Error saving item:', error);
                showItemsMessage('error', '儲存失敗，請稍後再試');
            }
        }

        function editItem(item) {
            document.getElementById('itemId').value = item.id;
            document.getElementById('itemType').value = item.type;
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemStart').value = item.startDateTime ? item.startDateTime.slice(0,16) : '';
            document.getElementById('itemEnd').value = item.endDateTime ? item.endDateTime.slice(0,16) : '';
            document.getElementById('itemDuration').value = item.duration || '';
            document.getElementById('itemPrice').value = item.price || '';
            document.getElementById('itemInstructor').value = item.instructorName || '';
            document.getElementById('itemCapacity').value = item.capacity || '';
        }

        function resetItemForm() {
            document.getElementById('itemId').value = '';
            document.getElementById('itemForm').reset();
        }

        async function deleteItem(id) {
            if (!confirm('確定要刪除此項目？')) return;
            try {
                const response = await fetch(`${API_BASE_URL}/admin/items/${id}`, { method: 'DELETE', headers: authHeaders() });
                if (response.status === 401) return logout();
                if (response.ok) {
                    showItemsMessage('success', '項目已刪除');
                    loadItems();
                } else {
                    const result = await response.json();
                    showItemsMessage('error', result.error || '刪除失敗');
                }
            } catch (error) {
                console.error('Error deleting item:', error);
                showItemsMessage('error', '刪除失敗');
            }
        }

        function showItemsMessage(type, message) { showMessage('itemsMessage', type, message); }

        function showMessage(elementId, type, message) {
            const el = document.getElementById(elementId);
            if (!el) return;
            el.className = `message ${type}`;
            el.textContent = message;
            el.style.display = 'block';
            setTimeout(() => { el.style.display = 'none'; }, 4000);
        }

        function handleTabClick(event) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            const targetId = event.target.dataset.tab;
            document.getElementById(targetId).classList.add('active');
            if (targetId === 'overviewTab') {
                setOverviewDateToToday();
                loadBookingOverview(document.getElementById('overviewDate')?.value);
            }
        }
    </script>
</body>
</html>
