<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Studio Booking</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* FullCalendar Override */
        .fc-event {
            cursor: pointer;
        }
    </style>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <style>
        :root {
            --brand-primary: #0f172a;
            --brand-secondary: #3b82f6;
            --surface: #f8fafc;
            --surface-alt: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --accent: #10b981;
            --danger: #ef4444;
            --border: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', Roboto, sans-serif;
            background: var(--surface);
            min-height: 100vh;
            padding: 32px;
            color: var(--text-main);
            line-height: 1.5;
        }

        a {
            color: var(--brand-secondary);
            text-decoration: none;
        }

        .admin-container {
            max-width: 1280px;
            margin: 0 auto;
            display: block;
        }

        .admin-header {
            background: var(--surface-alt);
            border-radius: 20px;
            padding: 32px;
            margin-bottom: 32px;
            box-shadow: var(--shadow);
            position: relative;
            border: 1px solid var(--border);
        }

        .logout-btn {
            position: absolute;
            top: 24px;
            right: 24px;
            padding: 10px 18px;
            background: transparent;
            color: var(--danger);
            border: 1px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
        }

        .logout-btn:hover {
            background: #fef2f2;
            border-color: #fecaca;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
            padding-bottom: 8px;
        }

        .tab-btn {
            padding: 10px 20px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            color: var(--brand-secondary);
            background: #eff6ff;
        }

        .tab-btn.active {
            color: var(--brand-secondary);
            background: #eff6ff;
            box-shadow: var(--shadow-sm);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section-card {
            background: var(--surface-alt);
            border-radius: 20px;
            padding: 32px;
            margin-bottom: 32px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .section-card h3 {
            color: var(--brand-primary);
            margin-bottom: 24px;
            font-size: 1.4em;
            font-weight: 700;
            letter-spacing: -0.025em;
        }

        .form-grid {
            display: grid;
            gap: 24px;
        }

        @media (min-width: 860px) {
            .form-grid.two-columns {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-main);
            font-size: 0.9em;
        }

        .input-group input,
        .input-group textarea,
        .input-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 1em;
            background: #fff;
            color: var(--text-main);
            transition: all 0.2s;
            box-shadow: var(--shadow-sm);
        }

        .input-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .input-group input:focus,
        .input-group textarea:focus,
        .input-group select:focus {
            border-color: var(--brand-secondary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            letter-spacing: 0.3px;
            transition: all 0.2s;
            box-shadow: var(--shadow-sm);
        }

        .btn-primary {
            background: var(--brand-primary);
            color: #fff;
        }

        .btn-primary:hover {
            background: var(--brand-secondary);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .btn-secondary {
            background: #fff;
            color: var(--text-main);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            border-color: var(--brand-secondary);
            color: var(--brand-secondary);
        }

        .btn-danger {
            background: #fee2e2;
            color: var(--danger);
        }

        .btn-danger:hover {
            background: var(--danger);
            color: #fff;
        }

        .btn+.btn {
            margin-left: 10px;
        }

        .status-chip {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }

        .status-confirmed {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .status-cancelled {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        th,
        td {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            text-align: left;
            vertical-align: middle;
        }

        th {
            background: #f8fafc;
            color: var(--text-muted);
            font-weight: 600;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover td {
            background: #f8fafc;
        }

        .message {
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 24px;
            display: none;
            font-weight: 500;
        }

        .message.success {
            background: #ecfdf5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .message.error {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .item-list {
            display: grid;
            gap: 20px;
        }

        @media (min-width: 900px) {
            .item-list {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        .item-card {
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            background: #fff;
            display: flex;
            flex-direction: column;
            gap: 12px;
            transition: all 0.2s;
            box-shadow: var(--shadow-sm);
        }

        .item-card:hover {
            border-color: var(--brand-secondary);
            box-shadow: var(--shadow);
        }

        .item-card h4 {
            color: var(--brand-primary);
            font-size: 1.1em;
            font-weight: 700;
        }

        .item-card small {
            color: var(--text-muted);
        }

        .item-actions {
            margin-top: 16px;
            display: flex;
            gap: 12px;
        }

        .stat-grid {
            display: grid;
            gap: 20px;
            margin-bottom: 24px;
        }

        @media (min-width: 720px) {
            .stat-grid {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
        }

        .stat-card {
            background: #fff;
            color: var(--text-main);
            padding: 24px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        .stat-card::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 6px;
            background: var(--brand-secondary);
        }

        .stat-card h4 {
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 8px;
            color: var(--text-muted);
        }

        .stat-card p {
            font-size: 2.2em;
            font-weight: 800;
            color: var(--brand-primary);
        }

        .overview-grid {
            display: grid;
            gap: 24px;
            margin-top: 24px;
        }

        @media (min-width: 900px) {
            .overview-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        .overview-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .overview-card {
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            box-shadow: var(--shadow-sm);
        }

        .overview-card h4 {
            color: var(--brand-primary);
            margin-bottom: 8px;
        }

        .overview-meta {
            color: var(--text-muted);
            font-size: 0.9em;
            line-height: 1.6;
        }

        .overview-attendees {
            margin-top: 12px;
            padding-left: 16px;
            color: var(--text-muted);
            font-size: 0.9em;
            border-left: 2px solid var(--border);
        }

        .overview-empty {
            padding: 24px;
            border: 2px dashed var(--border);
            border-radius: 16px;
            color: var(--text-muted);
            background: #f8fafc;
            font-size: 0.95em;
            text-align: center;
        }

        /* Modal - Reuse logic */
        /* Modal - Reuse logic */
        #loginModal {
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
        }

        #loginModal.active {
            display: flex !important;
        }

        /* Role Based UI */
        body.role-receptionist .btn-danger {
            display: none !important;
        }
    </style>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
</head>

<body>
    <div id="adminContainer" class="admin-container">
        <div class="admin-header">
            <h1 style="color:#0b4f6c; font-size:2.2em;">Studio Booking ç®¡ç†é¢æ¿</h1>
            <p style="color:#52606d;">å¿«é€Ÿç®¡ç†é ç´„ã€è¨­å®šã€èª²ç¨‹èˆ‡å ´åœ°è³‡è¨Šã€‚</p>
            <p id="adminIdentity" style="color:#52606d; font-size:0.95em; margin-top:6px; display:none;"></p>
            <div id="apiStatusMessage" class="message" style="margin-top:12px;"></div>
            <button class="logout-btn" onclick="logout()">ç™»å‡º</button>
            <div class="stat-grid">
                <div class="stat-card" id="stat-total">
                    <h4>ç¸½é ç´„æ•¸</h4>
                    <p>0</p>
                </div>
                <div class="stat-card" style="background:linear-gradient(135deg,#43e97b 0%,#38f9d7 100%);"
                    id="stat-confirmed">
                    <h4>å·²ç¢ºèª</h4>
                    <p>0</p>
                </div>
                <div class="stat-card" style="background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);"
                    id="stat-pending">
                    <h4>å¾…è™•ç†</h4>
                    <p>0</p>
                </div>
            </div>
        </div>
        <div class="tabs">
            <button class="tab-btn active" data-tab="bookingsTab">é ç´„åˆ—è¡¨</button>
            <button class="tab-btn" data-tab="calendarTab">è¡Œäº‹æ›†</button>
            <button class="tab-btn" data-tab="overviewTab">é ç´„æ¦‚è¦½</button>
            <button class="tab-btn" data-tab="settingsTab">ç³»çµ±è¨­å®š</button>
            <button class="tab-btn" data-tab="instructionsTab">é ç´„é ˆçŸ¥</button>
            <button class="tab-btn" data-tab="itemsTab">èª²ç¨‹ / å ´åœ°é …ç›®</button>
        </div>
        <div id="calendarTab" class="tab-content">
            <div class="section-card">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;">
                    <h3>è¡Œäº‹æ›†æª¢è¦–</h3>
                    <div>
                        <span class="status-chip status-confirmed">é»æ“Šç©ºæ ¼å¿«é€Ÿå°é–æ™‚æ®µ</span>
                    </div>
                </div>
                <div id='calendar'></div>
            </div>
        </div>
        <div id="bookingsTab" class="tab-content active">
            <div class="section-card">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;">
                    <h3>å ´åœ°é ç´„</h3>
                    <button class="btn btn-secondary" onclick="exportCsv()">åŒ¯å‡ºæœˆå ±è¡¨ (CSV)</button>
                </div>
                <div id="bookingsMessage" class="message"></div>
                <div style="overflow-x:auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>é ç´„ç·¨è™Ÿ</th>
                                <th>å®¢æˆ¶ / è¯çµ¡</th>
                                <th>é …ç›®</th>
                                <th>ç¸½äººæ•¸</th>
                                <th>ç¸½é‡‘é¡</th>
                                <th>ç‹€æ…‹</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="bookingsTable"></tbody>
                    </table>
                </div>
            </div>
            <div class="section-card">
                <h3>èª²ç¨‹é ç´„</h3>
                <div id="classBookingsMessage" class="message"></div>
                <div style="overflow-x:auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>é ç´„ç·¨è™Ÿ</th>
                                <th>èª²ç¨‹è³‡è¨Š</th>
                                <th>å®¢æˆ¶ / è¯çµ¡</th>
                                <th>äººæ•¸</th>
                                <th>ç‹€æ…‹</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="classBookingsTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div id="overviewTab" class="tab-content">
            <div class="section-card">
                <h3>é ç´„æ¦‚è¦½</h3>
                <div class="form-grid two-columns">
                    <div class="input-group">
                        <label>é¸æ“‡æ—¥æœŸ</label>
                        <input type="date" id="overviewDate">
                    </div>
                    <div class="input-group" style="display:flex;align-items:flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="refreshOverview()">é‡æ–°æ•´ç†</button>
                    </div>
                </div>
                <div id="overviewMessage" class="message"></div>
                <div class="overview-grid">
                    <div class="overview-column">
                        <h4 style="color:#145da0;">å ´åœ°é ç´„</h4>
                        <div id="overviewStudioList" class="overview-list"></div>
                    </div>
                    <div class="overview-column">
                        <h4 style="color:#145da0;">èª²ç¨‹é ç´„</h4>
                        <div id="overviewClassList" class="overview-list"></div>
                    </div>
                </div>
            </div>
        </div>
        <div id="settingsTab" class="tab-content">
            <div id="settingsMessage" class="message"></div>
            <div class="section-card">
                <h3>ç®¡ç†å¯†ç¢¼</h3>
                <div id="passwordMessage" class="message"></div>
                <form id="passwordForm" class="form-grid">
                    <div class="input-group">
                        <label>ç›®å‰å¯†ç¢¼</label>
                        <input type="password" id="currentAdminPassword" autocomplete="current-password" required>
                    </div>
                    <div class="input-group">
                        <label>æ–°å¯†ç¢¼</label>
                        <input type="password" id="newAdminPassword" autocomplete="new-password" required>
                    </div>
                    <div class="input-group">
                        <label>ç¢ºèªæ–°å¯†ç¢¼</label>
                        <input type="password" id="confirmAdminPassword" autocomplete="new-password" required>
                    </div>
                    <div>
                        <button type="submit" class="btn btn-primary">æ›´æ–°å¯†ç¢¼</button>
                    </div>
                </form>
            </div>
            <div class="section-card">
                <h3>åŸºæœ¬è³‡æ–™</h3>
                <div class="form-grid two-columns">
                    <div class="input-group"><label>è‹±æ–‡åç¨±</label><input id="businessName" type="text"></div>
                    <div class="input-group"><label>ä¸­æ–‡åç¨±</label><input id="businessNameZh" type="text"></div>
                    <div class="input-group"><label>ç‡Ÿæ¥­æ™‚é–“é–‹å§‹</label><input id="startTime" type="time"></div>
                    <div class="input-group"><label>ç‡Ÿæ¥­æ™‚é–“çµæŸ</label><input id="endTime" type="time"></div>
                    <div class="input-group"><label>ç‡Ÿæ¥­è³‡è¨Š (ä¸­æ–‡)</label><input id="daysLabelZh" type="text"
                            placeholder="æ¯æ—¥ç‡Ÿæ¥­"></div>
                    <div class="input-group"><label>ç‡Ÿæ¥­è³‡è¨Š (è‹±æ–‡)</label><input id="daysLabelEn" type="text"
                            placeholder="Open Daily"></div>
                </div>
                <div class="form-grid two-columns" style="margin-top:18px;">
                    <div class="input-group"><label>è‹±æ–‡ä»‹ç´¹</label><textarea id="businessDescription" rows="3"></textarea>
                    </div>
                    <div class="input-group"><label>ä¸­æ–‡ä»‹ç´¹</label><textarea id="businessDescriptionZh"
                            rows="3"></textarea></div>
                </div>
            </div>
            <!-- Interface Settings -->
            <div class="section-card">
                <h3>ğŸ¨ ä»‹é¢èˆ‡å¤–è§€ (Interface)</h3>
                <h4 style="color:var(--brand-primary); margin-top:16px; margin-bottom:12px;">é¦–é æ©«å¹… (Hero Section)</h4>
                <div class="form-grid two-columns">
                    <div class="input-group">
                        <label>æ¨™é¡Œ (Title) - ZH</label>
                        <input id="uiHeroTitleZh" type="text" placeholder="ä¾‹å¦‚: 24å°æ™‚è‡ªåŠ©é ç´„">
                    </div>
                    <div class="input-group">
                        <label>å‰¯æ¨™é¡Œ (Subtitle) - ZH</label>
                        <input id="uiHeroSubtitleZh" type="text" placeholder="ä¾‹å¦‚: è¼•é¬†é ç´„æ‚¨çš„å°ˆå±¬ç©ºé–“">
                    </div>
                </div>

                <h4 style="color:var(--brand-primary); margin-top:20px; margin-bottom:12px;">å…¨ç«™å…¬å‘Š (Announcement)</h4>
                <div class="form-grid">
                    <div class="input-group">
                        <label>å…¬å‘Šå…§å®¹</label>
                        <input id="uiAnnouncementText" type="text" placeholder="ä¾‹å¦‚: ç³»çµ±ç¶­è­·é€šçŸ¥...">
                    </div>
                    <div class="input-group">
                        <label class="checkbox-label" style="justify-content:flex-start; margin-top:8px;">
                            <input type="checkbox" id="uiAnnouncementActive"> é¡¯ç¤ºå…¬å‘Š
                        </label>
                    </div>
                </div>

                <h4 style="color:var(--brand-primary); margin-top:20px; margin-bottom:12px;">å“ç‰Œè‰²ç³» (Theme)</h4>
                <div class="form-grid two-columns">
                    <div class="input-group">
                        <label>ä¸»è‰² (Primary Color)</label>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <input id="uiPrimaryColor" type="color" value="#3b82f6"
                                style="height:40px; width:60px; padding:0; border:none; background:none;">
                            <span id="uiPrimaryColorValue" style="color:#666;">#3b82f6</span>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>é å°¾æ–‡å­— (Footer)</label>
                        <input id="uiFooterText" type="text" placeholder="Â© 2024 Your Studio">
                    </div>
                </div>
            </div>

            <div class="section-card">
                <h3>è¯çµ¡è³‡è¨Š</h3>
                <div class="form-grid two-columns">
                    <div class="input-group"><label>WhatsApp</label><input id="contactWhatsapp" type="text"></div>
                    <div class="input-group"><label>é›»è©±</label><input id="contactPhone" type="text"></div>
                    <div class="input-group"><label>Email</label><input id="contactEmail" type="email"></div>
                </div>
            </div>
            <div class="section-card">
                <h3>ä»˜æ¬¾æ–¹å¼</h3>
                <div class="form-grid two-columns">
                    <div class="input-group"><label>éŠ€è¡Œè½‰å¸³å•Ÿç”¨</label><select id="paymentBankEnabled">
                            <option value="true">å•Ÿç”¨</option>
                            <option value="false">åœç”¨</option>
                        </select></div>
                    <div class="input-group"><label>PayMe å•Ÿç”¨</label><select id="paymentPaymeEnabled">
                            <option value="true">å•Ÿç”¨</option>
                            <option value="false">åœç”¨</option>
                        </select></div>
                    <div class="input-group"><label>éŠ€è¡Œåç¨±</label><input id="paymentBankName" type="text"></div>
                    <div class="input-group"><label>éŠ€è¡Œæˆ¶å£è™Ÿç¢¼</label><input id="paymentBankAccount" type="text"></div>
                    <div class="input-group"><label>æˆ¶å£åç¨±</label><input id="paymentBankAccountName" type="text"></div>
                    <div class="input-group"><label>PayMe é¡¯ç¤ºåç¨±</label><input id="paymentPaymeDisplayName" type="text">
                    </div>
                    <div class="input-group"><label>PayMe é›»è©±</label><input id="paymentPaymePhone" type="text"></div>
                    <div class="input-group"><label>FPS å•Ÿç”¨</label><select id="paymentFpsEnabled">
                            <option value="true">å•Ÿç”¨</option>
                            <option value="false">åœç”¨</option>
                        </select></div>
                    <div class="input-group"><label>FPS è™Ÿç¢¼</label><input id="paymentFpsNumber" type="text"></div>
                    <div class="input-group"><label>FPS é¡¯ç¤ºåç¨±</label><input id="paymentFpsDisplayName" type="text"
                            placeholder="ä¾‹å¦‚ FPS è½‰æ•¸å¿«"></div>
                </div>
            </div>
            <div class="section-card">
                <h3>é ç´„è¦å‰‡</h3>
                <div class="form-grid two-columns">
                    <div class="input-group"><label>æœ€å°‘æå‰å¤©æ•¸</label><input id="bookingMinAdvance" type="number" min="0">
                    </div>
                    <div class="input-group"><label>æœ€å¤šæå‰å¤©æ•¸</label><input id="bookingMaxAdvance" type="number" min="0">
                    </div>
                    <div class="input-group"><label>æ™‚æ®µé–“éš” (åˆ†é˜)</label><input id="bookingSlotInterval" type="number"
                            min="5" step="5"></div>
                    <div class="input-group"><label>è‡ªå‹•ç¢ºèªé ç´„</label><select id="bookingAutoConfirm">
                            <option value="true">æ˜¯</option>
                            <option value="false">å¦</option>
                        </select></div>
                    <div class="input-group"><label>éœ€è¦ä»˜æ¬¾è­‰æ˜</label><select id="bookingRequirePaymentProof">
                            <option value="true">æ˜¯</option>
                            <option value="false">å¦</option>
                        </select></div>
                </div>
            </div>
            <div class="section-card">
                <h3>åƒ¹æ ¼è¨­å®š</h3>
                <div class="form-grid two-columns">
                    <div class="input-group"><label>ä¸€èˆ¬æ™‚æ®µ (â‰¤10äºº)</label><input id="normalUpTo10" type="number" min="0">
                    </div>
                    <div class="input-group"><label>ä¸€èˆ¬æ™‚æ®µ (11-18äºº)</label><input id="normalUpTo18" type="number" min="0">
                    </div>
                    <div class="input-group"><label>é«˜å³°æ™‚æ®µ (â‰¤10äºº)</label><input id="peakUpTo10" type="number" min="0">
                    </div>
                    <div class="input-group"><label>é«˜å³°æ™‚æ®µ (11-18äºº)</label><input id="peakUpTo18" type="number" min="0">
                    </div>
                    <div class="input-group"><label>é«˜å³°æ™‚æ®µé©ç”¨æ˜ŸæœŸ (ä»¥é€—è™Ÿåˆ†éš”ï¼Œä¾‹å¦‚ fri,sat,sun)</label><input id="peakDays"
                            type="text"></div>
                    <div class="input-group"><label>é«˜å³°é–‹å§‹æ™‚é–“</label><input id="peakStart" type="time"></div>
                    <div class="input-group"><label>é«˜å³°çµæŸæ™‚é–“</label><input id="peakEnd" type="time"></div>
                </div>
            </div>
            <div class="section-card">
                <h3>è¡ŒéŠ·èˆ‡é¡¯ç¤ºè¨­å®š (Marketing)</h3>
                <div class="form-grid two-columns">
                    <div class="input-group"><label>å•Ÿç”¨ç†±é–€æ™‚æ®µæ¨™ç±¤</label><select id="marketingEnableHotTags">
                            <option value="true">å•Ÿç”¨</option>
                            <option value="false">åœç”¨</option>
                        </select></div>
                    <div class="input-group"><label>æ¨™ç±¤æ–‡å­—</label><input id="marketingHotTagText" type="text"
                            placeholder="ğŸ”¥ ç†±é–€"></div>
                    <div class="input-group"><label>ç†±é–€æ™‚æ®µé–‹å§‹</label><input id="marketingHotStartTime" type="time"></div>
                    <div class="input-group"><label>ç†±é–€æ™‚æ®µçµæŸ</label><input id="marketingHotEndTime" type="time"></div>
                </div>
            </div>
            <div id="userManagementSection" class="section-card" style="display:none;">
                <h3>ä½¿ç”¨è€…ç®¡ç†</h3>
                <div id="userMessage" class="message"></div>
                <form id="userForm" class="form-grid two-columns">
                    <div class="input-group">
                        <label>ä½¿ç”¨è€…åç¨±</label>
                        <input id="newUsername" type="text" autocomplete="off" placeholder="ä¾‹å¦‚ï¼šreceptionist1">
                    </div>
                    <div class="input-group">
                        <label>å¯†ç¢¼</label>
                        <input id="newUserPassword" type="password" autocomplete="new-password" placeholder="è«‹è¨­å®šå¯†ç¢¼">
                    </div>
                    <div class="input-group">
                        <label>è§’è‰²</label>
                        <select id="newUserRole">
                            <option value="receptionist">æ¥å¾…å“¡ (Receptionist)</option>
                            <option value="super_admin">è¶…ç´šç®¡ç†å“¡ (Super Admin)</option>
                        </select>
                    </div>
                    <div class="input-group" style="display:flex;align-items:flex-end;">
                        <button type="button" class="btn btn-primary" onclick="createNewUser()">å»ºç«‹ä½¿ç”¨è€…</button>
                    </div>
                </form>
            </div>
            <div style="margin:18px 0 24px;">
                <button class="btn btn-primary" type="button" onclick="saveSettings()">å„²å­˜è¨­å®š</button>
            </div>
        </div>

        <!-- Login Modal -->
        <div id="loginModal">
            <div
                style="background:#fff; padding:32px; border-radius:16px; width:100%; max-width:400px; box-shadow:0 24px 50px rgba(0,0,0,0.2);">
                <h2 style="color:#0b4f6c; margin-bottom:24px; text-align:center;">ç®¡ç†å“¡ç™»å…¥</h2>
                <div id="loginError" class="message error" style="display:none; margin-bottom:16px;"></div>
                <form onsubmit="handleLogin(event)">
                    <div class="input-group" style="margin-bottom:16px;">
                        <label>ä½¿ç”¨è€…åç¨±</label>
                        <input type="text" id="loginUsername" autocomplete="username" required placeholder="admin"
                            autofocus>
                    </div>
                    <div class="input-group" style="margin-bottom:24px;">
                        <label>å¯†ç¢¼</label>
                        <input type="password" id="loginPassword" autocomplete="current-password" required
                            placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                    </div>
                    <button type="submit" class="btn btn-primary"
                        style="width:100%; padding:14px; font-size:1.1em;">ç™»å…¥</button>
                </form>
            </div>
        </div>

        <!-- Notes Modal -->
        <div id="notesModal" class="modal">
            <div class="modal-content">
                <span class="close-modal" onclick="closeNotesModal()">&times;</span>
                <h3 style="margin-bottom:18px;color:#0b4f6c;">ç·¨è¼¯å‚™è¨»</h3>
                <input type="hidden" id="noteBookingId">
                <div class="input-group">
                    <textarea id="noteText" rows="5" placeholder="è¼¸å…¥å‚™è¨»..."></textarea>
                </div>
                <div style="margin-top:18px;text-align:right;">
                    <button class="btn btn-secondary" onclick="closeNotesModal()">å–æ¶ˆ</button>
                    <button class="btn btn-primary" onclick="saveNote()">å„²å­˜</button>
                </div>
            </div>
        </div>
        <div id="instructionsTab" class="tab-content">
            <div id="instructionsMessage" class="message"></div>
            <div class="section-card">
                <h3>é ç´„é ˆçŸ¥å…§å®¹</h3>
                <div class="form-grid two-columns">
                    <div class="input-group"><label>æ¨™é¡Œ (ä¸­æ–‡)</label><input id="titleZh" type="text"></div>
                    <div class="input-group"><label>æ¨™é¡Œ (è‹±æ–‡)</label><input id="titleEn" type="text"></div>
                </div>
                <div class="form-grid two-columns" style="margin-top:18px;">
                    <div class="input-group"><label>æ­¥é©Ÿ 1 (ä¸­æ–‡)</label><textarea id="instruction1Zh"></textarea></div>
                    <div class="input-group"><label>æ­¥é©Ÿ 1 (è‹±æ–‡)</label><textarea id="instruction1En"></textarea></div>
                    <div class="input-group"><label>æ­¥é©Ÿ 2 (ä¸­æ–‡)</label><textarea id="instruction2Zh"></textarea></div>
                    <div class="input-group"><label>æ­¥é©Ÿ 2 (è‹±æ–‡)</label><textarea id="instruction2En"></textarea></div>
                    <div class="input-group"><label>æ­¥é©Ÿ 3 (ä¸­æ–‡)</label><textarea id="instruction3Zh"></textarea></div>
                    <div class="input-group"><label>æ­¥é©Ÿ 3 (è‹±æ–‡)</label><textarea id="instruction3En"></textarea></div>
                    <div class="input-group"><label>æ­¥é©Ÿ 4 (ä¸­æ–‡)</label><textarea id="instruction4Zh"></textarea></div>
                    <div class="input-group"><label>æ­¥é©Ÿ 4 (è‹±æ–‡)</label><textarea id="instruction4En"></textarea></div>
                    <div class="input-group"><label>æ­¥é©Ÿ 5 (ä¸­æ–‡)</label><textarea id="instruction5Zh"></textarea></div>
                    <div class="input-group"><label>æ­¥é©Ÿ 5 (è‹±æ–‡)</label><textarea id="instruction5En"></textarea></div>
                    <div class="input-group"><label>æ­¥é©Ÿ 6 (ä¸­æ–‡)</label><textarea id="instruction6Zh"></textarea></div>
                    <div class="input-group"><label>æ­¥é©Ÿ 6 (è‹±æ–‡)</label><textarea id="instruction6En"></textarea></div>
                </div>
                <div style="margin-top:18px;"><button class="btn btn-primary" onclick="saveInstructions()">å„²å­˜é ˆçŸ¥</button>
                </div>
            </div>
        </div>
        <div id="itemsTab" class="tab-content">
            <div class="section-card">
                <h3>èª²ç¨‹æ’ç¨‹</h3>
                <div id="classesMessage" class="message"></div>
                <form id="classForm">
                    <input type="hidden" id="classId">
                    <div class="form-grid two-columns">
                        <div class="input-group"><label>èª²ç¨‹åç¨±</label><input id="className" type="text" required></div>
                        <div class="input-group"><label>å°å¸«</label><input id="classInstructor" type="text"></div>
                        <div class="input-group"><label>åœ°é»</label><input id="classLocation" type="text"></div>
                        <div class="input-group"><label>é–‹å§‹æ™‚é–“</label><input id="classStart" type="datetime-local"
                                required></div>
                        <div class="input-group"><label>çµæŸæ™‚é–“</label><input id="classEnd" type="datetime-local" required>
                        </div>
                        <div class="input-group"><label>åƒ¹æ ¼ (æ¯äºº)</label><input id="classPrice" type="number" min="0"
                                step="1" required></div>
                        <div class="input-group"><label>å…©äººåŒè¡Œå„ªæƒ åƒ¹ (é¸å¡«)</label><input id="classSpecialPriceForTwo"
                                type="number" min="0" step="1" placeholder="å¡«å¯«å…©äººåˆè¨ˆåƒ¹"></div>
                        <div class="input-group"><label>äººæ•¸ä¸Šé™</label><input id="classCapacity" type="number" min="1"
                                required></div>
                        <div class="input-group"><label>æ˜¯å¦ç‚ºé«”é©—é™å®š</label><select id="classIsTrialOnly">
                                <option value="false">å¦</option>
                                <option value="true">æ˜¯</option>
                            </select></div>
                        <div class="input-group"><label>æ¨™ç±¤ (é€—è™Ÿåˆ†éš”)</label><input id="classTags" type="text"
                                placeholder="ä¾‹å¦‚ beginner,evening"></div>
                    </div>
                    <div class="form-grid" style="margin-top:18px;">
                        <div class="input-group"><label>èª²ç¨‹ä»‹ç´¹</label><textarea id="classDescription"></textarea></div>
                    </div>
                    <div style="margin-top:18px;">
                        <button type="submit" class="btn btn-primary">å„²å­˜èª²ç¨‹</button>
                        <button type="button" class="btn btn-secondary" onclick="resetClassForm()">æ¸…é™¤</button>
                    </div>
                </form>
                <h4 style="margin-top:24px;color:#145da0;">ç¾æœ‰èª²ç¨‹</h4>
                <div id="classesList" class="item-list"></div>
            </div>
            <div class="section-card">
                <h3>èª²ç¨‹æ–¹æ¡ˆ / é«”é©—æ–¹æ¡ˆ</h3>
                <div id="classProductsMessage" class="message"></div>
                <form id="classProductForm">
                    <input type="hidden" id="classProductId">
                    <div class="form-grid two-columns">
                        <div class="input-group"><label>é¡å‹</label><select id="classProductType">
                                <option value="package">èª²ç¨‹æ–¹æ¡ˆ</option>
                                <option value="trial">é«”é©—æ–¹æ¡ˆ</option>
                            </select></div>
                        <div class="input-group"><label>åç¨±</label><input id="classProductName" type="text" required>
                        </div>
                        <div class="input-group"><label>åƒ¹æ ¼</label><input id="classProductPrice" type="number" min="0"
                                step="1" required></div>
                        <div class="input-group"><label>å ‚æ•¸</label><input id="classProductCount" type="number" min="1"
                                required></div>
                        <div class="input-group"><label>æœ‰æ•ˆæœŸ (å¤©)</label><input id="classProductValidity" type="number"
                                min="1"></div>
                    </div>
                    <div class="form-grid" style="margin-top:18px;">
                        <div class="input-group"><label>æ–¹æ¡ˆä»‹ç´¹</label><textarea id="classProductDescription"></textarea>
                        </div>
                    </div>
                    <div style="margin-top:18px;">
                        <button type="submit" class="btn btn-primary">å„²å­˜æ–¹æ¡ˆ</button>
                        <button type="button" class="btn btn-secondary" onclick="resetClassProductForm()">æ¸…é™¤</button>
                    </div>
                </form>
                <h4 style="margin-top:24px;color:#145da0;">ç¾æœ‰æ–¹æ¡ˆ</h4>
                <div id="classProductsList" class="item-list">
                </div>
            </div>
            <div class="section-card">
                <h3>å ´åœ°ç§Ÿç”¨é …ç›®</h3>
                <div id="rentalItemsMessage" class="message"></div>
                <form id="rentalItemForm">
                    <input type="hidden" id="rentalItemId">
                    <div class="form-grid two-columns">
                        <div class="input-group"><label>åç¨±</label><input id="rentalItemName" type="text" required></div>
                        <div class="input-group"><label>é–‹å§‹æ™‚é–“</label><input id="rentalItemStart" type="datetime-local"
                                required></div>
                        <div class="input-group"><label>çµæŸæ™‚é–“</label><input id="rentalItemEnd" type="datetime-local"
                                required></div>
                        <div class="input-group"><label>æ™‚é•· (åˆ†é˜)</label><input id="rentalItemDuration" type="number"
                                min="1" required></div>
                        <div class="input-group"><label>åƒ¹éŒ¢ (æ¯ä½æˆ–æ¯ç¯€)</label><input id="rentalItemPrice" type="number"
                                min="0" step="1" required></div>
                        <div class="input-group"><label>å°å¸«åç¨± / å·¥ä½œäººå“¡</label><input id="rentalItemInstructor" type="text">
                        </div>
                        <div class="input-group"><label>äººæ•¸ä¸Šé™</label><input id="rentalItemCapacity" type="number" min="1"
                                required></div>
                    </div>
                    <div style="margin-top:18px;">
                        <button type="submit" class="btn btn-primary">å„²å­˜å ´åœ°é …ç›®</button>
                        <button type="button" class="btn btn-secondary" onclick="resetRentalItemForm()">æ¸…é™¤</button>
                    </div>
                </form>
                <h4 style="margin-top:24px;color:#145da0;'>ç¾æœ‰å ´åœ°é …ç›®</h4>
                <div id=" rentalItemsList" class="item-list">
            </div>
        </div>
    </div>
    </div>
    <script>
        window.onerror = function (msg, url, line, col, error) {
            // Note: Alerts are annoying but effective for "blank page" debugging
            // console.error(msg, url, line);
            // alert('Error: ' + msg + ' at ' + line);
        };
        // const API_BASE_URL = 'https://booking-ub69.onrender.com/api';
        const API_BASE_URL = '/api'; // Relative path for local/prod compatibility

        const DEV_AUTH_DISABLED = true; // Toggle to true to disable admin authentication (development only)
        function isAuthDisabled() { return DEV_AUTH_DISABLED; }



        let refreshIntervalId = null;
        let currentSettings = {};
        let currentRentalItems = [];
        let currentClasses = [];
        let currentClassProducts = [];

        async function checkApiHealth() {
            const statusEl = document.getElementById('apiStatusMessage');
            if (!statusEl) return;
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                statusEl.className = 'message success';
                statusEl.textContent = 'å·²é€£ç·šè‡³å¾Œç«¯ APIã€‚';
                statusEl.style.display = 'block';
                console.log('Connected to backend API');
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 4000);
            } catch (error) {
                console.error('API health check failed:', error);
                statusEl.className = 'message error';
                statusEl.textContent = 'å¾Œç«¯ API ç„¡æ³•é€£ç·šï¼Œè«‹æª¢æŸ¥ API_BASE_URL è¨­å®šæˆ– Render æœå‹™æ˜¯å¦æ­£å¸¸ã€‚';
                statusEl.style.display = 'block';
            }
        }

        const HTML_ESCAPES = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#39;'
        };

        function escapeHtml(value) {
            if (value === null || value === undefined) return '';
            return value.toString().replace(/[&<>"']/g, (match) => HTML_ESCAPES[match] || match);
        }

        function formatDateOnly(date) {
            if (!(date instanceof Date) || Number.isNaN(date.getTime())) {
                return '';
            }
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function setOverviewDateToToday() {
            const input = document.getElementById('overviewDate');
            if (!input || input.value) return;
            input.value = formatDateOnly(new Date());
        }

        function formatOverviewDateTime(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            if (Number.isNaN(date.getTime())) return '';
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            const hh = String(date.getHours()).padStart(2, '0');
            const mm = String(date.getMinutes()).padStart(2, '0');
            return `${y}-${m}-${d} ${hh}:${mm}`;
        }

        function formatOverviewTime(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            if (Number.isNaN(date.getTime())) return '';
            const hh = String(date.getHours()).padStart(2, '0');
            const mm = String(date.getMinutes()).padStart(2, '0');
            return `${hh}:${mm}`;
        }

        async function loadBookingOverview(date) {
            const targetDate = date || document.getElementById('overviewDate')?.value;
            if (!targetDate) return;
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/admin/bookings/overview?date=${targetDate}`);
                if (response.status === 401) return logout();
                const result = await response.json();
                if (response.ok) {
                    renderBookingOverview(result);
                } else {
                    showOverviewMessage('error', result.error || 'ç„¡æ³•è¼‰å…¥æ¦‚è¦½ã€‚');
                }
            } catch (error) {
                console.error('Error loading booking overview:', error);
                showOverviewMessage('error', 'ç„¡æ³•è¼‰å…¥æ¦‚è¦½ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            }
        }

        function renderBookingOverview(data) {
            const studioList = document.getElementById('overviewStudioList');
            const classList = document.getElementById('overviewClassList');
            const messageEl = document.getElementById('overviewMessage');
            if (messageEl) { messageEl.style.display = 'none'; }
            if (!studioList || !classList) return;
            studioList.innerHTML = '';
            classList.innerHTML = '';

            const studioSessions = Array.isArray(data.studioSessions) ? data.studioSessions : [];
            if (studioSessions.length === 0) {
                studioList.innerHTML = '<div class="overview-empty">ç•¶æ—¥æš«ç„¡å ´åœ°é ç´„ã€‚</div>';
            } else {
                studioSessions.forEach(session => {
                    const card = document.createElement('div');
                    card.className = 'overview-card';
                    const timeLabel = `${session.startTime || ''} - ${session.endTime || ''}`.trim();
                    const notesRow = session.notes ? `<div>å‚™è¨»ï¼š${escapeHtml(session.notes)}</div>` : '';
                    card.innerHTML = `
                        <h4>${escapeHtml(timeLabel)}</h4>
                        <div class="overview-meta">
                            <div>é ç´„ç·¨è™Ÿï¼š${escapeHtml(session.bookingId)}</div>
                            <div>${escapeHtml(session.customerName || 'â€”')}ï½œ${escapeHtml(String(session.peopleCount || 0))} äºº</div>
                            <div>ç‹€æ…‹ï¼š${escapeHtml(session.status || '')}</div>
                            <div>${escapeHtml(session.email || '')}<br>${escapeHtml(session.phone || '')}</div>
                            ${notesRow}
                        </div>
                    `;
                    studioList.appendChild(card);
                });
            }

            const classSessions = Array.isArray(data.classSessions) ? data.classSessions : [];
            if (classSessions.length === 0) {
                classList.innerHTML = '<div class="overview-empty">ç•¶æ—¥æš«ç„¡èª²ç¨‹é ç´„ã€‚</div>';
            } else {
                classSessions.forEach(cls => {
                    const card = document.createElement('div');
                    card.className = 'overview-card';
                    const startLabel = formatOverviewDateTime(cls.startDateTime);
                    const endLabel = formatOverviewTime(cls.endDateTime);
                    const scheduleLabel = endLabel ? `${startLabel} - ${endLabel}` : startLabel;
                    const descriptionRow = cls.description ? `<div style="margin-top:6px;">${escapeHtml(cls.description)}</div>` : '';
                    const attendees = Array.isArray(cls.attendees) ? cls.attendees : [];
                    const attendeesRows = attendees.map(att => {
                        return `<div>â€¢ ${escapeHtml(att.customerName || 'â€”')}ï½œ${escapeHtml(String(att.peopleCount || 0))} äººï½œ${escapeHtml(att.status || '')}</div>`;
                    }).join('');
                    const attendeesHtml = attendees.length === 0
                        ? '<div class="overview-empty" style="margin-top:10px;">å°šæœªæœ‰åƒåŠ è€…ã€‚</div>'
                        : `<div class="overview-attendees">${attendeesRows}</div>`;
                    card.innerHTML = `
                        <h4>${escapeHtml(cls.name)}</h4>
                        <div class="overview-meta">
                            <div>${escapeHtml(scheduleLabel)}</div>
                            ${cls.instructorName ? `<div>å°å¸«ï¼š${escapeHtml(cls.instructorName)}</div>` : ''}
                        </div>
                        <div class="overview-meta" style="margin-top:6px;">
                            <div>å ±åï¼š${escapeHtml(String(cls.totalParticipants || 0))} / ${escapeHtml(String(cls.capacity || 0))}ï¼ˆå‰©é¤˜ ${escapeHtml(String(cls.seatsRemaining || 0))}ï¼‰</div>
                            ${descriptionRow}
                        </div>
                        ${attendeesHtml}
                    `;
                    classList.appendChild(card);
                });
            }
        }

        function refreshOverview() {
            const date = document.getElementById('overviewDate')?.value;
            loadBookingOverview(date);
        }

        function showOverviewMessage(type, message) {
            showMessage('overviewMessage', type, message);
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await checkApiHealth();
            if (typeof checkAuthentication === 'function') {
                checkAuthentication();
            }

            // Event Listeners for Tabs
            document.querySelectorAll('.tab-btn').forEach(btn => btn.addEventListener('click', handleTabClick));

            // Event Listeners for Forms
            const classForm = document.getElementById('classForm');
            if (classForm) classForm.addEventListener('submit', submitClassForm);

            const classProductForm = document.getElementById('classProductForm');
            if (classProductForm) classProductForm.addEventListener('submit', submitClassProductForm);

            const rentalItemForm = document.getElementById('rentalItemForm');
            if (rentalItemForm) rentalItemForm.addEventListener('submit', submitRentalItemForm);

            const passwordForm = document.getElementById('passwordForm');
            if (passwordForm) passwordForm.addEventListener('submit', handlePasswordChange);

            // User Management Form (New)
            // Note: createNewUser is called via onclick in the HTML, so no listener needed here, 
            // but if we change to onsubmit in future, add it here.

            // Date Input Listeners
            const overviewDateInput = document.getElementById('overviewDate');
            if (overviewDateInput) {
                overviewDateInput.addEventListener('change', () => loadBookingOverview(overviewDateInput.value));
            }

            // Initial Auth Check is triggered by script end, or we can trigger here if preferred.
            // checkAuthentication() is already called at the end of the script.
        });

        // Removed legacy auth functions (performAdminLogin, showAdminPanel, old logout, old authHeaders)

        // 401 Interceptor wrapper
        async function authenticatedFetch(url, options = {}) {
            const token = localStorage.getItem('adminToken');
            if (!token && !url.includes('/login')) {
                throw new Error('No token found');
            }

            const headers = { ...options.headers };
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            const response = await fetch(url, { ...options, headers });

            if (response.status === 401) {
                // Token Expired or Invalid
                logout();
                throw new Error('Session expired');
            }

            return response;
        }

        async function loadStats() {
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/stats`);
                if (!response.ok) {
                    const errorPayload = await response.json().catch(() => ({}));
                    console.error('Failed to load stats:', response.status, errorPayload);
                    showMessage('bookingsMessage', 'error', errorPayload.error || 'ç„¡æ³•è¼‰å…¥çµ±è¨ˆè³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                    return;
                }
                const stats = await response.json();
                document.getElementById('stat-total').querySelector('p').textContent = stats.total;
                document.getElementById('stat-confirmed').querySelector('p').textContent = stats.confirmed;
                document.getElementById('stat-pending').querySelector('p').textContent = stats.pending;
            } catch (error) {
                console.error('Error loading stats:', error);
                showMessage('bookingsMessage', 'error', 'ç„¡æ³•è¼‰å…¥çµ±è¨ˆè³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            }
        }

        async function loadBookings() {
            await Promise.all([loadRentalBookings(), loadClassBookings()]);
        }

        async function loadRentalBookings() {
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/bookings`);
                if (!response.ok) {
                    const errorPayload = await response.json().catch(() => ({}));
                    console.error('Failed to load bookings:', response.status, errorPayload);
                    showMessage('bookingsMessage', 'error', errorPayload.error || 'ç„¡æ³•è¼‰å…¥é ç´„è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                    return;
                }
                const bookings = await response.json();
                renderRentalBookings(bookings);
                hideMessage('bookingsMessage');
            } catch (error) {
                console.error('Error loading bookings:', error);
                showMessage('bookingsMessage', 'error', 'ç„¡æ³•è¼‰å…¥é ç´„è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            }
        }

        function renderRentalBookings(bookings) {
            const tbody = document.getElementById('bookingsTable');
            if (!tbody) return;
            tbody.innerHTML = '';
            if (!bookings || bookings.length === 0) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 7;
                cell.style.textAlign = 'center';
                cell.textContent = 'æš«ç„¡é ç´„è³‡æ–™';
                row.appendChild(cell);
                tbody.appendChild(row);
                return;
            }
            bookings.forEach(booking => {
                const row = document.createElement('tr');
                const itemsHtml = (booking.items || []).map(item => {
                    const peopleCount = Number.isFinite(Number(item.peopleCount)) && Number(item.peopleCount) > 0
                        ? Number(item.peopleCount)
                        : 1;
                    const label = item.itemType === 'workshop_class' ? 'èª²ç¨‹' : 'å ´åœ°';
                    return `<div><strong>${label}:</strong> ${item.date} ${item.startTime}-${item.endTime} (${peopleCount}äºº)</div>`;
                }).join('');
                const totalPeopleValue = Number.isFinite(Number(booking.totalPeople)) && Number(booking.totalPeople) > 0
                    ? Number(booking.totalPeople)
                    : 1;
                const statusBadge = `<span class="status-chip status-${booking.status}">${statusMap[booking.status] || booking.status}</span>`;
                const notes = booking.adminNotes ? `<div style="font-size:0.85em;color:#666;margin-top:4px;">ğŸ“ ${escapeHtml(booking.adminNotes)}</div>` : '';

                row.innerHTML = `
                    <td>${escapeHtml(booking.id.slice(0, 8))}...</td>
                    <td>${formatDateTime(new Date(booking.createdAt))}</td>
                    <td>
                        <div>${escapeHtml(booking.customerName)}</div>
                        <div style="font-size:0.9em;color:#666;">${escapeHtml(booking.phone)}</div>
                    </td>
                    <td>
                        ${itemsHtml || 'â€”'}
                        ${notes}
                    </td>
                    <td>HK$${Number(booking.totalPrice || 0).toFixed(2)}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-secondary" onclick="updateBookingStatus('${booking.id}', 'confirmed')">ç¢ºèª</button>
                            <button class="btn btn-sm btn-secondary" onclick="updateBookingStatus('${booking.id}', 'pending')">å¾…è™•ç†</button>
                            <button class="btn btn-sm btn-danger" onclick="updateBookingStatus('${booking.id}', 'cancelled')">å–æ¶ˆ</button>
                            <a class="btn btn-sm btn-secondary" href="${API_BASE_URL}/bookings/${booking.id}/ics" target="_blank" rel="noopener">ä¸‹è¼‰æ—¥æ›†</a>
                            <button class="btn btn-sm btn-danger" onclick="deleteRentalBooking('${booking.id}')">åˆªé™¤</button>
                            <button class="btn btn-sm btn-secondary" onclick="editAdminNote('${booking.id}', 'rental', '${booking.status}', '${escapeHtml(booking.adminNotes || '').replace(/'/g, "\\'")}')">å‚™è¨»</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function loadClassBookings() {
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/admin/class-bookings`);
                if (!response.ok) {
                    const errorPayload = await response.json().catch(() => ({}));
                    console.error('Failed to load class bookings:', response.status, errorPayload);
                    showMessage('classBookingsMessage', 'error', errorPayload.error || 'ç„¡æ³•è¼‰å…¥èª²ç¨‹é ç´„è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                    return;
                }
                const bookings = await response.json();
                renderClassBookings(bookings);
                hideMessage('classBookingsMessage');
            } catch (error) {
                console.error('Error loading class bookings:', error);
                showMessage('classBookingsMessage', 'error', 'ç„¡æ³•è¼‰å…¥èª²ç¨‹é ç´„è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            }
        }

        function renderClassBookings(bookings) {
            const tbody = document.getElementById('classBookingsTable');
            if (!tbody) return;
            tbody.innerHTML = '';
            if (!bookings || bookings.length === 0) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 6;
                cell.style.textAlign = 'center';
                cell.textContent = 'æš«ç„¡èª²ç¨‹é ç´„';
                row.appendChild(cell);
                tbody.appendChild(row);
                return;
            }
            const statusMap = {
                'pending': 'å¾…è™•ç†',
                'confirmed': 'å·²ç¢ºèª',
                'cancelled': 'å·²å–æ¶ˆ'
            };
            bookings.forEach(booking => {
                const row = document.createElement('tr');
                const startLabel = booking.classStartTime ? formatOverviewDateTime(booking.classStartTime) : '';
                const endLabel = booking.classEndTime ? formatOverviewTime(booking.classEndTime) : '';
                const scheduleDisplay = endLabel ? `${startLabel} - ${endLabel}` : startLabel;
                const locationHtml = booking.classLocation ? `<br><small>${escapeHtml(booking.classLocation)}</small>` : '';
                const statusBadge = `<span class="status-chip status-${booking.status}">${statusMap[booking.status] || booking.status}</span>`;
                const notes = booking.adminNotes ? `<div style="font-size:0.85em;color:#666;margin-top:4px;">ğŸ“ ${escapeHtml(booking.adminNotes)}</div>` : '';

                row.innerHTML = `
                    <td>${escapeHtml(booking.id.slice(0, 8))}...</td>
                    <td>${formatDateTime(new Date(booking.createdAt))}</td>
                    <td>
                        <div>${escapeHtml(booking.customerName)}</div>
                        <div style="font-size:0.9em;color:#666;">${escapeHtml(booking.email)}</div>
                    </td>
                    <td>${escapeHtml(booking.phone)}</td>
                    <td>${escapeHtml(String(booking.peopleCount || 0))}</td>
                    <td>
                         ${statusBadge}
                         ${notes}
                    </td>
                    <td>
                         <div class="action-buttons">
                            <button class="btn btn-sm btn-secondary" onclick="updateClassBookingStatus('${booking.id}', 'confirmed')">ç¢ºèª</button>
                            <button class="btn btn-sm btn-secondary" onclick="updateClassBookingStatus('${booking.id}', 'pending')">å¾…è™•ç†</button>
                            <button class="btn btn-sm btn-danger" onclick="updateClassBookingStatus('${booking.id}', 'cancelled')">å–æ¶ˆ</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteClassBooking('${booking.id}')">åˆªé™¤</button>
                            <button class="btn btn-sm btn-secondary" onclick="editAdminNote('${booking.id}', 'class', '${booking.status}', '${escapeHtml(booking.adminNotes || '').replace(/'/g, "\\'")}')">å‚™è¨»</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function updateBookingStatus(id, status) {
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/bookings/${id}/status`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status }) });
                const result = await response.json();
                if (response.ok) {
                    showMessage('bookingsMessage', 'success', result.message || 'æ›´æ–°æˆåŠŸ');
                    loadRentalBookings();
                    loadBookingOverview(document.getElementById('overviewDate')?.value);
                    loadStats();
                    if (calendar) calendar.refetchEvents();
                } else {
                    showMessage('bookingsMessage', 'error', result.error || 'æ›´æ–°å¤±æ•—');
                }
            } catch (error) {
                console.error('Error updating booking status:', error);
                showMessage('bookingsMessage', 'error', 'æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }

        async function deleteRentalBooking(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤é ç´„è¨˜éŒ„å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚')) return;
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/admin/bookings/${id}`, { method: 'DELETE' });
                const result = await response.json().catch(() => ({}));
                if (response.ok) {
                    showMessage('bookingsMessage', 'success', result.message || 'é ç´„è¨˜éŒ„å·²åˆªé™¤');
                    loadRentalBookings();
                    loadBookingOverview(document.getElementById('overviewDate')?.value);
                    loadStats();
                    if (calendar) calendar.refetchEvents();
                } else {
                    showMessage('bookingsMessage', 'error', result.error || 'åˆªé™¤å¤±æ•—');
                }
            } catch (error) {
                console.error('Error deleting booking:', error);
                showMessage('bookingsMessage', 'error', 'åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }

        async function updateClassBookingStatus(id, status) {
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/admin/class-bookings/${id}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });
                const result = await response.json().catch(() => ({}));
                if (response.ok) {
                    showMessage('classBookingsMessage', 'success', result.message || 'æ›´æ–°æˆåŠŸ');
                    loadClassBookings();
                    loadBookingOverview(document.getElementById('overviewDate')?.value);
                } else {
                    showMessage('classBookingsMessage', 'error', result.error || 'æ›´æ–°å¤±æ•—');
                }
            } catch (error) {
                console.error('Error updating class booking status:', error);
                showMessage('classBookingsMessage', 'error', 'æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }

        async function deleteClassBooking(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤èª²ç¨‹é ç´„ï¼Ÿ')) return;
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/admin/class-bookings/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    showMessage('classBookingsMessage', 'success', 'èª²ç¨‹é ç´„å·²åˆªé™¤');
                    loadClassBookings();
                    loadBookingOverview(document.getElementById('overviewDate')?.value);
                } else {
                    const result = await response.json().catch(() => ({}));
                    showMessage('classBookingsMessage', 'error', result.error || 'åˆªé™¤å¤±æ•—');
                }
            } catch (error) {
                console.error('Error deleting class booking:', error);
                showMessage('classBookingsMessage', 'error', 'åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }

        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('loginError');

            errorEl.style.display = 'none';

            try {
                const response = await fetch(`${API_BASE_URL}/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    localStorage.setItem('adminToken', result.token);
                    localStorage.setItem('adminRole', result.role || 'super_admin');
                    localStorage.setItem('adminUsername', result.username || username);

                    const loginModal = document.getElementById('loginModal');
                    if (loginModal) loginModal.classList.remove('active');

                    document.getElementById('adminContainer').style.display = 'block';

                    if (typeof loadDashboardData === 'function') {
                        loadDashboardData();
                    }
                } else {
                    errorEl.textContent = result.error || 'ç™»å…¥å¤±æ•—';
                    errorEl.style.display = 'block';
                }
            } catch (error) {
                console.error('Login error:', error);
                errorEl.textContent = 'ç™»å…¥é€£ç·šå¤±æ•—';
                errorEl.style.display = 'block';
            }
        }

        function showLoginModal() {
            document.getElementById('loginModal').style.display = 'flex';
            document.getElementById('adminContainer').style.display = 'none';
        }

        function logout() {
            localStorage.removeItem('adminToken');
            localStorage.removeItem('adminRole');
            localStorage.removeItem('adminUsername');
            document.getElementById('adminContainer').style.display = 'none';
            showLoginModal();
        }

        function updateAdminUI() {
            const role = localStorage.getItem('adminRole'); // 'super_admin' or 'receptionist'
            const username = localStorage.getItem('adminUsername');

            const adminIdentity = document.getElementById('adminIdentity');
            if (adminIdentity) {
                adminIdentity.textContent = `User: ${username} (${role})`;
                adminIdentity.style.display = 'block';
            }

            // Hide Settings Tab for non-super_admin
            const settingsBtn = document.querySelector('button[data-tab="settingsTab"]');
            if (settingsBtn) {
                settingsBtn.style.display = role === 'super_admin' ? 'inline-block' : 'none';
            }

            // Hide Revenue/Total Stats for non-super_admin (Allow Pending count only?)
            // Requirement: "Restrict 'Settings', 'Financial Stats' ... to super_admin"
            // Let's hide the total and confirmed revenue cards if not super_admin?
            // Or just hide the stats API call? The API is protected now.
            // If API fails (403), stats won't load. Ideally hide the UI too.
            if (role !== 'super_admin') {
                const statTotal = document.getElementById('stat-total');
                const statConfirmed = document.getElementById('stat-confirmed');
                if (statTotal) statTotal.style.visibility = 'hidden';
                if (statConfirmed) statConfirmed.style.visibility = 'hidden';
                // Keep 'stat-pending' visible as receptionist needs to see pending tasks?
            } else {
                const statTotal = document.getElementById('stat-total');
                const statConfirmed = document.getElementById('stat-confirmed');
                if (statTotal) statTotal.style.visibility = 'visible';
                if (statConfirmed) statConfirmed.style.visibility = 'visible';
            }

            // Delete buttons dynamic hiding is harder in table render, 
            // but we can add a global style or class to body?
            if (role === 'super_admin') {
                document.body.classList.add('role-super-admin');
                document.body.classList.remove('role-receptionist');
            } else {
                document.body.classList.add('role-receptionist');
                document.body.classList.remove('role-super-admin');
            }
        }
        function applyRolePermissions() {
            const role = localStorage.getItem('adminRole');
            const username = localStorage.getItem('adminUsername');

            const identityEl = document.getElementById('adminIdentity');
            if (identityEl) {
                identityEl.textContent = `å·²ç™»å…¥: ${username} (${role === 'super_admin' ? 'è¶…ç´šç®¡ç†å“¡' : 'æ¥å¾…å“¡'})`;
                identityEl.style.display = 'block';
            }

            // Elements to hide/show based on role
            const settingsTabBtn = document.querySelector('button[data-tab="settingsTab"]');
            const totalRevenueCard = document.getElementById('stat-total-revenue'); // Need to ID this if exists, or just hide specific stats
            const userManagementSection = document.getElementById('userManagementSection');

            // Receptionist Restrictions
            if (role === 'receptionist') {
                if (settingsTabBtn) settingsTabBtn.style.display = 'none';
                if (userManagementSection) userManagementSection.style.display = 'none';

                // Hide Create/Edit/Delete actions in Lists (CSS or DOM removal)
                document.body.classList.add('role-receptionist');
                // We'll handle this by checking role in render functions or adding CSS
                const style = document.createElement('style');
                style.id = 'rbac-style';
                style.innerHTML = `
                    .role-receptionist .btn-danger, 
                    .role-receptionist button[onclick*="delete"],
                    .role-receptionist button[onclick*="edit"],
                    .role-receptionist button[type="submit"], 
                    .role-receptionist #classForm button,
                    .role-receptionist #rentalItemForm button,
                    .role-receptionist #classProductForm button { display: none !important; }
                    
                    /* Exception: Allow updating status? User said "Allow receptionist to access Bookings (GET, PATCH status)" */
                    /* So we should NOT hide booking status buttons. But Classes/Items are "View Only" */
                    
                    .role-receptionist #itemsTab .btn { display: none !important; }
                    .role-receptionist #itemsTab form { pointer-events: none; opacity: 0.6; }
                `;
                if (!document.getElementById('rbac-style')) document.head.appendChild(style);

            } else {
                // Super Admin
                if (settingsTabBtn) settingsTabBtn.style.display = 'block';
                if (userManagementSection) userManagementSection.style.display = 'block';
                document.body.classList.remove('role-receptionist');
                const style = document.getElementById('rbac-style');
                if (style) style.remove();
            }
        }

        async function createNewUser() {
            const username = document.getElementById('newUsername').value;
            const password = document.getElementById('newUserPassword').value;
            const role = document.getElementById('newUserRole').value;
            const msgEl = document.getElementById('userMessage');

            if (!username || !password) {
                msgEl.className = 'message error';
                msgEl.textContent = 'è«‹å¡«å¯«ä½¿ç”¨è€…åç¨±èˆ‡å¯†ç¢¼';
                msgEl.style.display = 'block';
                return;
            }

            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/admin/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, role })
                });

                const result = await response.json();
                if (response.ok) {
                    msgEl.className = 'message success';
                    msgEl.textContent = `ä½¿ç”¨è€… ${username} å»ºç«‹æˆåŠŸ`;
                    msgEl.style.display = 'block';
                    document.getElementById('userForm').reset();
                    setTimeout(() => { msgEl.style.display = 'none'; }, 3000);
                } else {
                    msgEl.className = 'message error';
                    msgEl.textContent = result.error || 'å»ºç«‹å¤±æ•—';
                    msgEl.style.display = 'block';
                }
            } catch (error) {
                console.error('Create user error:', error);
                msgEl.className = 'message error';
                msgEl.textContent = 'å»ºç«‹å¤±æ•—';
                msgEl.style.display = 'block';
            }
        }

        // Use relative path for Render compatibility
        // const API_BASE_URL = '/api'; // Already defined at top of script

        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Admin Panel Initializing...');

            // 1. Immediately show Loading or default state if needed
            // But crucially, run auth check immediately
            checkAuthentication();

            // 2. Check API Health in the background (Non-blocking)
            checkApiHealth();
        });

        async function checkApiHealth() {
            const statusEl = document.getElementById('apiStatusMessage');
            if (!statusEl) return;
            try {
                const res = await fetch(`${API_BASE_URL}/health`);
                if (res.ok) {
                    statusEl.textContent = 'System Online';
                    statusEl.className = 'message success';
                    statusEl.style.display = 'block';
                    setTimeout(() => statusEl.style.display = 'none', 3000);
                }
            } catch (e) {
                console.error('API Check Failed:', e);
                // Don't block the UI, just show a warning
                statusEl.textContent = 'âš ï¸ API é€£ç·šå¤±æ•— (Offline)';
                statusEl.className = 'message error';
                statusEl.style.display = 'block';
            }
        }

        function checkAuthentication() {
            const token = localStorage.getItem('adminToken');
            const loginModal = document.getElementById('loginModal');
            const adminContainer = document.getElementById('adminContainer');

            // 1. Check for Token
            if (!token) {
                console.log('No token found. Showing login.');
                if (loginModal) loginModal.classList.add('active');
                if (adminContainer) adminContainer.style.display = 'none';
                return; // STOP execution
            }

            // 2. Token exists -> Show Dashboard
            if (loginModal) loginModal.classList.remove('active');
            if (adminContainer) {
                adminContainer.style.display = 'block';

                // 3. Load Data ONLY now
                if (typeof loadDashboardData === 'function') {
                    loadDashboardData();
                }
            }
        }

        function loadDashboardData() {
            applyRolePermissions();
            setOverviewDateToToday();

            // Load initial data
            loadStats();
            loadRentalBookings();
            loadBookingOverview(document.getElementById('overviewDate')?.value);

            // Only load settings if allowed
            if (localStorage.getItem('adminRole') === 'super_admin') {
                loadSettings();
            }

            // Load other data
            loadClasses();
            loadClassProducts();
            loadRentalItems();
            loadClassBookings();

            if (refreshIntervalId) clearInterval(refreshIntervalId);
            refreshIntervalId = setInterval(() => {
                loadStats();
                loadRentalBookings();
                loadClassBookings();
                loadBookingOverview(document.getElementById('overviewDate')?.value);
            }, 30000);

            if (typeof calendar !== 'undefined' && calendar) calendar.refetchEvents();
        }

        async function handlePasswordChange(event) {
            event.preventDefault();
            if (isAuthDisabled()) {
                showMessage('passwordMessage', 'success', 'é–‹ç™¼æ¨¡å¼ï¼šç›®å‰å·²åœç”¨ç®¡ç†å¯†ç¢¼é©—è­‰ã€‚');
                event.target.reset();
                return;
            }
            const current = document.getElementById('currentAdminPassword').value;
            const nextPassword = document.getElementById('newAdminPassword').value;
            const confirmPassword = document.getElementById('confirmAdminPassword').value;

            if (!current || !nextPassword || !confirmPassword) {
                showMessage('passwordMessage', 'error', 'è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½');
                return;
            }

            if (nextPassword !== confirmPassword) {
                showMessage('passwordMessage', 'error', 'æ–°å¯†ç¢¼èˆ‡ç¢ºèªå¯†ç¢¼ä¸ä¸€è‡´');
                return;
            }

            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/admin/change-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ currentPassword: current, newPassword: nextPassword })
                });
                const result = await response.json().catch(() => ({}));

                if (response.status === 401) {
                    showMessage('passwordMessage', 'error', result.error || 'é©—è­‰å¤±æ•—ï¼Œè«‹é‡æ–°ç™»å…¥');
                    setTimeout(() => logout(), 1500);
                    return;
                }

                if (response.ok && result.success) {
                    showMessage('passwordMessage', 'success', 'å¯†ç¢¼å·²æ›´æ–°ï¼Œè«‹é‡æ–°ç™»å…¥');
                    event.target.reset();
                    setTimeout(() => {
                        logout();
                    }, 1500);
                } else {
                    showMessage('passwordMessage', 'error', result.error || 'æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                }
            } catch (error) {
                console.error('Error changing password:', error);
                showMessage('passwordMessage', 'error', 'æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }

        async function loadSettings() {
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/settings`);
                if (!response.ok) throw new Error('Failed to load settings');

                const settings = await response.json();
                currentSettings = settings;

                // Basic Info
                document.getElementById('businessName').value = settings.businessName || '';
                document.getElementById('businessNameZh').value = settings.businessNameZh || '';
                document.getElementById('businessDescription').value = settings.businessDescription || '';
                document.getElementById('businessDescriptionZh').value = settings.businessDescriptionZh || '';

                if (settings.operatingHours) {
                    document.getElementById('startTime').value = settings.operatingHours.startTime || '';
                    document.getElementById('endTime').value = settings.operatingHours.endTime || '';
                    document.getElementById('daysLabelZh').value = settings.operatingHours.daysLabelZh || '';
                    document.getElementById('daysLabelEn').value = settings.operatingHours.daysLabelEn || '';
                }

                // Contact
                if (settings.contactInfo) {
                    document.getElementById('contactWhatsapp').value = settings.contactInfo.whatsapp || '';
                    document.getElementById('contactPhone').value = settings.contactInfo.phone || '';
                    document.getElementById('contactEmail').value = settings.contactInfo.email || '';
                }

                // Interface / CMS
                if (settings.ui) {
                    document.getElementById('uiHeroTitleZh').value = settings.ui.heroTitleZh || '';
                    document.getElementById('uiHeroSubtitleZh').value = settings.ui.heroSubtitleZh || '';
                    document.getElementById('uiAnnouncementText').value = settings.ui.announcementText || '';
                    document.getElementById('uiAnnouncementActive').checked = settings.ui.announcementActive === true;
                    document.getElementById('uiPrimaryColor').value = settings.ui.primaryColor || '#3b82f6';
                    document.getElementById('uiPrimaryColorValue').textContent = settings.ui.primaryColor || '#3b82f6';
                    document.getElementById('uiFooterText').value = settings.ui.footerText || '';
                }

                // Color Picker Listener
                const colorInput = document.getElementById('uiPrimaryColor');
                if (colorInput) {
                    colorInput.oninput = (e) => {
                        document.getElementById('uiPrimaryColorValue').textContent = e.target.value;
                    };
                }

                // Payment
                if (settings.paymentMethods) {
                    const pm = settings.paymentMethods;
                    if (pm.bankTransfer) {
                        document.getElementById('paymentBankEnabled').value = pm.bankTransfer.enabled ? 'true' : 'false';
                        document.getElementById('paymentBankName').value = pm.bankTransfer.bankName || '';
                        document.getElementById('paymentBankAccount').value = pm.bankTransfer.accountNumber || '';
                        document.getElementById('paymentBankAccountName').value = pm.bankTransfer.accountName || '';
                    }
                    if (pm.payme) {
                        document.getElementById('paymentPaymeEnabled').value = pm.payme.enabled ? 'true' : 'false';
                        document.getElementById('paymentPaymeDisplayName').value = pm.payme.displayName || '';
                        document.getElementById('paymentPaymePhone').value = pm.payme.phoneNumber || '';
                    }
                    if (pm.fps) {
                        document.getElementById('paymentFpsEnabled').value = pm.fps.enabled ? 'true' : 'false';
                        document.getElementById('paymentFpsNumber').value = pm.fps.fpsNumber || '';
                        document.getElementById('paymentFpsDisplayName').value = pm.fps.displayName || '';
                    }
                }

                // Booking Rules
                if (settings.bookingRules) {
                    const br = settings.bookingRules;
                    document.getElementById('bookingMinAdvance').value = br.minAdvanceBooking || 0;
                    document.getElementById('bookingMaxAdvance').value = br.maxAdvanceBooking || 30;
                    document.getElementById('bookingSlotInterval').value = br.slotInterval || 30;
                    document.getElementById('bookingAutoConfirm').value = br.autoConfirm ? 'true' : 'false';
                    document.getElementById('bookingRequirePaymentProof').value = br.requirePaymentProof ? 'true' : 'false';

                    // Marketing Settings Mappings
                    const marketing = br.marketing || {};
                    if (document.getElementById('marketingEnableHotTags')) {
                        document.getElementById('marketingEnableHotTags').value = marketing.enableHotTags ? 'true' : 'false';
                        document.getElementById('marketingHotTagText').value = marketing.hotTagText || 'ğŸ”¥ ç†±é–€';
                        document.getElementById('marketingHotStartTime').value = marketing.startTime || '18:00';
                        document.getElementById('marketingHotEndTime').value = marketing.endTime || '22:00';
                    }
                }

                // Pricing
                if (settings.pricing) {
                    document.getElementById('normalUpTo10').value = settings.pricing.normalUpTo10 || 0;
                    document.getElementById('normalUpTo18').value = settings.pricing.normalUpTo18 || 0;
                    document.getElementById('peakUpTo10').value = settings.pricing.peakUpTo10 || 0;
                    document.getElementById('peakUpTo18').value = settings.pricing.peakUpTo18 || 0;

                    if (settings.pricing.peakSchedule) {
                        document.getElementById('peakDays').value = (settings.pricing.peakSchedule.days || []).join(',');
                        document.getElementById('peakStart').value = settings.pricing.peakSchedule.startTime || '';
                        document.getElementById('peakEnd').value = settings.pricing.peakSchedule.endTime || '';
                    }
                }

                hideMessage('settingsMessage');
            } catch (error) {
                console.error(error);
                showMessage('settingsMessage', 'error', 'ç„¡æ³•è¼‰å…¥è¨­å®š');
            }
        }

        async function saveSettings() {
            // Gather existing settings
            const marketingSettings = {
                enableHotTags: document.getElementById('marketingEnableHotTags').value === 'true',
                hotTagText: document.getElementById('marketingHotTagText').value,
                startTime: document.getElementById('marketingHotStartTime').value,
                endTime: document.getElementById('marketingHotEndTime').value
            };

            // Merge into bookingRules
            const updatedBookingRules = {
                ...(currentSettings.bookingRules || {}),
                marketing: marketingSettings,
                minAdvanceBooking: Number(document.getElementById('bookingMinAdvance')?.value),
                maxAdvanceBooking: Number(document.getElementById('bookingMaxAdvance')?.value),
                slotInterval: Number(document.getElementById('bookingSlotInterval')?.value),
                autoConfirm: document.getElementById('bookingAutoConfirm')?.value === 'true',
                requirePaymentProof: document.getElementById('bookingRequirePaymentProof')?.value === 'true'
            };

            const payload = {
                ...currentSettings,
                businessName: document.getElementById('businessName').value,
                businessNameZh: document.getElementById('businessNameZh').value,
                businessDescription: document.getElementById('businessDescription').value,
                businessDescriptionZh: document.getElementById('businessDescriptionZh').value,
                operatingHours: {
                    startTime: document.getElementById('startTime').value,
                    endTime: document.getElementById('endTime').value,
                    daysLabelZh: document.getElementById('daysLabelZh').value,
                    daysLabelEn: document.getElementById('daysLabelEn').value
                },
                contactInfo: {
                    whatsapp: document.getElementById('contactWhatsapp').value,
                    phone: document.getElementById('contactPhone').value,
                    email: document.getElementById('contactEmail').value
                },

                // Interface / CMS
                ui: {
                    heroTitleZh: document.getElementById('uiHeroTitleZh').value,
                    heroSubtitleZh: document.getElementById('uiHeroSubtitleZh').value,
                    announcementText: document.getElementById('uiAnnouncementText').value,
                    announcementActive: document.getElementById('uiAnnouncementActive').checked,
                    primaryColor: document.getElementById('uiPrimaryColor').value,
                    footerText: document.getElementById('uiFooterText').value
                },
                paymentMethods: {
                    bankTransfer: {
                        enabled: document.getElementById('paymentBankEnabled').value === 'true',
                        bankName: document.getElementById('paymentBankName').value,
                        accountNumber: document.getElementById('paymentBankAccount').value,
                        accountName: document.getElementById('paymentBankAccountName').value
                    },
                    payme: {
                        enabled: document.getElementById('paymentPaymeEnabled').value === 'true',
                        displayName: document.getElementById('paymentPaymeDisplayName').value,
                        phoneNumber: document.getElementById('paymentPaymePhone').value
                    },
                    fps: {
                        enabled: document.getElementById('paymentFpsEnabled').value === 'true',
                        fpsNumber: document.getElementById('paymentFpsNumber').value,
                        displayName: document.getElementById('paymentFpsDisplayName').value
                    }
                },
                bookingRules: updatedBookingRules,
                pricing: {
                    normalUpTo10: Number(document.getElementById('normalUpTo10').value),
                    normalUpTo18: Number(document.getElementById('normalUpTo18').value),
                    peakUpTo10: Number(document.getElementById('peakUpTo10').value),
                    peakUpTo18: Number(document.getElementById('peakUpTo18').value),
                    peakSchedule: {
                        days: document.getElementById('peakDays').value.split(',').map(d => d.trim()).filter(Boolean),
                        startTime: document.getElementById('peakStart').value,
                        endTime: document.getElementById('peakEnd').value
                    }
                }
            };

            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/settings`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    const data = await response.json();
                    currentSettings = data.settings;
                    showMessage('settingsMessage', 'success', 'è¨­å®šå·²å„²å­˜');
                } else {
                    showMessage('settingsMessage', 'error', 'å„²å­˜å¤±æ•—');
                }
            } catch (e) {
                console.error(e);
                showMessage('settingsMessage', 'error', 'å„²å­˜éŒ¯èª¤');
            }
        }

        async function loadInstructions() {
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/settings`);
                if (!response.ok) {
                    const errorPayload = await response.json().catch(() => ({}));
                    console.error('Failed to load instructions:', response.status, errorPayload);
                    showMessage('instructionsMessage', 'error', errorPayload.error || 'ç„¡æ³•è¼‰å…¥é ç´„é ˆçŸ¥ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                    return;
                }
                const settings = await response.json();
                const instructions = settings.bookingInstructions || {};
                document.getElementById('titleZh').value = instructions.titleZh || '';
                document.getElementById('titleEn').value = instructions.titleEn || '';
                for (let i = 1; i <= 6; i++) {
                    document.getElementById(`instruction${i}Zh`).value = instructions[`instruction${i}Zh`] || '';
                    document.getElementById(`instruction${i}En`).value = instructions[`instruction${i}En`] || '';
                }
                hideMessage('instructionsMessage');
            } catch (error) {
                console.error('Error loading instructions:', error);
                showMessage('instructionsMessage', 'error', 'ç„¡æ³•è¼‰å…¥é ç´„é ˆçŸ¥ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            }
        }

        async function saveInstructions() {
            const bookingInstructions = { titleZh: document.getElementById('titleZh').value, titleEn: document.getElementById('titleEn').value };
            for (let i = 1; i <= 6; i++) {
                bookingInstructions[`instruction${i}Zh`] = document.getElementById(`instruction${i}Zh`).value;
                bookingInstructions[`instruction${i}En`] = document.getElementById(`instruction${i}En`).value;
            }
            const payload = { ...currentSettings, bookingInstructions };
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/settings`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (response.ok) {
                    currentSettings = (await response.json()).settings || payload;
                    showMessage('instructionsMessage', 'success', 'é ˆçŸ¥å·²æ›´æ–°');
                } else {
                    const result = await response.json().catch(() => ({}));
                    console.error('Failed to save instructions:', response.status, result);
                    showMessage('instructionsMessage', 'error', result.error || 'å„²å­˜å¤±æ•—');
                }
            } catch (error) {
                console.error('Error saving instructions:', error);
                showMessage('instructionsMessage', 'error', 'å„²å­˜å¤±æ•—');
            }
        }

        async function loadClasses() {
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/admin/classes?includePast=true`);
                if (!response.ok) {
                    const errorPayload = await response.json().catch(() => ({}));
                    console.error('Failed to load classes:', response.status, errorPayload);
                    showMessage('classesMessage', 'error', errorPayload.error || 'ç„¡æ³•è¼‰å…¥èª²ç¨‹è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                    return;
                }
                currentClasses = await response.json();
                renderClasses();
                hideMessage('classesMessage');
            } catch (error) {
                console.error('Error loading classes:', error);
                showMessage('classesMessage', 'error', 'ç„¡æ³•è¼‰å…¥èª²ç¨‹è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            }
        }

        function renderClasses() {
            const container = document.getElementById('classesList');
            if (!container) return;
            container.innerHTML = '';
            if (!currentClasses || currentClasses.length === 0) {
                const empty = document.createElement('div');
                empty.style.color = '#516273';
                empty.textContent = 'ç›®å‰æ²’æœ‰èª²ç¨‹';
                container.appendChild(empty);
                return;
            }

            currentClasses.forEach(cls => {
                const card = document.createElement('div');
                card.className = 'item-card';
                const start = cls.startTime ? new Date(cls.startTime) : null;
                const end = cls.endTime ? new Date(cls.endTime) : null;
                const capacity = cls.capacity || 0;
                const remaining = cls.seatsRemaining != null
                    ? cls.seatsRemaining
                    : Math.max(capacity - (cls.usedCapacity || 0), 0);
                const tags = Array.isArray(cls.tags) ? cls.tags.filter(Boolean) : [];
                const priceLine = cls.specialPriceForTwo != null
                    ? `åƒ¹æ ¼ï¼šHK$${Number(cls.price || 0).toFixed(2)} /äººï½œå…©äººåŒè¡Œ HK$${Number(cls.specialPriceForTwo).toFixed(2)}`
                    : `åƒ¹æ ¼ï¼šHK$${Number(cls.price || 0).toFixed(2)}`;
                const tagsRow = tags.length ? `<small>æ¨™ç±¤ï¼š${tags.map(tag => escapeHtml(tag)).join(', ')}</small>` : '';
                const trialLabel = cls.isTrialOnly ? '<small style="color:#f2545b;">é«”é©—é™å®š</small>' : '';

                card.innerHTML = `
                    <h4>${escapeHtml(cls.name)} ${trialLabel}</h4>
                    <small>${start ? formatDateTime(start) : ''}${end ? ' - ' + formatTime(end) : ''}</small>
                    <small>åœ°é»ï¼š${escapeHtml(cls.location || 'â€”')}</small>
                    <small>å°å¸«ï¼š${escapeHtml(cls.instructor || 'â€”')}</small>
                    <small>${priceLine}</small>
                    <small>äººæ•¸ï¼š${escapeHtml(String(capacity))}ï½œå‰©é¤˜ï¼š${escapeHtml(String(Math.max(remaining, 0)))}</small>
                    ${tagsRow}
                `;

                const actions = document.createElement('div');
                actions.className = 'item-actions';
                const editBtn = document.createElement('button');
                editBtn.className = 'btn btn-secondary';
                editBtn.textContent = 'ç·¨è¼¯';
                editBtn.addEventListener('click', () => editClass(cls));
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger';
                deleteBtn.textContent = 'åˆªé™¤';
                deleteBtn.addEventListener('click', () => deleteClass(cls.id));
                actions.appendChild(editBtn);
                actions.appendChild(deleteBtn);
                card.appendChild(actions);
                container.appendChild(card);
            });
        }

        function editClass(cls) {
            document.getElementById('classId').value = cls.id;
            document.getElementById('className').value = cls.name || '';
            document.getElementById('classInstructor').value = cls.instructor || '';
            document.getElementById('classLocation').value = cls.location || '';
            document.getElementById('classStart').value = cls.startTime ? cls.startTime.slice(0, 16) : '';
            document.getElementById('classEnd').value = cls.endTime ? cls.endTime.slice(0, 16) : '';
            document.getElementById('classPrice').value = cls.price != null ? cls.price : '';
            document.getElementById('classSpecialPriceForTwo').value = cls.specialPriceForTwo != null ? cls.specialPriceForTwo : '';
            document.getElementById('classCapacity').value = cls.capacity != null ? cls.capacity : '';
            document.getElementById('classDescription').value = cls.description || '';
            document.getElementById('classTags').value = Array.isArray(cls.tags) ? cls.tags.join(',') : '';
            document.getElementById('classIsTrialOnly').value = cls.isTrialOnly ? 'true' : 'false';
        }

        function resetClassForm() {
            const form = document.getElementById('classForm');
            if (form) form.reset();
            document.getElementById('classId').value = '';
            document.getElementById('classSpecialPriceForTwo').value = '';
            document.getElementById('classIsTrialOnly').value = 'false';
        }

        async function submitClassForm(event) {
            event.preventDefault();
            const id = document.getElementById('classId').value;
            const name = document.getElementById('className').value.trim();
            const startValue = document.getElementById('classStart').value;
            const endValue = document.getElementById('classEnd').value;
            const priceValue = Number.parseFloat(document.getElementById('classPrice').value);
            const specialPriceValueRaw = document.getElementById('classSpecialPriceForTwo').value;
            const specialPriceValue = specialPriceValueRaw === ''
                ? null
                : Number.parseFloat(specialPriceValueRaw);
            const capacityValue = Number.parseInt(document.getElementById('classCapacity').value, 10);

            if (!name) {
                showMessage('classesMessage', 'error', 'è«‹è¼¸å…¥èª²ç¨‹åç¨±');
                return;
            }
            if (!startValue || !endValue) {
                showMessage('classesMessage', 'error', 'è«‹é¸æ“‡é–‹å§‹èˆ‡çµæŸæ™‚é–“');
                return;
            }
            const startTime = new Date(startValue);
            const endTime = new Date(endValue);
            if (Number.isNaN(startTime.getTime()) || Number.isNaN(endTime.getTime())) {
                showMessage('classesMessage', 'error', 'è«‹è¼¸å…¥æœ‰æ•ˆçš„æ—¥æœŸæ™‚é–“');
                return;
            }
            if (startTime >= endTime) {
                showMessage('classesMessage', 'error', 'çµæŸæ™‚é–“éœ€æ™šæ–¼é–‹å§‹æ™‚é–“');
                return;
            }
            if (!Number.isFinite(priceValue) || priceValue < 0) {
                showMessage('classesMessage', 'error', 'è«‹è¼¸å…¥æœ‰æ•ˆçš„åƒ¹æ ¼');
                return;
            }
            if (specialPriceValue !== null && (!Number.isFinite(specialPriceValue) || specialPriceValue < 0)) {
                showMessage('classesMessage', 'error', 'å…©äººåŒè¡Œåƒ¹éœ€ç‚ºæœ‰æ•ˆæ•¸å­—');
                return;
            }
            if (!Number.isInteger(capacityValue) || capacityValue <= 0) {
                showMessage('classesMessage', 'error', 'è«‹è¼¸å…¥æœ‰æ•ˆçš„äººæ•¸ä¸Šé™');
                return;
            }

            const payload = {
                name,
                description: document.getElementById('classDescription').value,
                instructor: document.getElementById('classInstructor').value,
                location: document.getElementById('classLocation').value,
                startTime: startTime.toISOString(),
                endTime: endTime.toISOString(),
                price: priceValue,
                specialPriceForTwo: specialPriceValue,
                capacity: capacityValue,
                tags: document.getElementById('classTags').value.split(',').map(tag => tag.trim()).filter(Boolean),
                isTrialOnly: document.getElementById('classIsTrialOnly').value === 'true'
            };

            try {
                const method = id ? 'PUT' : 'POST';
                const endpoint = id ? `${API_BASE_URL}/admin/classes/${id}` : `${API_BASE_URL}/admin/classes`;
                const response = await authenticatedFetch(endpoint, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json().catch(() => ({}));
                if (response.ok) {
                    showMessage('classesMessage', 'success', 'èª²ç¨‹å·²å„²å­˜');
                    resetClassForm();
                    loadClasses();
                    loadBookingOverview(document.getElementById('overviewDate')?.value);
                } else {
                    console.error('Failed to save class:', response.status, result);
                    showMessage('classesMessage', 'error', result.error || 'å„²å­˜å¤±æ•—');
                }
            } catch (error) {
                console.error('Error saving class:', error);
                showMessage('classesMessage', 'error', 'å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }

        async function deleteClass(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤èª²ç¨‹ï¼Ÿ')) return;
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/admin/classes/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    showMessage('classesMessage', 'success', 'èª²ç¨‹å·²åˆªé™¤');
                    loadClasses();
                    loadBookingOverview(document.getElementById('overviewDate')?.value);
                } else {
                    const result = await response.json().catch(() => ({}));
                    showMessage('classesMessage', 'error', result.error || 'åˆªé™¤å¤±æ•—');
                }
            } catch (error) {
                console.error('Error deleting class:', error);
                showMessage('classesMessage', 'error', 'åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }

        async function loadClassProducts() {
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/admin/class-products`);
                if (!response.ok) {
                    const errorPayload = await response.json().catch(() => ({}));
                    console.error('Failed to load class products:', response.status, errorPayload);
                    showMessage('classProductsMessage', 'error', errorPayload.error || 'ç„¡æ³•è¼‰å…¥æ–¹æ¡ˆè³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                    return;
                }
                currentClassProducts = await response.json();
                renderClassProducts();
                hideMessage('classProductsMessage');
            } catch (error) {
                console.error('Error loading class products:', error);
                showMessage('classProductsMessage', 'error', 'ç„¡æ³•è¼‰å…¥æ–¹æ¡ˆè³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            }
        }

        function renderClassProducts() {
            const container = document.getElementById('classProductsList');
            if (!container) return;
            container.innerHTML = '';
            if (!currentClassProducts || currentClassProducts.length === 0) {
                const empty = document.createElement('div');
                empty.style.color = '#516273';
                empty.textContent = 'ç›®å‰æ²’æœ‰æ–¹æ¡ˆ';
                container.appendChild(empty);
                return;
            }

            currentClassProducts.forEach(product => {
                const card = document.createElement('div');
                card.className = 'item-card';
                const typeLabel = product.type === 'trial' ? 'é«”é©—æ–¹æ¡ˆ' : 'èª²ç¨‹æ–¹æ¡ˆ';
                card.innerHTML = `
                    <h4>${escapeHtml(product.name)} <small>(${typeLabel})</small></h4>
                    <small>åƒ¹æ ¼ï¼šHK$${Number(product.price || 0).toFixed(2)}ï½œå ‚æ•¸ï¼š${escapeHtml(String(product.numberOfClasses || 0))}</small>
                    <small>æœ‰æ•ˆæœŸï¼š${product.validityPeriodDays ? `${escapeHtml(String(product.validityPeriodDays))} å¤©` : 'â€”'}</small>
                    <small>${escapeHtml(product.description || 'ç„¡ä»‹ç´¹')}</small>
                `;

                const actions = document.createElement('div');
                actions.className = 'item-actions';
                const editBtn = document.createElement('button');
                editBtn.className = 'btn btn-secondary';
                editBtn.textContent = 'ç·¨è¼¯';
                editBtn.addEventListener('click', () => editClassProduct(product));
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger';
                deleteBtn.textContent = 'åˆªé™¤';
                deleteBtn.addEventListener('click', () => deleteClassProduct(product.id));
                actions.appendChild(editBtn);
                actions.appendChild(deleteBtn);
                card.appendChild(actions);
                container.appendChild(card);
            });
        }

        function editClassProduct(product) {
            document.getElementById('classProductId').value = product.id;
            document.getElementById('classProductType').value = product.type || 'package';
            document.getElementById('classProductName').value = product.name || '';
            document.getElementById('classProductPrice').value = product.price != null ? product.price : '';
            document.getElementById('classProductCount').value = product.numberOfClasses || '';
            document.getElementById('classProductValidity').value = product.validityPeriodDays != null ? product.validityPeriodDays : '';
            document.getElementById('classProductDescription').value = product.description || '';
        }

        function resetClassProductForm() {
            const form = document.getElementById('classProductForm');
            if (form) form.reset();
            document.getElementById('classProductId').value = '';
            document.getElementById('classProductType').value = 'package';
        }

        async function submitClassProductForm(event) {
            event.preventDefault();
            const id = document.getElementById('classProductId').value;
            const name = document.getElementById('classProductName').value.trim();
            const priceValue = Number.parseFloat(document.getElementById('classProductPrice').value);
            const countValue = Number.parseInt(document.getElementById('classProductCount').value, 10);
            const validityValueRaw = document.getElementById('classProductValidity').value;
            const validityValue = validityValueRaw ? Number.parseInt(validityValueRaw, 10) : null;

            if (!name) {
                showMessage('classProductsMessage', 'error', 'è«‹è¼¸å…¥æ–¹æ¡ˆåç¨±');
                return;
            }
            if (!Number.isFinite(priceValue) || priceValue < 0) {
                showMessage('classProductsMessage', 'error', 'è«‹è¼¸å…¥æœ‰æ•ˆçš„åƒ¹æ ¼');
                return;
            }
            if (!Number.isInteger(countValue) || countValue <= 0) {
                showMessage('classProductsMessage', 'error', 'è«‹è¼¸å…¥æœ‰æ•ˆçš„å ‚æ•¸');
                return;
            }
            if (validityValueRaw && (!Number.isInteger(validityValue) || validityValue <= 0)) {
                showMessage('classProductsMessage', 'error', 'æœ‰æ•ˆæœŸéœ€ç‚ºæ­£æ•´æ•¸');
                return;
            }

            const payload = {
                type: document.getElementById('classProductType').value,
                name,
                description: document.getElementById('classProductDescription').value,
                price: priceValue,
                numberOfClasses: countValue,
                validityPeriodDays: validityValue
            };

            try {
                const method = id ? 'PUT' : 'POST';
                const endpoint = id ? `${API_BASE_URL}/admin/class-products/${id}` : `${API_BASE_URL}/admin/class-products`;
                const response = await authenticatedFetch(endpoint, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json().catch(() => ({}));
                if (response.ok) {
                    showMessage('classProductsMessage', 'success', 'æ–¹æ¡ˆå·²å„²å­˜');
                    resetClassProductForm();
                    loadClassProducts();
                } else {
                    console.error('Failed to save class product:', response.status, result);
                    showMessage('classProductsMessage', 'error', result.error || 'å„²å­˜å¤±æ•—');
                }
            } catch (error) {
                console.error('Error saving class product:', error);
                showMessage('classProductsMessage', 'error', 'å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }

        async function deleteClassProduct(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ–¹æ¡ˆï¼Ÿ')) return;
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/admin/class-products/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    showMessage('classProductsMessage', 'success', 'æ–¹æ¡ˆå·²åˆªé™¤');
                    loadClassProducts();
                } else {
                    const result = await response.json().catch(() => ({}));
                    showMessage('classProductsMessage', 'error', result.error || 'åˆªé™¤å¤±æ•—');
                }
            } catch (error) {
                console.error('Error deleting class product:', error);
                showMessage('classProductsMessage', 'error', 'åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }

        async function loadRentalItems() {
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/admin/items`);
                if (!response.ok) {
                    const errorPayload = await response.json().catch(() => ({}));
                    console.error('Failed to load rental items:', response.status, errorPayload);
                    showMessage('rentalItemsMessage', 'error', errorPayload.error || 'ç„¡æ³•è¼‰å…¥å ´åœ°é …ç›®ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                    return;
                }
                const items = await response.json();
                currentRentalItems = (items || []).filter(item => item.type === 'room_rental');
                renderRentalItems();
                hideMessage('rentalItemsMessage');
            } catch (error) {
                console.error('Error loading rental items:', error);
                showMessage('rentalItemsMessage', 'error', 'ç„¡æ³•è¼‰å…¥å ´åœ°é …ç›®ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            }
        }

        function renderRentalItems() {
            const container = document.getElementById('rentalItemsList');
            if (!container) return;
            container.innerHTML = '';
            if (!currentRentalItems || currentRentalItems.length === 0) {
                const empty = document.createElement('div');
                empty.style.color = '#516273';
                empty.textContent = 'ç›®å‰æ²’æœ‰å ´åœ°é …ç›®';
                container.appendChild(empty);
                return;
            }

            currentRentalItems.forEach(item => {
                const card = document.createElement('div');
                card.className = 'item-card';
                const start = item.startDateTime ? new Date(item.startDateTime) : null;
                const end = item.endDateTime ? new Date(item.endDateTime) : null;
                const remaining = item.availableCapacity != null
                    ? item.availableCapacity
                    : Math.max((item.capacity || 0) - (item.usedCapacity || 0), 0);
                card.innerHTML = `
                    <h4>${escapeHtml(item.name)}</h4>
                    <small>${start ? formatDateTime(start) : ''}${end ? ' - ' + formatTime(end) : ''}</small>
                    <small>æ™‚é•·ï¼š${escapeHtml(String(item.duration || 0))} åˆ†é˜ï½œåƒ¹éŒ¢ï¼šHK$${Number(item.price || 0).toFixed(2)}</small>
                    <small>äººæ•¸ä¸Šé™ï¼š${escapeHtml(String(item.capacity || 0))}ï½œå‰©é¤˜ï¼š${escapeHtml(String(Math.max(remaining, 0)))}</small>
                `;

                const actions = document.createElement('div');
                actions.className = 'item-actions';
                const editBtn = document.createElement('button');
                editBtn.className = 'btn btn-secondary';
                editBtn.textContent = 'ç·¨è¼¯';
                editBtn.addEventListener('click', () => editRentalItem(item));
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger';
                deleteBtn.textContent = 'åˆªé™¤';
                deleteBtn.addEventListener('click', () => deleteRentalItem(item.id));
                actions.appendChild(editBtn);
                actions.appendChild(deleteBtn);
                card.appendChild(actions);
                container.appendChild(card);
            });
        }

        function editRentalItem(item) {
            document.getElementById('rentalItemId').value = item.id;
            document.getElementById('rentalItemName').value = item.name || '';
            document.getElementById('rentalItemStart').value = item.startDateTime ? item.startDateTime.slice(0, 16) : '';
            document.getElementById('rentalItemEnd').value = item.endDateTime ? item.endDateTime.slice(0, 16) : '';
            document.getElementById('rentalItemDuration').value = item.duration || '';
            document.getElementById('rentalItemPrice').value = item.price != null ? item.price : '';
            document.getElementById('rentalItemInstructor').value = item.instructorName || '';
            document.getElementById('rentalItemCapacity').value = item.capacity != null ? item.capacity : '';
        }

        function resetRentalItemForm() {
            const form = document.getElementById('rentalItemForm');
            if (form) form.reset();
            document.getElementById('rentalItemId').value = '';
        }

        async function submitRentalItemForm(event) {
            event.preventDefault();
            const id = document.getElementById('rentalItemId').value;
            const name = document.getElementById('rentalItemName').value.trim();
            const startDateTime = document.getElementById('rentalItemStart').value;
            const endDateTime = document.getElementById('rentalItemEnd').value;
            const durationValue = Number.parseInt(document.getElementById('rentalItemDuration').value, 10);
            const priceValue = Number.parseFloat(document.getElementById('rentalItemPrice').value);
            const capacityValue = Number.parseInt(document.getElementById('rentalItemCapacity').value, 10);

            if (!name) {
                showMessage('rentalItemsMessage', 'error', 'è«‹è¼¸å…¥é …ç›®åç¨±');
                return;
            }
            if (!startDateTime || !endDateTime) {
                showMessage('rentalItemsMessage', 'error', 'è«‹é¸æ“‡é–‹å§‹èˆ‡çµæŸæ™‚é–“');
                return;
            }
            const rentalStart = new Date(startDateTime);
            const rentalEnd = new Date(endDateTime);
            if (Number.isNaN(rentalStart.getTime()) || Number.isNaN(rentalEnd.getTime())) {
                showMessage('rentalItemsMessage', 'error', 'è«‹è¼¸å…¥æœ‰æ•ˆçš„æ—¥æœŸæ™‚é–“');
                return;
            }
            if (rentalStart >= rentalEnd) {
                showMessage('rentalItemsMessage', 'error', 'çµæŸæ™‚é–“éœ€æ™šæ–¼é–‹å§‹æ™‚é–“');
                return;
            }
            if (!Number.isInteger(durationValue) || durationValue <= 0) {
                showMessage('rentalItemsMessage', 'error', 'è«‹è¼¸å…¥æœ‰æ•ˆçš„æ™‚é•·');
                return;
            }
            if (!Number.isFinite(priceValue) || priceValue < 0) {
                showMessage('rentalItemsMessage', 'error', 'è«‹è¼¸å…¥æœ‰æ•ˆçš„åƒ¹æ ¼');
                return;
            }
            if (!Number.isInteger(capacityValue) || capacityValue <= 0) {
                showMessage('rentalItemsMessage', 'error', 'è«‹è¼¸å…¥æœ‰æ•ˆçš„äººæ•¸ä¸Šé™');
                return;
            }

            const payload = {
                type: 'room_rental',
                name,
                startDateTime,
                endDateTime,
                duration: durationValue,
                price: priceValue,
                instructorName: document.getElementById('rentalItemInstructor').value,
                capacity: capacityValue
            };

            try {
                const method = id ? 'PUT' : 'POST';
                const endpoint = id ? `${API_BASE_URL}/admin/items/${id}` : `${API_BASE_URL}/admin/items`;
                const response = await authenticatedFetch(endpoint, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json().catch(() => ({}));
                if (response.ok) {
                    showMessage('rentalItemsMessage', 'success', 'å ´åœ°é …ç›®å·²å„²å­˜');
                    resetRentalItemForm();
                    loadRentalItems();
                } else {
                    console.error('Failed to save rental item:', response.status, result);
                    showMessage('rentalItemsMessage', 'error', result.error || 'å„²å­˜å¤±æ•—');
                }
            } catch (error) {
                console.error('Error saving rental item:', error);
                showMessage('rentalItemsMessage', 'error', 'å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }

        async function deleteRentalItem(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å ´åœ°é …ç›®ï¼Ÿ')) return;
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/admin/items/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    showMessage('rentalItemsMessage', 'success', 'å ´åœ°é …ç›®å·²åˆªé™¤');
                    loadRentalItems();
                } else {
                    const result = await response.json().catch(() => ({}));
                    showMessage('rentalItemsMessage', 'error', result.error || 'åˆªé™¤å¤±æ•—');
                }
            } catch (error) {
                console.error('Error deleting rental item:', error);
                showMessage('rentalItemsMessage', 'error', 'åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }

        function formatDateTime(date) { return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${formatTime(date)}`; }
        function formatTime(date) { return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`; }

        function hideMessage(elementId) {
            const el = document.getElementById(elementId);
            if (!el) return;
            el.className = 'message';
            el.textContent = '';
            el.style.display = 'none';
        }

        function showMessage(elementId, type, message) {
            const el = document.getElementById(elementId);
            if (!el) return;
            el.className = `message ${type}`;
            el.textContent = message;
            el.style.display = 'block';
            if (type === 'success') {
                setTimeout(() => { el.style.display = 'none'; }, 4000);
            }
        }

        // --- New Features ---

        function exportCsv() {
            const token = localStorage.getItem('adminToken');
            window.open(`${API_BASE_URL}/admin/reports/csv?token=${token}`, '_blank');
        }

        let calendar;
        function initCalendar() {
            const calendarEl = document.getElementById('calendar');
            if (!calendarEl) return;

            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: async function (info, successCallback, failureCallback) {
                    try {
                        const [bookingsRes, classesRes] = await Promise.all([
                            authenticatedFetch(`${API_BASE_URL}/bookings`),
                            authenticatedFetch(`${API_BASE_URL}/admin/class-bookings`)
                        ]);

                        const events = [];

                        if (bookingsRes.ok) {
                            const bookings = await bookingsRes.json();
                            bookings.forEach(b => {
                                (b.items || []).forEach(item => {
                                    events.push({
                                        id: `rental-${b.id}`,
                                        title: `${b.customerName} (${item.startTime}-${item.endTime})`,
                                        start: `${item.date}T${item.startTime}`,
                                        end: `${item.date}T${item.endTime}`,
                                        backgroundColor: b.status === 'confirmed' ? '#28a745' : '#ffc107',
                                        borderColor: b.status === 'confirmed' ? '#28a745' : '#ffc107',
                                        extendedProps: { type: 'rental', data: b }
                                    });
                                });
                            });
                        }

                        if (classesRes.ok) {
                            const classBookings = await classesRes.json();
                            classBookings.forEach(cb => {
                                events.push({
                                    id: `class-${cb.id}`,
                                    title: `${cb.className} (${cb.customerName})`,
                                    start: cb.classStartTime,
                                    end: cb.classEndTime,
                                    backgroundColor: cb.status === 'confirmed' ? '#007bff' : '#6c757d',
                                    borderColor: cb.status === 'confirmed' ? '#007bff' : '#6c757d',
                                    extendedProps: { type: 'class', data: cb }
                                });
                            });
                        }

                        successCallback(events);
                    } catch (e) {
                        failureCallback(e);
                    }
                },
                dateClick: async function (info) {
                    if (confirm(`è¦åœ¨ ${info.dateStr} å»ºç«‹"ç¶­è­·"å°é–æ™‚æ®µå—ï¼Ÿ`)) {
                        // Quick Block
                        // Create dummy booking
                        try {
                            const res = await authenticatedFetch(`${API_BASE_URL}/bookings`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    customerName: 'Maintenance',
                                    email: 'admin@studio.com',
                                    phone: '00000000',
                                    date: info.dateStr,
                                    startTime: '00:00',
                                    endTime: '23:59',
                                    itemType: 'room_rental',
                                    deposit: 0,
                                    paymentMethod: 'cash',
                                    adminNotes: 'Quick Block',
                                    status: 'confirmed' // Auto-confirm for quick block
                                })
                            });
                            if (res.ok) {
                                showMessage('bookingsMessage', 'success', 'å·²æˆåŠŸå°é–æ™‚æ®µ');
                                calendar.refetchEvents();
                                loadRentalBookings(); // Refresh bookings table
                            } else {
                                const errorData = await res.json();
                                showMessage('bookingsMessage', 'error', errorData.error || 'å°é–å¤±æ•—');
                            }
                        } catch (e) {
                            console.error('Failed to block:', e);
                            showMessage('bookingsMessage', 'error', 'å°é–å¤±æ•—');
                        }
                    }
                },
                eventClick: function (info) {
                    const props = info.event.extendedProps;
                    let msg = "";
                    if (props.type === 'rental') {
                        const b = props.data;
                        msg = `é ç´„ç·¨è™Ÿ: ${b.id}\nå®¢æˆ¶: ${b.customerName}\nç‹€æ…‹: ${b.status}\nå‚™è¨»: ${b.adminNotes || ''}`;
                    } else if (props.type === 'class') {
                        const cb = props.data;
                        msg = `èª²ç¨‹é ç´„ç·¨è™Ÿ: ${cb.id}\nèª²ç¨‹åç¨±: ${cb.className}\nå®¢æˆ¶: ${cb.customerName}\nç‹€æ…‹: ${cb.status}`;
                    }
                    alert(msg);
                }
            });
            calendar.render();
        }

        // Notes Modal Logic
        function openNotesModal(id, currentNote) {
            document.getElementById('noteBookingId').value = id;
            document.getElementById('noteText').value = currentNote || '';
            const modal = document.getElementById('notesModal');
            modal.style.display = 'block';
            modal.classList.add('show');
        }

        function closeNotesModal() {
            document.getElementById('notesModal').style.display = 'none';
            document.getElementById('notesModal').classList.remove('show');
        }

        async function saveNote() {
            const id = document.getElementById('noteBookingId').value;
            const note = document.getElementById('noteText').value;

            try {
                const res = await authenticatedFetch(`${API_BASE_URL}/bookings/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ adminNotes: note })
                });

                if (res.ok) {
                    closeNotesModal();
                    loadRentalBookings(); // Refresh table
                    if (calendar) calendar.refetchEvents();
                } else {
                    const errorData = await res.json();
                    alert(errorData.error || 'å„²å­˜å¤±æ•—');
                }
            } catch (e) {
                console.error(e);
                alert('éŒ¯èª¤');
            }
        }

        async function exportCsv() {
            try {
                const res = await authenticatedFetch(`${API_BASE_URL}/admin/reports/csv`);
                if (res.ok) {
                    const blob = await res.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `bookings_report_${new Date().toISOString().slice(0, 7)}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                } else {
                    const errorData = await res.json();
                    alert(errorData.error || 'åŒ¯å‡ºå¤±æ•—');
                }
            } catch (e) { console.error(e); alert('åŒ¯å‡ºéŒ¯èª¤'); }
        }

        function handleTabClick(event) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            const targetId = event.target.dataset.tab;
            document.getElementById(targetId).classList.add('active');
            if (targetId === 'overviewTab') {
                setOverviewDateToToday();
                loadBookingOverview(document.getElementById('overviewDate')?.value);
            } else if (targetId === 'calendarTab') {
                // Delay slightly to ensure visibility for rendering
                setTimeout(() => {
                    if (!calendar) initCalendar();
                    else calendar.render();
                }, 50);
            }
        }
    </script>
</body>

</html>