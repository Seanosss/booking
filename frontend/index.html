<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studio Booking System å°ˆæ¥­éŒ„éŸ³å®¤é ç´„ç³»çµ±</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Microsoft JhengHei', 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: #EDEDE9; color: #2c2c2c; min-height: 100vh; padding: 20px; }
        a { color: #0b4f6c; }
        .language-toggle { position: fixed; top: 20px; right: 20px; z-index: 1000; display: flex; gap: 10px; background: rgba(255,255,255,0.95); padding: 5px; border-radius: 25px; box-shadow: 0 8px 20px rgba(0,0,0,0.12); }
        .lang-btn { padding: 8px 20px; background: transparent; border: none; border-radius: 20px; cursor: pointer; transition: all 0.3s; font-weight: 500; color: #333; }
        .lang-btn.active { background: linear-gradient(135deg,#0b4f6c 0%,#145da0 100%); color: #fff; }
        .container { max-width: 1100px; margin: 60px auto 40px; background: rgba(255,255,255,0.98); border-radius: 24px; box-shadow: 0 28px 60px rgba(0,0,0,0.15); overflow: hidden; }
        .header { background: linear-gradient(135deg,#145da0 0%,#0b4f6c 100%); color: #fff; padding: 50px 40px; text-align: center; }
        .header h1 { font-size: 2.3em; font-weight: 600; letter-spacing: 1px; margin-bottom: 10px; }
        .header p { font-size: 1.05em; opacity: 0.95; }
        .booking-content { padding: 40px 40px 50px; background: rgba(255,255,255,0.9); }
        .section { margin-bottom: 32px; }
        .section-title { color: #145da0; font-size: 1.45em; margin-bottom: 18px; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .panel { background: #f8f9fb; border-radius: 18px; padding: 24px; box-shadow: inset 0 0 0 1px rgba(20,93,160,0.06); }
        .grid-two-columns { display: grid; gap: 24px; }
        @media (min-width: 860px) { .grid-two-columns { grid-template-columns: 2fr 1fr; } }
        .date-input { width: 100%; padding: 14px 16px; border: 2px solid #d6dde6; border-radius: 12px; font-size: 1em; background: #fff; color: #2c2c2c; transition: all 0.3s; }
        .date-input:focus, .form-input:focus, textarea:focus, .form-select:focus { border-color: #145da0; outline: none; box-shadow: 0 0 0 4px rgba(20,93,160,0.15); }
        .time-slots { display: grid; grid-template-columns: repeat(auto-fill,minmax(90px,1fr)); gap: 10px; margin-top: 16px; }
        .time-slot { padding: 10px 6px; border: 2px solid #e2e7ef; border-radius: 10px; text-align: center; font-weight: 600; font-size: 0.9em; background: #fff; cursor: pointer; transition: all 0.25s; }
        .time-slot:hover:not(.unavailable):not(.pending) { border-color: #145da0; background: #ecf2fb; transform: translateY(-2px); }
        .time-slot.selected { background: linear-gradient(135deg,#145da0 0%,#0b4f6c 100%); color: #fff; border-color: #0b4f6c; }
        .time-slot.in-range { background: #dce7f7; border-color: #0b4f6c; }
        .time-slot.unavailable { background: #f0f0f0; color: #9aa5b1; cursor: not-allowed; text-decoration: line-through; }
        .time-slot.pending { background: #fff3cd; color: #856404; border-color: #f2c94c; cursor: not-allowed; }
        .slot-instruction { background: #ecf2fb; padding: 16px; border-radius: 12px; margin: 18px 0; border-left: 4px solid #145da0; color: #0b4f6c; }
        .legend { display: flex; gap: 16px; flex-wrap: wrap; font-size: 0.9em; color: #516273; margin-top: 18px; }
        .legend-box { width: 16px; height: 16px; border: 1px solid #d6dde6; border-radius: 4px; display: inline-block; }
        .form-group { margin-bottom: 18px; }
        .form-label { display: block; margin-bottom: 8px; color: #495057; font-weight: 600; }
        .form-input, .form-select, textarea { width: 100%; padding: 12px 14px; border: 2px solid #d6dde6; border-radius: 12px; font-size: 1em; background: #fff; color: #2c2c2c; transition: all 0.3s; }
        .add-session-btn, .catalog-actions button, .submit-btn { background: linear-gradient(135deg,#0b4f6c 0%,#145da0 100%); color: #fff; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .add-session-btn { width: 100%; padding: 14px; margin-top: 12px; }
        .add-session-btn:disabled, .catalog-actions button:disabled, .submit-btn:disabled { background: #b8c5d6; cursor: not-allowed; box-shadow: none; }
        .add-session-btn:not(:disabled):hover, .catalog-actions button:not(:disabled):hover, .submit-btn:not(:disabled):hover { transform: translateY(-2px); box-shadow: 0 12px 24px rgba(11,79,108,0.25); }
        .cart { display: flex; flex-direction: column; gap: 15px; }
        .cart-item { background: #fff; border-radius: 14px; padding: 16px; border: 1px solid #dbe2ed; box-shadow: 0 6px 18px rgba(0,0,0,0.05); position: relative; }
        .cart-item-title { font-weight: 600; color: #0b4f6c; margin-bottom: 6px; }
        .cart-item-meta { font-size: 0.9em; color: #57606c; line-height: 1.6; }
        .remove-btn { position: absolute; top: 12px; right: 12px; border: none; background: #f2545b; color: #fff; padding: 6px 10px; border-radius: 18px; font-size: 0.8em; cursor: pointer; }
        .summary-card { background: #fff; border-radius: 18px; padding: 22px; border: 1px solid #dbe2ed; }
        .summary-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #edf1f7; color: #43566a; }
        .summary-row.total { font-size: 1.2em; font-weight: 700; color: #0b4f6c; border-bottom: none; padding-top: 14px; }
        .instructions { background: #fff7e6; border: 1px solid #f2c94c; border-radius: 14px; padding: 22px; margin-bottom: 30px; }
        .instructions h4 { color: #b07902; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .instructions ol { margin-left: 20px; color: #b07902; line-height: 1.7; }
        .item-list { display: grid; gap: 18px; }
        @media (min-width: 720px) { .item-list { grid-template-columns: repeat(2,1fr); } }
        .catalog-card { background: #f8f9fb; border-radius: 16px; padding: 18px; border: 1px solid rgba(20,93,160,0.1); box-shadow: 0 10px 18px rgba(0,0,0,0.06); display: flex; flex-direction: column; gap: 10px; }
        .catalog-card h3 { color: #0b4f6c; font-size: 1.2em; }
        .catalog-meta { font-size: 0.92em; color: #516273; line-height: 1.5; }
        .catalog-actions { display: flex; gap: 10px; align-items: center; }
        .catalog-actions input { width: 90px; padding: 8px 10px; border: 2px solid #d6dde6; border-radius: 10px; }
        .catalog-actions button { flex: 1; padding: 10px 12px; border-radius: 10px; }
        .submit-btn { width: 100%; padding: 18px; font-size: 1.08em; letter-spacing: 0.5px; margin-top: 18px; }
        .success-message, .error-message { padding: 15px 18px; border-radius: 12px; margin-bottom: 18px; font-weight: 600; display: none; }
        .success-message { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error-message { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        @media (max-width: 768px) { .container { margin: 90px 0 20px; border-radius: 0; box-shadow: none; } .booking-content { padding: 30px 22px 40px; } .time-slots { grid-template-columns: repeat(3,1fr); } .language-toggle { top: 10px; right: 10px; } }
    </style>
</head>
<body>
    <div class="language-toggle">
        <button class="lang-btn active" onclick="setLanguage('zh')" id="zh-btn">ä¸­æ–‡</button>
        <button class="lang-btn" onclick="setLanguage('en')" id="en-btn">English</button>
    </div>
    <div class="container">
        <div class="header">
            <h1 id="main-title">å°ˆæ¥­éŒ„éŸ³å®¤é ç´„ç³»çµ±</h1>
            <p id="sub-title">å°ˆæ¥­éŒ„éŸ³å®¤ â€¢ æ¯æ—¥ç‡Ÿæ¥­</p>
        </div>
        <div class="booking-content">
            <div id="success-message" class="success-message"></div>
            <div id="error-message" class="error-message"></div>
            <div class="instructions">
                <h4><span>âš ï¸</span><span id="instructions-title">é‡è¦é ç´„é ˆçŸ¥</span></h4>
                <ol id="instructions-list">
                    <li id="instruction-1">é¸æ“‡æ‚¨æƒ³è¦çš„æ—¥æœŸ</li>
                    <li id="instruction-2">é»æ“Šé–‹å§‹æ™‚æ®µï¼Œå†é»æ“ŠçµæŸæ™‚æ®µï¼ˆå¯é¸æ“‡å¤šå€‹é€£çºŒæ™‚æ®µï¼‰</li>
                    <li id="instruction-3">å¡«å¯«æ‚¨çš„è¯çµ¡è³‡æ–™</li>
                    <li id="instruction-4">é€ééŠ€è¡Œè½‰å¸³æˆ– PayMe ä»˜æ¬¾</li>
                    <li id="instruction-5">å°‡ä»˜æ¬¾è­‰æ˜å‚³é€è‡³ WhatsApp: 98725268</li>
                    <li id="instruction-6">æ‚¨çš„é ç´„å°‡åœ¨ 30 åˆ†é˜å…§ç¢ºèª</li>
                </ol>
            </div>
            <div class="section grid-two-columns">
                <div class="panel">
                    <h2 class="section-title"><span>ğŸ“…</span><span id="date-title">é¸æ“‡æ—¥æœŸ</span></h2>
                    <input type="date" id="date-input" class="date-input" onchange="handleDateChange(this.value)">
                    <div id="time-section" style="display:none;margin-top:20px;">
                        <h2 class="section-title"><span>â°</span><span id="time-title">é¸æ“‡æ™‚æ®µ</span></h2>
                        <div class="slot-instruction">
                            <p><strong id="select-method">é¸æ“‡æ–¹å¼ï¼š</strong></p>
                            <p id="select-step1">1. é»æ“Šç¬¬ä¸€å€‹æ™‚æ®µï¼ˆé–‹å§‹æ™‚é–“ï¼‰</p>
                            <p id="select-step2">2. å†é»æ“Šæœ€å¾Œä¸€å€‹æ™‚æ®µï¼ˆçµæŸæ™‚é–“ï¼‰</p>
                            <p id="select-step3">3. ç³»çµ±æœƒè‡ªå‹•é¸å–ä¸­é–“çš„æ‰€æœ‰æ™‚æ®µ</p>
                        </div>
                        <div id="time-slots" class="time-slots"></div>
                        <div class="legend">
                            <span><span class="legend-box" style="background:#f0f0f0;"></span><span id="legend-confirmed">å·²ç¢ºèª</span></span>
                            <span><span class="legend-box" style="background:#fff3cd;border-color:#f2c94c;"></span><span id="legend-pending">å¾…ç¢ºèª</span></span>
                            <span><span class="legend-box" style="background:#fff;border-color:#145da0;"></span><span id="legend-available">å¯é ç´„</span></span>
                        </div>
                        <div class="form-group" style="margin-top:20px;">
                            <label class="form-label" for="people-count" id="people-label">åƒèˆ‡äººæ•¸ *</label>
                            <input type="number" id="people-count" class="form-input" min="1" max="18" value="4">
                        </div>
                        <button class="add-session-btn" id="add-session-btn" onclick="addSelectedSessionToCart()" disabled><span id="add-session-text">åŠ å…¥è³¼ç‰©è»Š</span></button>
                    </div>
                </div>
                <div class="panel">
                    <h2 class="section-title"><span>ğŸ›’</span><span id="cart-title">é ç´„è³¼ç‰©è»Š</span></h2>
                    <div id="cart" class="cart"></div>
                    <div class="summary-card" style="margin-top:20px;">
                        <div class="summary-row"><span id="summary-items-label">å·²é¸æ“‡é …ç›®ï¼š</span><span id="summary-items">0</span></div>
                        <div class="summary-row"><span id="summary-people-label">ç¸½äººæ•¸ï¼š</span><span id="summary-people">0</span></div>
                        <div class="summary-row total"><span id="total-label">ç¸½é‡‘é¡ï¼š</span><span>HK$<span id="total-amount">0</span></span></div>
                    </div>
                </div>
            </div>
            <div class="section" id="catalog-section">
                <h2 class="section-title"><span>ğŸ¶</span><span id="workshop-title">èª²ç¨‹ / å·¥ä½œåŠ</span></h2>
                <div id="workshop-list" class="item-list"></div>
                <h2 class="section-title" style="margin-top:32px;"><span>ğŸ¢</span><span id="rental-title">å ´åœ°ç§Ÿç”¨é¸é …</span></h2>
                <div id="rental-list" class="item-list"></div>
            </div>
            <div class="section" id="contact-section" style="display:none;">
                <div class="panel">
                    <h2 class="section-title"><span>ğŸ‘¤</span><span id="info-title">è¯çµ¡è³‡æ–™</span></h2>
                    <form id="booking-form">
                        <div class="form-group"><label class="form-label" for="customerName" id="name-label">å§“å *</label><input type="text" id="customerName" class="form-input" required></div>
                        <div class="form-group"><label class="form-label" for="email" id="email-label">é›»å­éƒµä»¶ *</label><input type="email" id="email" class="form-input" required></div>
                        <div class="form-group"><label class="form-label" for="phone" id="phone-label">é›»è©±è™Ÿç¢¼ (WhatsApp) *</label><input type="tel" id="phone" class="form-input" placeholder="ä¾‹å¦‚ï¼š98765432" required></div>
                        <div class="form-group"><label class="form-label" for="notes" id="notes-label">ç‰¹æ®Šè¦æ±‚ï¼ˆé¸å¡«ï¼‰</label><textarea id="notes" class="form-input" rows="3" placeholder="ä»»ä½•ç‰¹æ®Šè¨­å‚™æˆ–è¨­ç½®éœ€æ±‚..."></textarea></div>
                        <div class="panel" style="background:#fff;border:1px solid #dbe2ed;margin-bottom:18px;">
                            <h3 style="color:#145da0;margin-bottom:12px;text-align:center;" id="payment-title">ä»˜æ¬¾æ–¹å¼</h3>
                            <div id="payment-info"></div>
                        </div>
                        <button type="submit" class="submit-btn" id="submit-btn" disabled><span id="submit-btn-text">ç¢ºèªé ç´„ç”³è«‹</span></button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <script>
        const API_BASE_URL = (() => {
            const DEFAULT_API_PATH = '/api';
            const DEFAULT_ORIGIN = (window.location.origin && window.location.origin !== 'null') ? window.location.origin : 'http://localhost:3000';
            const resolveUrl = (value) => { if (!value) return null; try { return new URL(value, DEFAULT_ORIGIN).toString().replace(/\/+$/, ''); } catch (error) { console.warn('Ignoring invalid API base URL:', value, error); return null; } };
            const params = new URLSearchParams(window.location.search);
            const queryOverride = params.get('apiBaseUrl') || params.get('api_base_url');
            if (queryOverride) {
                const queryUrl = resolveUrl(queryOverride);
                if (queryUrl) {
                    try { localStorage.setItem('booking.apiBaseUrl', queryUrl); } catch (error) { console.warn('Unable to persist API base URL override:', error); }
                    return queryUrl;
                }
            }
            try {
                const stored = resolveUrl(localStorage.getItem('booking.apiBaseUrl'));
                if (stored) return stored;
            } catch (error) { console.warn('Unable to read stored API base URL override:', error); }
            const inlineConfig = resolveUrl(window.__BOOKING_CONFIG__?.apiBaseUrl);
            if (inlineConfig) return inlineConfig;
            const metaTag = document.querySelector('meta[name="api-base-url"]');
            const metaUrl = resolveUrl(metaTag?.content);
            if (metaUrl) return metaUrl;
            return `${DEFAULT_ORIGIN}${DEFAULT_API_PATH}`.replace(/\/+$/, '');
        })();
        let SETTINGS = {};
        let CATALOG = { workshops: [], roomRentals: [] };
        let AVAILABILITY = { confirmedSlots: [], pendingSlots: [] };
        let currentLanguage = 'zh';
        let selectedDate = null;
        let selection = { start: null, end: null };
        let cartItems = [];
        let itemCounter = 0;
        function timesOverlap(startA, endA, startB, endB) {
            return timeToMinutes(startA) < timeToMinutes(endB) && timeToMinutes(endA) > timeToMinutes(startB);
        }
        function hasRoomRentalConflict(date, startTime, endTime) {
            return cartItems.some(item => item.type === 'room_rental' && item.date === date && timesOverlap(startTime, endTime, item.startTime, item.endTime));
        }
        function getCartUsageForCatalogItem(id) {
            if (!id) return 0;
            return cartItems
                .filter(item => item.catalogItemId === id)
                .reduce((sum, item) => sum + Number(item.peopleCount || 0), 0);
        }
        const translations = {
            zh: { 'main-title': 'å°ˆæ¥­éŒ„éŸ³å®¤é ç´„ç³»çµ±', 'sub-title': 'å°ˆæ¥­éŒ„éŸ³å®¤ â€¢ æ¯æ—¥ç‡Ÿæ¥­', 'instructions-title': 'é‡è¦é ç´„é ˆçŸ¥', 'date-title': 'é¸æ“‡æ—¥æœŸ', 'time-title': 'é¸æ“‡æ™‚æ®µ', 'info-title': 'è¯çµ¡è³‡æ–™', 'workshop-title': 'èª²ç¨‹ / å·¥ä½œåŠ', 'rental-title': 'å ´åœ°ç§Ÿç”¨é¸é …', 'name-label': 'å§“å *', 'email-label': 'é›»å­éƒµä»¶ *', 'phone-label': 'é›»è©±è™Ÿç¢¼ (WhatsApp) *', 'notes-label': 'ç‰¹æ®Šè¦æ±‚ï¼ˆé¸å¡«ï¼‰', 'legend-confirmed': 'å·²ç¢ºèª', 'legend-pending': 'å¾…ç¢ºèª', 'legend-available': 'å¯é ç´„', 'people-label': 'åƒèˆ‡äººæ•¸ *', 'cart-title': 'é ç´„è³¼ç‰©è»Š', 'summary-items-label': 'å·²é¸æ“‡é …ç›®ï¼š', 'summary-people-label': 'ç¸½äººæ•¸ï¼š', 'total-label': 'ç¸½é‡‘é¡ï¼š', 'add-session-text': 'åŠ å…¥è³¼ç‰©è»Š', 'submit-btn-text': 'ç¢ºèªé ç´„ç”³è«‹', 'select-method': 'é¸æ“‡æ–¹å¼ï¼š', 'select-step1': '1. é»æ“Šç¬¬ä¸€å€‹æ™‚æ®µï¼ˆé–‹å§‹æ™‚é–“ï¼‰', 'select-step2': '2. å†é»æ“Šæœ€å¾Œä¸€å€‹æ™‚æ®µï¼ˆçµæŸæ™‚é–“ï¼‰', 'select-step3': '3. ç³»çµ±æœƒè‡ªå‹•é¸å–ä¸­é–“çš„æ‰€æœ‰æ™‚æ®µ', 'success-booking': 'é ç´„ç”³è«‹å·²æˆåŠŸæäº¤ï¼', 'error-booking': 'é ç´„å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚', 'error-select-slot': 'è«‹é¸æ“‡æ—¥æœŸã€æ™‚æ®µåŠäººæ•¸ï¼ˆæœ€å¤š 18 äººï¼‰ã€‚', 'error-cart-empty': 'è«‹å…ˆåŠ å…¥è‡³å°‘ä¸€å€‹é ç´„é …ç›®ã€‚', 'error-capacity': 'è¶…éå¯ç”¨äººæ•¸ï¼Œè«‹é‡æ–°è¼¸å…¥ã€‚', 'error-overlap': 'é¸æ“‡çš„æ™‚æ®µèˆ‡ç¾æœ‰é …ç›®é‡ç–Šï¼Œè«‹é¸æ“‡å…¶ä»–æ™‚é–“ã€‚', 'payment-title': 'ä»˜æ¬¾æ–¹å¼', 'cart-empty': 'å°šæœªé¸æ“‡ä»»ä½•é ç´„é …ç›®ã€‚' },
            en: { 'main-title': 'Professional Studio Booking', 'sub-title': 'Professional Recording Studio â€¢ Open Daily', 'instructions-title': 'Important Booking Instructions', 'date-title': 'Select Date', 'time-title': 'Select Time Slots', 'info-title': 'Contact Information', 'workshop-title': 'Workshops / Classes', 'rental-title': 'Room Rental Options', 'name-label': 'Full Name *', 'email-label': 'Email Address *', 'phone-label': 'Phone Number (WhatsApp) *', 'notes-label': 'Special Requirements (Optional)', 'legend-confirmed': 'Confirmed', 'legend-pending': 'Pending', 'legend-available': 'Available', 'people-label': 'Number of Participants *', 'cart-title': 'Booking Cart', 'summary-items-label': 'Items Selected:', 'summary-people-label': 'Total People:', 'total-label': 'Total Amount:', 'add-session-text': 'Add to Cart', 'submit-btn-text': 'CONFIRM BOOKING REQUEST', 'select-method': 'How to select:', 'select-step1': '1. Click first slot (start time)', 'select-step2': '2. Click last slot (end time)', 'select-step3': '3. System will auto-select all slots in between', 'success-booking': 'Booking request submitted successfully!', 'error-booking': 'Booking failed. Please try again.', 'error-select-slot': 'Select a date, time range, and participants (maximum 18).', 'error-cart-empty': 'Add at least one booking item before submitting.', 'error-capacity': 'Participant count exceeds availability. Please adjust.', 'error-overlap': 'Selected time overlaps with another item. Please choose a different slot.', 'payment-title': 'Payment Methods', 'cart-empty': 'No booking items in the cart yet.' }
        };
        document.addEventListener('DOMContentLoaded', async () => {
            await loadSettings();
            await loadCatalogItems();
            setInitialDateBounds();
            document.getElementById('booking-form').addEventListener('submit', handleBookingSubmit);
            updateUIWithSettings();
            renderCart();
        });
        function setLanguage(lang) {
            currentLanguage = lang;
            document.getElementById('zh-btn').classList.toggle('active', lang === 'zh');
            document.getElementById('en-btn').classList.toggle('active', lang === 'en');
            const strings = translations[lang];
            Object.keys(strings).forEach(key => { const el = document.getElementById(key); if (el) el.textContent = strings[key]; });
            if (lang === 'zh') { document.getElementById('phone').placeholder = 'ä¾‹å¦‚ï¼š98765432'; document.getElementById('notes').placeholder = 'ä»»ä½•ç‰¹æ®Šè¨­å‚™æˆ–è¨­ç½®éœ€æ±‚...'; } else { document.getElementById('phone').placeholder = 'e.g., 98765432'; document.getElementById('notes').placeholder = 'Any special equipment or setup needs...'; }
            updateInstructions();
            renderCatalogLists();
            renderCart();
            updateHeroSubtitle();
        }
        async function loadSettings() {
            try { const response = await fetch(`${API_BASE_URL}/settings`); if (response.ok) { SETTINGS = await response.json(); } } catch (error) { console.error('Error loading settings:', error); }
        }
        async function loadCatalogItems() {
            try { const response = await fetch(`${API_BASE_URL}/items`); if (response.ok) { const data = await response.json(); CATALOG.workshops = Array.isArray(data.workshops) ? data.workshops : []; CATALOG.roomRentals = Array.isArray(data.roomRentals) ? data.roomRentals : []; renderCatalogLists(); } } catch (error) { console.error('Error loading items:', error); }
        }
        function updateUIWithSettings() { updateHeroSubtitle(); updateInstructions(); updatePaymentInfo(); setLanguage(currentLanguage); }
        function updateHeroSubtitle() {
            const zhDescription = SETTINGS.businessDescriptionZh || 'å°ˆæ¥­éŒ„éŸ³å®¤';
            const enDescription = SETTINGS.businessDescription || 'Professional Recording Studio';
            const hours = SETTINGS.operatingHours || {};
            const zhDays = hours.daysLabelZh || 'æ¯æ—¥ç‡Ÿæ¥­';
            const enDays = hours.daysLabelEn || 'Open Daily';
            const start = hours.startTime || '07:00';
            const end = hours.endTime || '22:00';
            const zhSubtitle = `${zhDescription} â€¢ ${zhDays} ${start} - ${end}`;
            const enSubtitle = `${enDescription} â€¢ ${enDays} ${start} - ${end}`;
            document.getElementById('sub-title').textContent = currentLanguage === 'zh' ? zhSubtitle : enSubtitle;
            document.getElementById('main-title').textContent = currentLanguage === 'zh' ? (SETTINGS.businessNameZh || 'å°ˆæ¥­éŒ„éŸ³å®¤é ç´„ç³»çµ±') : (SETTINGS.businessName || 'Professional Studio Booking');
        }
        function updateInstructions() {
            const instructions = SETTINGS.bookingInstructions || {};
            if (currentLanguage === 'zh') {
                document.getElementById('instructions-title').textContent = instructions.titleZh || translations.zh['instructions-title'];
                document.getElementById('instruction-1').textContent = instructions.instruction1Zh || '';
                document.getElementById('instruction-2').textContent = instructions.instruction2Zh || '';
                document.getElementById('instruction-3').textContent = instructions.instruction3Zh || '';
                document.getElementById('instruction-4').textContent = instructions.instruction4Zh || '';
                document.getElementById('instruction-5').textContent = instructions.instruction5Zh || '';
                document.getElementById('instruction-6').textContent = instructions.instruction6Zh || '';
            } else {
                document.getElementById('instructions-title').textContent = instructions.titleEn || translations.en['instructions-title'];
                document.getElementById('instruction-1').textContent = instructions.instruction1En || '';
                document.getElementById('instruction-2').textContent = instructions.instruction2En || '';
                document.getElementById('instruction-3').textContent = instructions.instruction3En || '';
                document.getElementById('instruction-4').textContent = instructions.instruction4En || '';
                document.getElementById('instruction-5').textContent = instructions.instruction5En || '';
                document.getElementById('instruction-6').textContent = instructions.instruction6En || '';
            }
        }
        function updatePaymentInfo() {
            const paymentInfoDiv = document.getElementById('payment-info');
            const paymentMethods = SETTINGS.paymentMethods || {};
            let html = '';
            if (paymentMethods.bankTransfer?.enabled) {
                html += `<div style="margin-bottom:16px;"><h4 style="color:#145da0;">ğŸ¦ ${currentLanguage === 'zh' ? 'éŠ€è¡Œè½‰å¸³' : 'Bank Transfer'}</h4><div>${paymentMethods.bankTransfer.bankName || ''}</div><div style="font-family:'Courier New',monospace;font-weight:600;margin:8px 0;">${paymentMethods.bankTransfer.accountNumber || ''}</div><div style="color:#516273;font-size:0.9em;">${currentLanguage === 'zh' ? 'æˆ¶åï¼š' : 'Account Name: '}${paymentMethods.bankTransfer.accountName || ''}</div></div>`;
            }
            if (paymentMethods.payme?.enabled) {
                html += `<div style="margin-bottom:16px;"><h4 style="color:#145da0;">ğŸ“± PayMe</h4><div style="font-family:'Courier New',monospace;font-weight:600;">${paymentMethods.payme.phoneNumber || ''}</div><div style="color:#516273;font-size:0.9em;">${currentLanguage === 'zh' ? 'è«‹åœ¨ä»˜æ¬¾å‚™è¨»ä¸­åŠ å…¥æ‚¨çš„å§“å' : 'Please include your name in payment reference'}</div></div>`;
            }
            const contactInfo = SETTINGS.contactInfo || {};
            const whatsappLink = contactInfo.whatsapp ? `https://wa.me/${contactInfo.whatsapp.replace(/\D/g,'')}` : '#';
            html += `<div style="background:#fff3cd;padding:14px;border-radius:10px;"><strong style="color:#b07902;">${currentLanguage === 'zh' ? 'ä»˜æ¬¾å¾Œï¼š' : 'After Payment:'}</strong><div style="color:#b07902;margin-top:8px;">${currentLanguage === 'zh' ? 'è«‹å°‡ä»˜æ¬¾æˆªåœ–å‚³é€è‡³ï¼š' : 'Send payment screenshot to:'}<br>ğŸ“± WhatsApp: <a href="${whatsappLink}" target="_blank">${contactInfo.whatsapp || ''}</a><br>âœ‰ï¸ Email: <a href="mailto:${contactInfo.email || ''}">${contactInfo.email || ''}</a></div></div>`;
            paymentInfoDiv.innerHTML = html;
        }
        function setInitialDateBounds() {
            const today = new Date();
            const minHours = Number(SETTINGS.bookingRules?.minAdvanceBooking || 0);
            const minDate = new Date(today.getTime() + minHours * 60 * 60 * 1000);
            document.getElementById('date-input').min = minDate.toISOString().split('T')[0];
            const maxDays = Number(SETTINGS.bookingRules?.maxAdvanceBooking || 30);
            const maxDate = new Date(today);
            maxDate.setDate(maxDate.getDate() + maxDays);
            document.getElementById('date-input').max = maxDate.toISOString().split('T')[0];
        }
        async function handleDateChange(date) {
            if (!date) {
                selectedDate = null;
                selection = { start: null, end: null };
                document.getElementById('time-section').style.display = 'none';
                document.getElementById('add-session-btn').disabled = true;
                return;
            }
            selectedDate = date;
            selection = { start: null, end: null };
            await loadAvailability(date);
            renderTimeSlots();
            document.getElementById('time-section').style.display = 'block';
            updateSelectionSummary();
        }
        async function loadAvailability(date) {
            try {
                const response = await fetch(`${API_BASE_URL}/availability?date=${date}`);
                if (response.ok) { AVAILABILITY = await response.json(); }
            } catch (error) { console.error('Error fetching availability:', error); AVAILABILITY = { confirmedSlots: [], pendingSlots: [] }; }
        }
        function renderTimeSlots() {
            const container = document.getElementById('time-slots');
            container.innerHTML = '';
            if (!selectedDate) {
                container.innerHTML = `<div style="text-align:center;color:#516273;">${currentLanguage === 'zh' ? 'è«‹å…ˆé¸æ“‡æ—¥æœŸã€‚' : 'Select a date first.'}</div>`;
                return;
            }
            const operating = SETTINGS.operatingHours || {};
            const startTime = operating.startTime || '07:00';
            const endTime = operating.endTime || '22:00';
            const interval = Number(SETTINGS.bookingRules?.slotInterval || 30);
            const slots = [];
            let cursor = timeToMinutes(startTime);
            const end = timeToMinutes(endTime);
            while (cursor < end) { slots.push(minutesToTime(cursor)); cursor += interval; }
            slots.forEach((slot, idx) => {
                const el = document.createElement('div');
                el.className = 'time-slot';
                el.dataset.slot = slot;
                el.textContent = slot;
                if (AVAILABILITY.confirmedSlots?.includes(slot)) { el.classList.add('unavailable'); }
                else if (AVAILABILITY.pendingSlots?.includes(slot)) { el.classList.add('pending'); }
                else { el.addEventListener('click', () => handleSlotClick(slot)); }
                if (selection.start === slot || selection.end === slot) { el.classList.add('selected'); }
                else if (selection.start && selection.end) {
                    const slotMin = timeToMinutes(slot);
                    const startMin = timeToMinutes(selection.start);
                    const endMin = timeToMinutes(selection.end);
                    if (slotMin > startMin && slotMin < endMin) el.classList.add('in-range');
                }
                container.appendChild(el);
                if (idx === slots.length - 1) {
                    const endEl = document.createElement('div');
                    endEl.className = 'time-slot';
                    endEl.dataset.slot = endTime;
                    endEl.textContent = endTime;
                    if (AVAILABILITY.confirmedSlots?.includes(endTime)) { endEl.classList.add('unavailable'); }
                    else if (AVAILABILITY.pendingSlots?.includes(endTime)) { endEl.classList.add('pending'); }
                    else { endEl.addEventListener('click', () => handleSlotClick(endTime)); }
                    if (selection.start === endTime || selection.end === endTime) { endEl.classList.add('selected'); }
                    container.appendChild(endEl);
                }
            });
        }
        function handleSlotClick(slot) {
            if (!selection.start) { selection.start = slot; selection.end = null; }
            else if (!selection.end) {
                if (timeToMinutes(slot) <= timeToMinutes(selection.start)) { showMessage('error', translations[currentLanguage]['error-select-slot']); return; }
                selection.end = slot;
            } else { selection = { start: slot, end: null }; }
            renderTimeSlots();
            updateSelectionSummary();
        }
        function updateSelectionSummary() {
            const button = document.getElementById('add-session-btn');
            button.disabled = !(selection.start && selection.end);
        }
        function calculateRoomPrice(duration, peopleCount, periodType) {
            const pricing = SETTINGS.pricing || {};
            const rate = resolveHourlyRate(pricing, peopleCount, periodType);
            return Math.round(rate * (duration / 60) * 100) / 100;
        }
        function resolveHourlyRate(pricing, peopleCount, periodType) {
            if (peopleCount > 18) throw new Error('Maximum capacity per booking item is 18 people');
            if (peopleCount <= 10) return Number(periodType === 'peak' ? pricing.peakUpTo10 : pricing.normalUpTo10 || 0);
            return Number(periodType === 'peak' ? pricing.peakUpTo18 : pricing.normalUpTo18 || 0);
        }
        function determinePeriodType(date, startTime, endTime) {
            const schedule = SETTINGS.pricing?.peakSchedule;
            if (!schedule || !Array.isArray(schedule.days)) return 'normal';
            const dayTokens = schedule.days.map(d => d.toString().toLowerCase());
            const parsedDate = new Date(`${date}T00:00:00`);
            const dayToken = ['sun','mon','tue','wed','thu','fri','sat'][parsedDate.getDay()];
            if (!dayTokens.includes(dayToken)) return 'normal';
            const startMin = timeToMinutes(startTime);
            const endMin = timeToMinutes(endTime);
            const peakStart = timeToMinutes(schedule.startTime || '18:00');
            const peakEnd = timeToMinutes(schedule.endTime || '23:00');
            return startMin < peakEnd && endMin > peakStart ? 'peak' : 'normal';
        }
        function addSelectedSessionToCart() {
            if (!selectedDate || !selection.start || !selection.end) { showMessage('error', translations[currentLanguage]['error-select-slot']); return; }
            const peopleCount = parseInt(document.getElementById('people-count').value, 10);
            if (!Number.isInteger(peopleCount) || peopleCount <= 0 || peopleCount > 18) { showMessage('error', translations[currentLanguage]['error-select-slot']); return; }
            if (hasRoomRentalConflict(selectedDate, selection.start, selection.end)) { showMessage('error', translations[currentLanguage]['error-overlap']); return; }
            const duration = timeToMinutes(selection.end) - timeToMinutes(selection.start);
            const periodType = determinePeriodType(selectedDate, selection.start, selection.end);
            const price = calculateRoomPrice(duration, peopleCount, periodType);
            cartItems.push({ id: `cart-${++itemCounter}`, type: 'room_rental', catalogItemId: null, date: selectedDate, startTime: selection.start, endTime: selection.end, duration, peopleCount, price, periodType, titleZh: `å ´åœ°ç§Ÿç”¨ ${formatDateLabel(selectedDate)} ${selection.start}-${selection.end}`, titleEn: `Room rental ${formatDateLabel(selectedDate)} ${selection.start}-${selection.end}` });
            selection = { start: null, end: null };
            renderTimeSlots();
            renderCart();
            renderCatalogLists();
            document.getElementById('contact-section').style.display = 'block';
            showMessage('success', `${currentLanguage === 'zh' ? 'å·²åŠ å…¥è³¼ç‰©è»Š' : 'Added to cart'}`);
        }
        function renderCart() {
            const cart = document.getElementById('cart');
            cart.innerHTML = '';
            if (cartItems.length === 0) {
                const empty = document.createElement('div');
                empty.style.color = '#516273';
                empty.textContent = translations[currentLanguage]['cart-empty'];
                cart.appendChild(empty);
            } else {
                cartItems.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'cart-item';
                    const title = currentLanguage === 'zh' ? (item.titleZh || item.titleEn) : (item.titleEn || item.titleZh);
                    card.innerHTML = `<div class="cart-item-title">${title}</div><div class="cart-item-meta"><div>${currentLanguage === 'zh' ? 'äººæ•¸ï¼š' : 'Participants:'} ${item.peopleCount}</div><div>${currentLanguage === 'zh' ? 'æ™‚é–“ï¼š' : 'Time:'} ${item.startTime} - ${item.endTime}</div><div>HK$${item.price.toFixed(2)}</div></div>`;
                    const remove = document.createElement('button');
                    remove.className = 'remove-btn';
                    remove.textContent = currentLanguage === 'zh' ? 'åˆªé™¤' : 'Remove';
                    remove.addEventListener('click', () => removeCartItem(item.id));
                    card.appendChild(remove);
                    cart.appendChild(card);
                });
            }
            const totalPeople = cartItems.reduce((sum, item) => sum + item.peopleCount, 0);
            const totalPrice = cartItems.reduce((sum, item) => sum + item.price, 0);
            document.getElementById('summary-items').textContent = cartItems.length;
            document.getElementById('summary-people').textContent = totalPeople;
            document.getElementById('total-amount').textContent = totalPrice.toFixed(2);
            document.getElementById('submit-btn').disabled = cartItems.length === 0;
        }
        function removeCartItem(id) {
            cartItems = cartItems.filter(item => item.id !== id);
            renderCart();
            renderCatalogLists();
            if (cartItems.length === 0) document.getElementById('contact-section').style.display = 'none';
        }
        function renderCatalogLists() {
            renderCatalogList('workshop-list', CATALOG.workshops, 'workshop_class');
            renderCatalogList('rental-list', CATALOG.roomRentals, 'room_rental');
        }
        function renderCatalogList(containerId, items, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            if (!items || items.length === 0) {
                const empty = document.createElement('div');
                empty.style.color = '#516273';
                empty.textContent = currentLanguage === 'zh' ? 'æš«ç„¡è³‡æ–™' : 'No items available at the moment.';
                container.appendChild(empty);
                return;
            }
            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'catalog-card';
                const start = new Date(item.startDateTime);
                const end = new Date(item.endDateTime);
                const dateLabel = formatDateLabel(item.startDateTime.split('T')[0]);
                const timeRange = `${formatTime(start)} - ${formatTime(end)}`;
                const baseCapacity = item.availableCapacity ?? item.capacity;
                const reservedInCart = getCartUsageForCatalogItem(item.id);
                const available = Math.max((baseCapacity ?? 0) - reservedInCart, 0);
                const capacityLabel = currentLanguage === 'zh' ? 'å‰©é¤˜åé¡' : 'Seats left';
                const priceLabel = type === 'workshop_class' ? `${currentLanguage === 'zh' ? 'æ¯ä½ HK$' : 'HK$'}${item.price}` : `${currentLanguage === 'zh' ? 'åƒ¹æ ¼ä¾äººæ•¸èˆ‡æ™‚æ®µè¨ˆç®—' : 'Pricing based on group & period'}`;
                card.innerHTML = `<h3>${item.name}</h3><div class="catalog-meta"><div>${dateLabel}</div><div>${timeRange}</div><div>${priceLabel}</div><div class="capacity-indicator">${capacityLabel}: ${available}</div>${item.instructorName ? `<div>${currentLanguage === 'zh' ? 'å°å¸«ï¼š' : 'Instructor:'} ${item.instructorName}</div>` : ''}</div>`;
                const actions = document.createElement('div');
                actions.className = 'catalog-actions';
                const input = document.createElement('input');
                input.type = 'number';
                input.min = '1';
                input.max = Math.min(18, available);
                input.value = Math.min(Math.max(available, 0), 4) || 1;
                input.disabled = available <= 0;
                const button = document.createElement('button');
                button.textContent = currentLanguage === 'zh' ? 'åŠ å…¥è³¼ç‰©è»Š' : 'Add to cart';
                button.disabled = available <= 0;
                button.addEventListener('click', () => addCatalogItemToCart(item, type, parseInt(input.value, 10)));
                actions.appendChild(input);
                actions.appendChild(button);
                card.appendChild(actions);
                container.appendChild(card);
            });
        }
        function addCatalogItemToCart(item, type, peopleCount) {
            if (!Number.isInteger(peopleCount) || peopleCount <= 0 || peopleCount > 18) { showMessage('error', translations[currentLanguage]['error-capacity']); return; }
            const baseCapacity = item.availableCapacity ?? item.capacity;
            const reservedInCart = getCartUsageForCatalogItem(item.id);
            const remainingCapacity = Math.max((baseCapacity ?? 0) - reservedInCart, 0);
            if (peopleCount > remainingCapacity) { showMessage('error', translations[currentLanguage]['error-capacity']); return; }
            const startInfo = parseIsoDate(item.startDateTime);
            const endInfo = parseIsoDate(item.endDateTime);
            const duration = timeToMinutes(endInfo.time) - timeToMinutes(startInfo.time);
            const periodType = type === 'room_rental' ? determinePeriodType(startInfo.date, startInfo.time, endInfo.time) : 'catalog';
            if (type === 'room_rental' && hasRoomRentalConflict(startInfo.date, startInfo.time, endInfo.time)) { showMessage('error', translations[currentLanguage]['error-overlap']); return; }
            const price = type === 'room_rental' ? calculateRoomPrice(duration, peopleCount, periodType) : Math.round(Number(item.price || 0) * peopleCount * 100) / 100;
            cartItems.push({ id: `catalog-${++itemCounter}`, type, catalogItemId: item.id, date: startInfo.date, startTime: startInfo.time, endTime: endInfo.time, duration, peopleCount, price, periodType, titleZh: `${item.name}ï½œ${formatDateLabel(startInfo.date)} ${startInfo.time}-${endInfo.time}`, titleEn: `${item.name} | ${formatDateLabel(startInfo.date)} ${startInfo.time}-${endInfo.time}` });
            renderCart();
            renderCatalogLists();
            document.getElementById('contact-section').style.display = 'block';
            showMessage('success', `${item.name} ${currentLanguage === 'zh' ? 'å·²åŠ å…¥è³¼ç‰©è»Š' : 'added to cart'}`);
        }
        function parseIsoDate(isoString) { const date = new Date(isoString); const year = date.getFullYear(); const month = `${date.getMonth() + 1}`.padStart(2,'0'); const day = `${date.getDate()}`.padStart(2,'0'); const hour = `${date.getHours()}`.padStart(2,'0'); const minute = `${date.getMinutes()}`.padStart(2,'0'); return { date: `${year}-${month}-${day}`, time: `${hour}:${minute}` }; }
        function timeToMinutes(time) { const [hour, minute] = time.split(':').map(Number); return hour * 60 + minute; }
        function minutesToTime(minutes) { const h = Math.floor(minutes / 60); const m = minutes % 60; return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`; }
        function minutesToTimeString(minutes) { return minutesToTime(minutes); }
        function minutesBetween(start, end) { return timeToMinutes(end) - timeToMinutes(start); }
        function formatDateLabel(dateString) { const date = new Date(`${dateString}T00:00:00`); if (currentLanguage === 'zh') { const weekdays = ['é€±æ—¥','é€±ä¸€','é€±äºŒ','é€±ä¸‰','é€±å››','é€±äº”','é€±å…­']; return `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥ (${weekdays[date.getDay()]})`; } const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }; return date.toLocaleDateString('en-US', options); }
        function formatTime(dateObj) { const hours = dateObj.getHours(); const minutes = `${dateObj.getMinutes()}`.padStart(2,'0'); if (currentLanguage === 'zh') { const period = hours >= 12 ? 'ä¸‹åˆ' : 'ä¸Šåˆ'; const displayHour = hours % 12 === 0 ? 12 : hours % 12; return `${period} ${displayHour}:${minutes}`; } const period = hours >= 12 ? 'PM' : 'AM'; const displayHour = hours % 12 === 0 ? 12 : hours % 12; return `${displayHour}:${minutes} ${period}`; }
        async function handleBookingSubmit(e) {
            e.preventDefault();
            if (cartItems.length === 0) { showMessage('error', translations[currentLanguage]['error-cart-empty']); return; }
            const customerName = document.getElementById('customerName').value.trim();
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const notes = document.getElementById('notes').value.trim();
            const payload = {
                customerName,
                email,
                phone,
                notes,
                bookingItems: cartItems.map(item => ({ catalogItemId: item.catalogItemId, type: item.type, date: item.date, startTime: item.startTime, endTime: item.endTime, peopleCount: item.peopleCount }))
            };
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = currentLanguage === 'zh' ? 'è™•ç†ä¸­...' : 'Processing...';
            try {
                const response = await fetch(`${API_BASE_URL}/bookings`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const result = await response.json();
                if (response.ok) {
                    showMessage('success', translations[currentLanguage]['success-booking']);
                    openWhatsappConfirmation(result.booking || {}, customerName);
                    cartItems = [];
                    renderCart();
                    renderCatalogLists();
                    document.getElementById('booking-form').reset();
                    document.getElementById('contact-section').style.display = 'none';
                    selectedDate = null;
                    selection = { start: null, end: null };
                    document.getElementById('date-input').value = '';
                    document.getElementById('time-section').style.display = 'none';
                } else {
                    showMessage('error', result.error || translations[currentLanguage]['error-booking']);
                }
            } catch (error) {
                console.error('Booking error:', error);
                showMessage('error', translations[currentLanguage]['error-booking']);
            } finally {
                submitBtn.disabled = cartItems.length === 0;
                submitBtn.textContent = translations[currentLanguage]['submit-btn-text'];
            }
        }
        function openWhatsappConfirmation(booking, name) {
            const total = booking.totalPrice || cartItems.reduce((sum, item) => sum + item.price, 0);
            const whatsappNumber = SETTINGS.contactInfo?.whatsapp?.replace(/\D/g,'') || '85298725268';
            const firstItem = booking.items?.[0];
            const dateLabel = firstItem ? formatDateLabel(firstItem.date) : '';
            const timeLabel = firstItem ? `${firstItem.startTime} - ${firstItem.endTime}` : '';
            const message = currentLanguage === 'zh' ? `æ‚¨å¥½ï¼Œæˆ‘å‰›å®Œæˆé ç´„ç”³è«‹ï¼š
å§“åï¼š${name}
æ—¥æœŸï¼š${dateLabel}
æ™‚æ®µï¼š${timeLabel}
ç¸½é‡‘é¡ï¼šHK$${total}` : `Hi, I've just made a booking request:
Name: ${name}
Date: ${dateLabel}
Time: ${timeLabel}
Total: HK$${total}`;
            window.open(`https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`, '_blank');
        }
        function showMessage(type, message) {
            const target = type === 'success' ? document.getElementById('success-message') : document.getElementById('error-message');
            const other = type === 'success' ? document.getElementById('error-message') : document.getElementById('success-message');
            other.style.display = 'none';
            other.textContent = '';
            if (!message) return;
            target.textContent = Array.isArray(message) ? message.filter(Boolean).join('
') : message;
            target.style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
            setTimeout(() => { target.style.display = 'none'; }, 8000);
        }
        function renderCatalogLists() { renderCatalogList('workshop-list', CATALOG.workshops, 'workshop_class'); renderCatalogList('rental-list', CATALOG.roomRentals, 'room_rental'); }
        function minutesBetweenSelection(start, end) { return timeToMinutes(end) - timeToMinutes(start); }
        setLanguage('zh');
    </script>
</body>
</html>
